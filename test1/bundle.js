/*! For license information please see bundle.js.LICENSE.txt */
(()=>{var __webpack_modules__={418:(t,e,n)=>{e.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;e.splice(1,0,n,"color: inherit");let r=0,i=0;e[0].replace(/%[a-zA-Z%]/g,(t=>{"%%"!==t&&(r++,"%c"===t&&(i=r))})),e.splice(i,0,n)},e.save=function(t){try{t?e.storage.setItem("debug",t):e.storage.removeItem("debug")}catch(t){}},e.load=function(){let t;try{t=e.storage.getItem("debug")}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t=process.env.DEBUG),t},e.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let t;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(t=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(t[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage=function(){try{return localStorage}catch(t){}}(),e.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=n(349)(e);const{formatters:r}=t.exports;r.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}},349:(t,e,n)=>{t.exports=function(t){function e(t){let n,i,s,o=null;function a(...t){if(!a.enabled)return;const r=a,i=Number(new Date),s=i-(n||i);r.diff=s,r.prev=n,r.curr=i,n=i,t[0]=e.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let o=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,((n,i)=>{if("%%"===n)return"%";o++;const s=e.formatters[i];if("function"==typeof s){const e=t[o];n=s.call(r,e),t.splice(o,1),o--}return n})),e.formatArgs.call(r,t),(r.log||e.log).apply(r,t)}return a.namespace=t,a.useColors=e.useColors(),a.color=e.selectColor(t),a.extend=r,a.destroy=e.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==e.namespaces&&(i=e.namespaces,s=e.enabled(t)),s),set:t=>{o=t}}),"function"==typeof e.init&&e.init(a),a}function r(t,n){const r=e(this.namespace+(void 0===n?":":n)+t);return r.log=this.log,r}function i(t,e){let n=0,r=0,i=-1,s=0;for(;n<t.length;)if(r<e.length&&(e[r]===t[n]||"*"===e[r]))"*"===e[r]?(i=r,s=n,r++):(n++,r++);else{if(-1===i)return!1;r=i+1,s++,n=s}for(;r<e.length&&"*"===e[r];)r++;return r===e.length}return e.debug=e,e.default=e,e.coerce=function(t){return t instanceof Error?t.stack||t.message:t},e.disable=function(){const t=[...e.names,...e.skips.map((t=>"-"+t))].join(",");return e.enable(""),t},e.enable=function(t){e.save(t),e.namespaces=t,e.names=[],e.skips=[];const n=("string"==typeof t?t:"").trim().replace(" ",",").split(",").filter(Boolean);for(const t of n)"-"===t[0]?e.skips.push(t.slice(1)):e.names.push(t)},e.enabled=function(t){for(const n of e.skips)if(i(t,n))return!1;for(const n of e.names)if(i(t,n))return!0;return!1},e.humanize=n(628),e.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach((n=>{e[n]=t[n]})),e.names=[],e.skips=[],e.formatters={},e.selectColor=function(t){let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n|=0;return e.colors[Math.abs(n)%e.colors.length]},e.enable(e.load()),e}},628:t=>{var e=1e3,n=60*e,r=60*n,i=24*r,s=7*i;function o(t,e,n,r){var i=e>=1.5*n;return Math.round(t/n)+" "+r+(i?"s":"")}t.exports=function(t,a){a=a||{};var c,h,l=typeof t;if("string"===l&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(o){var a=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*a;case"weeks":case"week":case"w":return a*s;case"days":case"day":case"d":return a*i;case"hours":case"hour":case"hrs":case"hr":case"h":return a*r;case"minutes":case"minute":case"mins":case"min":case"m":return a*n;case"seconds":case"second":case"secs":case"sec":case"s":return a*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return a;default:return}}}}(t);if("number"===l&&isFinite(t))return a.long?(c=t,(h=Math.abs(c))>=i?o(c,h,i,"day"):h>=r?o(c,h,r,"hour"):h>=n?o(c,h,n,"minute"):h>=e?o(c,h,e,"second"):c+" ms"):function(t){var s=Math.abs(t);return s>=i?Math.round(t/i)+"d":s>=r?Math.round(t/r)+"h":s>=n?Math.round(t/n)+"m":s>=e?Math.round(t/e)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},705:(t,e,n)=>{const{bech32:r,hex:i,utf8:s}=n(746),o={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},a={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},c={bech32:"tbs",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},h={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},l={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},u=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],d={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},f=BigInt("2100000000000000000"),p=BigInt(1e11),g={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},y={};for(let t=0,e=Object.keys(g);t<e.length;t++){const n=e[t],r=g[e[t]].toString();y[r]=n}const w={1:t=>i.encode(r.fromWordsUnsafe(t)),16:t=>i.encode(r.fromWordsUnsafe(t)),13:t=>s.encode(r.fromWordsUnsafe(t)),19:t=>i.encode(r.fromWordsUnsafe(t)),23:t=>i.encode(r.fromWordsUnsafe(t)),27:t=>i.encode(r.fromWordsUnsafe(t)),6:b,24:b,3:function(t){const e=[];let n,s,o,a,c,h=r.fromWordsUnsafe(t);for(;h.length>0;)n=i.encode(h.slice(0,33)),s=i.encode(h.slice(33,41)),o=parseInt(i.encode(h.slice(41,45)),16),a=parseInt(i.encode(h.slice(45,49)),16),c=parseInt(i.encode(h.slice(49,51)),16),h=h.slice(51),e.push({pubkey:n,short_channel_id:s,fee_base_msat:o,fee_proportional_millionths:a,cltv_expiry_delta:c});return e},5:function(t){const e=t.slice().reverse().map((t=>[!!(1&t),!!(2&t),!!(4&t),!!(8&t),!!(16&t)])).reduce(((t,e)=>t.concat(e)),[]);for(;e.length<2*u.length;)e.push(!1);const n={};u.forEach(((t,r)=>{let i;i=e[2*r]?"required":e[2*r+1]?"supported":"unsupported",n[t]=i}));const r=e.slice(2*u.length);return n.extra_bits={start_bit:2*u.length,bits:r,has_required:r.reduce(((t,e,n)=>n%2!=0?t||!1:t||e),!1)},n}};function m(t){return e=>({tagCode:parseInt(t),words:r.encode("unknown",e,Number.MAX_SAFE_INTEGER)})}function b(t){return t.reverse().reduce(((t,e,n)=>t+e*Math.pow(32,n)),0)}function v(t,e){let n,r;if(t.slice(-1).match(/^[munp]$/))n=t.slice(-1),r=t.slice(0,-1);else{if(t.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");r=t}if(!r.match(/^\d+$/))throw new Error("Not a valid human readable amount");const i=BigInt(r),s=n?i*p/d[n]:i*p;if("p"===n&&i%BigInt(10)!==BigInt(0)||s>f)throw new Error("Amount is outside of valid range");return e?s.toString():s}t.exports={decode:function(t,e){if("string"!=typeof t)throw new Error("Lightning Payment Request must be string");if("ln"!==t.slice(0,2).toLowerCase())throw new Error("Not a proper lightning payment request");const n=[],s=r.decode(t,Number.MAX_SAFE_INTEGER);t=t.toLowerCase();const u=s.prefix;let d=s.words,f=t.slice(u.length+1),p=d.slice(-104);d=d.slice(0,-104);let _=u.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(_&&!_[2]&&(_=u.match(/^ln(\S+)$/)),!_)throw new Error("Not a proper lightning payment request");n.push({name:"lightning_network",letters:"ln"});const E=_[1];let k;if(e){if(void 0===e.bech32||void 0===e.pubKeyHash||void 0===e.scriptHash||!Array.isArray(e.validWitnessVersions))throw new Error("Invalid network");k=e}else switch(E){case o.bech32:k=o;break;case a.bech32:k=a;break;case c.bech32:k=c;break;case h.bech32:k=h;break;case l.bech32:k=l}if(!k||k.bech32!==E)throw new Error("Unknown coin bech32 prefix");n.push({name:"coin_network",letters:E,value:k});const A=_[2];let x;A?(x=v(A+_[3],!0),n.push({name:"amount",letters:_[2]+_[3],value:x})):x=null,n.push({name:"separator",letters:"1"});const R=b(d.slice(0,7));let S,C,T,I;for(d=d.slice(7),n.push({name:"timestamp",letters:f.slice(0,7),value:R}),f=f.slice(7);d.length>0;){const t=d[0].toString();S=y[t]||"unknown_tag",C=w[t]||m(t),d=d.slice(1),T=b(d.slice(0,2)),d=d.slice(2),I=d.slice(0,T),d=d.slice(T),n.push({name:S,tag:f[0],letters:f.slice(0,3+T),value:C(I)}),f=f.slice(3+T)}n.push({name:"signature",letters:f.slice(0,104),value:i.encode(r.fromWordsUnsafe(p))}),f=f.slice(104),n.push({name:"checksum",letters:f});let U={paymentRequest:t,sections:n,get expiry(){let t=n.find((t=>"expiry"===t.name));if(t)return N("timestamp")+t.value},get route_hints(){return n.filter((t=>"route_hint"===t.name)).map((t=>t.value))}};for(let t in g)"route_hint"!==t&&Object.defineProperty(U,t,{get:()=>N(t)});return U;function N(t){let e=n.find((e=>e.name===t));return e?e.value:void 0}},hrpToMillisat:v}},746:(t,e)=>{"use strict";function n(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function r(...t){const e=(t,e)=>n=>t(e(n));return{encode:Array.from(t).reverse().reduce(((t,n)=>t?e(t,n.encode):n.encode),void 0),decode:t.reduce(((t,n)=>t?e(t,n.decode):n.decode),void 0)}}function i(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&"number"!=typeof e[0])throw new Error("alphabet.encode input should be an array of numbers");return e.map((e=>{if(n(e),e<0||e>=t.length)throw new Error(`Digit index outside alphabet: ${e} (alphabet: ${t.length})`);return t[e]}))},decode:e=>{if(!Array.isArray(e)||e.length&&"string"!=typeof e[0])throw new Error("alphabet.decode input should be array of strings");return e.map((e=>{if("string"!=typeof e)throw new Error(`alphabet.decode: not string element=${e}`);const n=t.indexOf(e);if(-1===n)throw new Error(`Unknown letter: "${e}". Allowed: ${t}`);return n}))}}}function s(t=""){if("string"!=typeof t)throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&"string"!=typeof e[0])throw new Error("join.encode input should be array of strings");for(let t of e)if("string"!=typeof t)throw new Error(`join.encode: non-string input=${t}`);return e.join(t)},decode:e=>{if("string"!=typeof e)throw new Error("join.decode input should be string");return e.split(t)}}}function o(t,e="="){if(n(t),"string"!=typeof e)throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&"string"!=typeof n[0])throw new Error("padding.encode input should be array of strings");for(let t of n)if("string"!=typeof t)throw new Error(`padding.encode: non-string input=${t}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&"string"!=typeof n[0])throw new Error("padding.encode input should be array of strings");for(let t of n)if("string"!=typeof t)throw new Error(`padding.decode: non-string input=${t}`);let r=n.length;if(r*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if(!((r-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function a(t){if("function"!=typeof t)throw new Error("normalize fn should be function");return{encode:t=>t,decode:e=>t(e)}}function c(t,e,r){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(r<2)throw new Error(`convertRadix: wrong to=${r}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let i=0;const s=[],o=Array.from(t);for(o.forEach((t=>{if(n(t),t<0||t>=e)throw new Error(`Wrong integer: ${t}`)}));;){let t=0,n=!0;for(let s=i;s<o.length;s++){const a=o[s],c=e*t+a;if(!Number.isSafeInteger(c)||e*t/e!==t||c-a!=e*t)throw new Error("convertRadix: carry overflow");if(t=c%r,o[s]=Math.floor(c/r),!Number.isSafeInteger(o[s])||o[s]*r+t!==c)throw new Error("convertRadix: carry overflow");n&&(o[s]?n=!1:i=s)}if(s.push(t),n)break}for(let e=0;e<t.length-1&&0===t[e];e++)s.push(0);return s.reverse()}Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0,e.assertNumber=n;const h=(t,e)=>e?h(e,t%e):t,l=(t,e)=>t+(e-h(t,e));function u(t,e,r,i){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(r<=0||r>32)throw new Error(`convertRadix2: wrong to=${r}`);if(l(e,r)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${r} carryBits=${l(e,r)}`);let s=0,o=0;const a=2**r-1,c=[];for(const i of t){if(n(i),i>=2**e)throw new Error(`convertRadix2: invalid data word=${i} from=${e}`);if(s=s<<e|i,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=r;o-=r)c.push((s>>o-r&a)>>>0);s&=2**o-1}if(s=s<<r-o&a,!i&&o>=e)throw new Error("Excess padding");if(!i&&s)throw new Error(`Non-zero padding: ${s}`);return i&&o>0&&c.push(s>>>0),c}function d(t){return n(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return c(Array.from(e),256,t)},decode:e=>{if(!Array.isArray(e)||e.length&&"number"!=typeof e[0])throw new Error("radix.decode input should be array of strings");return Uint8Array.from(c(e,t,256))}}}function f(t,e=!1){if(n(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(l(8,t)>32||l(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return u(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&"number"!=typeof n[0])throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(u(n,t,8,e))}}}function p(t){if("function"!=typeof t)throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch(t){}}}function g(t,e){if(n(t),"function"!=typeof e)throw new Error("checksum fn should be function");return{encode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const r=e(n).slice(0,t),i=new Uint8Array(n.length+t);return i.set(n),i.set(r,n.length),i},decode(n){if(!(n instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const r=n.slice(0,-t),i=e(r).slice(0,t),s=n.slice(-t);for(let e=0;e<t;e++)if(i[e]!==s[e])throw new Error("Invalid checksum");return r}}}e.utils={alphabet:i,chain:r,checksum:g,radix:d,radix2:f,join:s,padding:o},e.base16=r(f(4),i("0123456789ABCDEF"),s("")),e.base32=r(f(5),i("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),o(5),s("")),e.base32hex=r(f(5),i("0123456789ABCDEFGHIJKLMNOPQRSTUV"),o(5),s("")),e.base32crockford=r(f(5),i("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),a((t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")))),e.base64=r(f(6),i("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),o(6),s("")),e.base64url=r(f(6),i("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),o(6),s(""));const y=t=>r(d(58),i(t),s(""));e.base58=y("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=y("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=y("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const w=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(t){let n="";for(let r=0;r<t.length;r+=8){const i=t.subarray(r,r+8);n+=e.base58.encode(i).padStart(w[i.length],"1")}return n},decode(t){let n=[];for(let r=0;r<t.length;r+=11){const i=t.slice(r,r+11),s=w.indexOf(i.length),o=e.base58.decode(i);for(let t=0;t<o.length-s;t++)if(0!==o[t])throw new Error("base58xmr: wrong padding");n=n.concat(Array.from(o.slice(o.length-s)))}return Uint8Array.from(n)}},e.base58check=t=>r(g(4,(e=>t(t(e)))),e.base58);const m=r(i("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),b=[996825010,642813549,513874426,1027748829,705979059];function v(t){const e=t>>25;let n=(33554431&t)<<5;for(let t=0;t<b.length;t++)1==(e>>t&1)&&(n^=b[t]);return n}function _(t,e,n=1){const r=t.length;let i=1;for(let e=0;e<r;e++){const n=t.charCodeAt(e);if(n<33||n>126)throw new Error(`Invalid prefix (${t})`);i=v(i)^n>>5}i=v(i);for(let e=0;e<r;e++)i=v(i)^31&t.charCodeAt(e);for(let t of e)i=v(i)^t;for(let t=0;t<6;t++)i=v(i);return i^=n,m.encode(u([i%2**30],30,5,!1))}function E(t){const e="bech32"===t?1:734539939,n=f(5),r=n.decode,i=n.encode,s=p(r);function o(t,n=90){if("string"!=typeof t)throw new Error("bech32.decode input should be string, not "+typeof t);if(t.length<8||!1!==n&&t.length>n)throw new TypeError(`Wrong string length: ${t.length} (${t}). Expected (8..${n})`);const r=t.toLowerCase();if(t!==r&&t!==t.toUpperCase())throw new Error("String must be lowercase or uppercase");const i=(t=r).lastIndexOf("1");if(0===i||-1===i)throw new Error('Letter "1" must be present between prefix and data only');const s=t.slice(0,i),o=t.slice(i+1);if(o.length<6)throw new Error("Data must be at least 6 characters long");const a=m.decode(o).slice(0,-6),c=_(s,a,e);if(!o.endsWith(c))throw new Error(`Invalid checksum in ${t}: expected "${c}"`);return{prefix:s,words:a}}return{encode:function(t,n,r=90){if("string"!=typeof t)throw new Error("bech32.encode prefix should be string, not "+typeof t);if(!Array.isArray(n)||n.length&&"number"!=typeof n[0])throw new Error("bech32.encode words should be array of numbers, not "+typeof n);const i=t.length+7+n.length;if(!1!==r&&i>r)throw new TypeError(`Length ${i} exceeds limit ${r}`);return`${t=t.toLowerCase()}1${m.encode(n)}${_(t,n,e)}`},decode:o,decodeToBytes:function(t){const{prefix:e,words:n}=o(t,!1);return{prefix:e,words:n,bytes:r(n)}},decodeUnsafe:p(o),fromWords:r,fromWordsUnsafe:s,toWords:i}}e.bech32=E("bech32"),e.bech32m=E("bech32m"),e.utf8={encode:t=>(new TextDecoder).decode(t),decode:t=>(new TextEncoder).encode(t)},e.hex=r(f(4),i("0123456789abcdef"),s(""),a((t=>{if("string"!=typeof t||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})));const k={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},A=`Invalid encoding type. Available types: ${Object.keys(k).join(", ")}`;e.bytesToString=(t,e)=>{if("string"!=typeof t||!k.hasOwnProperty(t))throw new TypeError(A);if(!(e instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return k[t].encode(e)},e.str=e.bytesToString,e.stringToBytes=(t,e)=>{if(!k.hasOwnProperty(t))throw new TypeError(A);if("string"!=typeof e)throw new TypeError("stringToBytes() expects string");return k[t].decode(e)},e.bytes=e.stringToBytes},30:function(t,e,n){"use strict";var r=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(e,"__esModule",{value:!0}),e.EventEmitter=void 0;var i=n(857),s=n(372),o=n(547);function a(t,e,n,r,i,s){var o=this.events[t];if(o){if(0===o.length)return!1;if(o.argsNum<6)o.call(e,n,r,i,s);else{for(var a=new Array(o.argsNum),c=0,h=a.length;c<h;++c)a[c]=arguments[c+1];o.call.apply(void 0,a)}return!0}return!1}function c(t,e,n,r,i,s){var o,a=this.events[t];if(void 0!==a){if(0===a.length)return!1;if(a.argsNum<6)a.call(e,n,r,i,s);else{for(var c=0,h=(o=new Array(a.argsNum)).length;c<h;++c)o[c]=arguments[c+1];a.call.apply(void 0,o)}}var l=this.onceEvents[t];if(l){if("function"==typeof l)if(this.onceEvents[t]=void 0,arguments.length<6)l(e,n,r,i,s);else{if(void 0===o)for(c=0,h=(o=new Array(arguments.length-1)).length;c<h;++c)o[c]=arguments[c+1];l.apply(void 0,o)}else{var u=l;if(this.onceEvents[t]=void 0,arguments.length<6)for(c=0;c<u.length;++c)u[c](e,n,r,i,s);else{if(void 0===o)for(c=0,h=(o=new Array(arguments.length-1)).length;c<h;++c)o[c]=arguments[c+1];for(c=0;c<u.length;++c)u[c].apply(void 0,o)}}return!0}return void 0!==a}var h=function(){function t(){this.events=(0,o.nullObj)(),this.onceEvents=(0,o.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();function l(t,e,n){if(void 0===n&&(n=e.length),"function"!=typeof e)throw new TypeError("The listener must be a function");var r=this.events[t];return r?(r.push(e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new i.TaskCollection(n,!0,e,!1),"symbol"==typeof t&&this._symbolKeys.add(t)),this}function u(t,e){var n=this.events[t];n&&n.removeLast(e);var r=this.onceEvents[t];return r&&("function"==typeof r?this.onceEvents[t]=void 0:"object"==typeof r&&(1===r.length&&r[0]===e?this.onceEvents[t]=void 0:(0,s._fast_remove_single)(r,r.lastIndexOf(e)))),this}e.EventEmitter=h,h.prototype.emit=a,h.prototype.on=l,h.prototype.once=function(t,e){switch(this.emit===a&&(this.emit=c),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,"symbol"==typeof t&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this},h.prototype.addListener=l,h.prototype.removeListener=u,h.prototype.addListenerBound=function(t,e,n,r){void 0===n&&(n=this),void 0===r&&(r=e.length),this.boundFuncs||(this.boundFuncs=new Map);var i=e.bind(n);return this.boundFuncs.set(e,i),this.addListener(t,i,r)},h.prototype.removeListenerBound=function(t,e){var n,r,i=null===(n=this.boundFuncs)||void 0===n?void 0:n.get(e);return null===(r=this.boundFuncs)||void 0===r||r.delete(e),this.removeListener(t,i)},h.prototype.hasListeners=function(t){return this.events[t]&&!!this.events[t].length},h.prototype.prependListener=function(t,e,n){if(void 0===n&&(n=e.length),"function"!=typeof e)throw new TypeError("The listener must be a function");var r=this.events[t];return r&&r instanceof i.TaskCollection?(r.insert(0,e),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(r=this.events[t]=new i.TaskCollection(n,!0,e,!1),"symbol"==typeof t&&this._symbolKeys.add(t)),this},h.prototype.prependOnceListener=function(t,e){this.emit===a&&(this.emit=c);var n=this.onceEvents[t];return n?"object"!=typeof n?(this.onceEvents[t]=[e,n],"symbol"==typeof t&&this._symbolKeys.add(t)):(n.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],"symbol"==typeof t&&this._symbolKeys.add(t)),this},h.prototype.off=u,h.prototype.removeAllListeners=function(t){return void 0===t?(this.events=(0,o.nullObj)(),this.onceEvents=(0,o.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,"symbol"==typeof t&&this._symbolKeys.delete(t)),this},h.prototype.setMaxListeners=function(t){return this.maxListeners=t,this},h.prototype.getMaxListeners=function(){return this.maxListeners},h.prototype.listeners=function(t){return this.emit===a?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?r(r([],this.events[t].tasksAsArray(),!0),"function"==typeof this.onceEvents[t]?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?"function"==typeof this.onceEvents[t]?[this.onceEvents[t]]:this.onceEvents[t]:[]},h.prototype.eventNames=function(){var t=this;if(this.emit===a){var e=Object.keys(this.events);return r(r([],e,!0),Array.from(this._symbolKeys),!0).filter((function(e){return e in t.events&&t.events[e]&&t.events[e].length}))}e=Object.keys(this.events).filter((function(e){return t.events[e]&&t.events[e].length}));var n=Object.keys(this.onceEvents).filter((function(e){return t.onceEvents[e]&&t.onceEvents[e].length}));return r(r(r([],e,!0),n,!0),Array.from(this._symbolKeys).filter((function(e){return e in t.events&&t.events[e]&&t.events[e].length||e in t.onceEvents&&t.onceEvents[e]&&t.onceEvents[e].length})),!0)},h.prototype.listenerCount=function(t){return this.emit===a?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}},706:function(t,e,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(e,n);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,r,i)}:function(t,e,n,r){void 0===r&&(r=n),t[r]=e[n]}),i=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||r(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(n(335),e),i(n(30),e)},665:(__unused_webpack_module,exports)=>{"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.bakeCollectionVariadic=exports.bakeCollectionAwait=exports.bakeCollection=exports.BAKED_EMPTY_FUNC=void 0,exports.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(0===t)return e;for(var n=0;n<t-1;++n)e+="arg"+String(n)+", ";return e+"arg"+String(t-1)}function generateBodyPartsCode(t,e){for(var n="",r="",i=0;i<e;++i)n+="var f".concat(i," = collection[").concat(i,"];\n"),r+="f".concat(i,"(").concat(t,")\n");return{funcDefCode:n,funcCallCode:r}}function generateBodyPartsVariadicCode(t){for(var e="",n="",r=0;r<t;++r)e+="var f".concat(r," = collection[").concat(r,"];\n"),n+="f".concat(r,".apply(undefined, arguments)\n");return{funcDefCode:e,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(0===collection.length)return exports.BAKED_EMPTY_FUNC;if(1===collection.length)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode="(function(collection) {\n            ".concat(funcDefCode,"\n            collection = undefined;\n            return (function(").concat(argsDefCode,") {\n                ").concat(funcCallCode,"\n            });\n        })")}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=collection.length%10==0?"(function(collection) {\n                return (function(".concat(argsDefCode,") {\n                    for (var i = 0; i < collection.length; i += 10) {\n                        collection[i](").concat(argsDefCode,");\n                        collection[i+1](").concat(argsDefCode,");\n                        collection[i+2](").concat(argsDefCode,");\n                        collection[i+3](").concat(argsDefCode,");\n                        collection[i+4](").concat(argsDefCode,");\n                        collection[i+5](").concat(argsDefCode,");\n                        collection[i+6](").concat(argsDefCode,");\n                        collection[i+7](").concat(argsDefCode,");\n                        collection[i+8](").concat(argsDefCode,");\n                        collection[i+9](").concat(argsDefCode,");\n                    }\n                });\n            })"):collection.length%4==0?"(function(collection) {\n                return (function(".concat(argsDefCode,") {\n                    for (var i = 0; i < collection.length; i += 4) {\n                        collection[i](").concat(argsDefCode,");\n                        collection[i+1](").concat(argsDefCode,");\n                        collection[i+2](").concat(argsDefCode,");\n                        collection[i+3](").concat(argsDefCode,");\n                    }\n                });\n            })"):collection.length%3==0?"(function(collection) {\n                return (function(".concat(argsDefCode,") {\n                    for (var i = 0; i < collection.length; i += 3) {\n                        collection[i](").concat(argsDefCode,");\n                        collection[i+1](").concat(argsDefCode,");\n                        collection[i+2](").concat(argsDefCode,");\n                    }\n                });\n            })"):"(function(collection) {\n                return (function(".concat(argsDefCode,") {\n                    for (var i = 0; i < collection.length; ++i) {\n                        collection[i](").concat(argsDefCode,");\n                    }\n                });\n            })")}var bakeCollection_1=void 0,fixedArgsNum_1=void 0,bakeCollectionVariadic_1=void 0,bakeCollectionAwait_1=void 0,funcFactory=eval(funcFactoryCode);return funcFactory(collection)}function bakeCollectionAwait(collection,fixedArgsNum){if(0===collection.length)return exports.BAKED_EMPTY_FUNC;if(1===collection.length)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode="(function(collection) {\n            ".concat(funcDefCode,"\n            collection = undefined;\n            return (function(").concat(argsDefCode,") {\n                return Promise.all([ ").concat(funcCallCode," ]);\n            });\n        })")}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode="(function(collection) {\n            return (function(".concat(argsDefCode,") {\n                var promises = Array(collection.length);\n                for (var i = 0; i < collection.length; ++i) {\n                    promises[i] = collection[i](").concat(argsDefCode,");\n                }\n                return Promise.all(promises);\n            });\n        })")}var bakeCollection_2=void 0,fixedArgsNum_2=void 0,bakeCollectionVariadic_2=void 0,bakeCollectionAwait_2=void 0,funcFactory=eval(funcFactoryCode);return funcFactory(collection)}function bakeCollectionVariadic(collection){if(0===collection.length)return exports.BAKED_EMPTY_FUNC;if(1===collection.length)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode="(function(collection) {\n            ".concat(funcDefCode,"\n            collection = undefined;\n            return (function() {\n                ").concat(funcCallCode,"\n            });\n        })")}else funcFactoryCode="(function(collection) {\n            return (function() {\n                for (var i = 0; i < collection.length; ++i) {\n                    collection[i].apply(undefined, arguments);\n                }\n            });\n        })";var bakeCollection_3=void 0,fixedArgsNum=void 0,bakeCollectionVariadic_3=void 0,bakeCollectionAwait_3=void 0,funcFactory=eval(funcFactoryCode);return funcFactory(collection)}exports.bakeCollection=bakeCollection,exports.bakeCollectionAwait=bakeCollectionAwait,exports.bakeCollectionVariadic=bakeCollectionVariadic},857:function(t,e,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(e,n);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,r,i)}:function(t,e,n,r){void 0===r&&(r=n),t[r]=e[n]}),i=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||r(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(n(369),e)},369:function(t,e,n){"use strict";var r=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(e,"__esModule",{value:!0}),e.TaskCollection=void 0;var i=n(372),s=n(665);function o(t,e){var n,r=this.length;if(r>1)e?((n=this._tasks).push.apply(n,arguments),this.length+=arguments.length):(this._tasks.push(t),this.length++);else if(e){var i;1===r?((i=Array(1+arguments.length)).push(i),i.push.apply(i,arguments),this._tasks=i):((i=Array(arguments.length)).push.apply(i,arguments),this._tasks=i),this.length+=arguments.length}else this._tasks=1===r?[this._tasks,t]:t,this.length++}function a(t,e){var n,r=this.length;if(r>1)e?((n=this._tasks).push.apply(n,arguments),this.length+=arguments.length):(this._tasks.push(t),this.length++);else if(e){var i;1===r?((i=Array(1+arguments.length)).push(i),i.push.apply(i,arguments),this._tasks=i):((i=Array(arguments.length)).push.apply(i,arguments),this._tasks=i),this.length+=arguments.length}else this._tasks=1===r?[this._tasks,t]:t,this.length++;this.firstEmitBuildStrategy?this.call=p:this.rebuild()}function c(t){0!==this.length&&(1===this.length?this._tasks===t&&(this.length=0):((0,i._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),1===this._tasks.length?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function h(t){if(0!==this.length){if(1===this.length)return this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy?void(this.call=s.BAKED_EMPTY_FUNC):void this.rebuild();(0,i._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),1===this._tasks.length?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length,this.firstEmitBuildStrategy?this.call=p:this.rebuild()}}function l(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];0===this.length?(this._tasks=n,this.length=1):1===this.length?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,r([t,0],n,!1)),this.length=this._tasks.length)}function u(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];0===this.length?(this._tasks=n,this.length=1):1===this.length?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,r([t,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=p:this.rebuild()}function d(){0===this.length?this.call=s.BAKED_EMPTY_FUNC:1===this.length?this.call=this._tasks:this.call=(0,s.bakeCollection)(this._tasks,this.argsNum)}function f(){0===this.length?this.call=s.BAKED_EMPTY_FUNC:1===this.length?this.call=this._tasks:this.call=(0,s.bakeCollectionAwait)(this._tasks,this.argsNum)}function p(){this.rebuild(),this.call.apply(void 0,arguments)}var g=function(t,e,n,r){void 0===e&&(e=!0),void 0===n&&(n=null),void 0===r&&(r=!1),this.awaitTasks=r,this.call=s.BAKED_EMPTY_FUNC,this.argsNum=t,this.firstEmitBuildStrategy=!0,this.rebuild=r?f.bind(this):d.bind(this),this.setAutoRebuild(e),n?"function"==typeof n?(this._tasks=n,this.length=1):(this._tasks=n,this.length=n.length):(this._tasks=null,this.length=0),e&&this.rebuild()};e.TaskCollection=g,g.prototype.fastClear=function(){this._tasks=null,this.length=0,this.call=s.BAKED_EMPTY_FUNC},g.prototype.clear=function(){this._tasks=null,this.length=0,this.call=s.BAKED_EMPTY_FUNC},g.prototype.growArgsNum=function(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=p:this.rebuild())},g.prototype.setAutoRebuild=function(t){t?(this.push=a.bind(this),this.insert=u.bind(this),this.removeLast=h.bind(this)):(this.push=o.bind(this),this.insert=l.bind(this),this.removeLast=c.bind(this))},g.prototype.tasksAsArray=function(){return 0===this.length?[]:1===this.length?[this._tasks]:this._tasks},g.prototype.setTasks=function(t){0===t.length?(this.length=0,this.call=s.BAKED_EMPTY_FUNC):1===t.length?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=p:this.rebuild())}},372:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._fast_remove_single=void 0,e._fast_remove_single=function(t,e){-1!==e&&(0===e?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}},335:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0})},547:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.nullObj=void 0,e.nullObj=function(){return{__proto__:null}}},145:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LRUCache=void 0;const r=n(397);class i{constructor(t){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:e=25,entryExpirationTimeInMS:n=null,onEntryEvicted:r,onEntryMarkedAsMostRecentlyUsed:i,cloneFn:s,clone:o}=null!=t?t:{};if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");if("number"==typeof n&&(n<=0||Number.isNaN(n)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=e,this.entryExpirationTimeInMS=n,this.onEntryEvicted=r,this.onEntryMarkedAsMostRecentlyUsed=i,this.clone=o,this.cloneFn=s}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(t){if(Number.isNaN(t)||t<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=t,this.enforceSizeLimit()}set(t,e,n){const i=this.lookupTable.get(t);i&&this.removeNodeFromListAndLookupTable(i);const s=new r.LRUCacheNode(t,e,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...n});return this.setNodeAsHead(s),this.lookupTable.set(t,s),this.enforceSizeLimit(),this}get(t){const e=this.lookupTable.get(t);return e?e.isExpired?(this.removeNodeFromListAndLookupTable(e),null):(this.setNodeAsHead(e),e.value):null}peek(t){const e=this.lookupTable.get(t);return e?e.isExpired?(this.removeNodeFromListAndLookupTable(e),null):e.value:null}delete(t){const e=this.lookupTable.get(t);return!!e&&this.removeNodeFromListAndLookupTable(e)}has(t){const e=this.lookupTable.get(t);return!(!e||e.isExpired&&(this.removeNodeFromListAndLookupTable(e),1))}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(t){let e=this.head;for(;e;){if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t;continue}const n=this.mapNodeToEntry(e);if(t(n))return this.setNodeAsHead(e),n;e=e.next}return null}forEach(t){let e=this.head,n=0;for(;e;)if(e.isExpired){const t=e.next;this.removeNodeFromListAndLookupTable(e),e=t}else t(e.value,e.key,n),e=e.next,n++}*values(){let t=this.head;for(;t;)if(t.isExpired){const e=t.next;this.removeNodeFromListAndLookupTable(t),t=e}else yield t.value,t=t.next}*keys(){let t=this.head;for(;t;)if(t.isExpired){const e=t.next;this.removeNodeFromListAndLookupTable(t),t=e}else yield t.key,t=t.next}*entries(){let t=this.head;for(;t;)if(t.isExpired){const e=t.next;this.removeNodeFromListAndLookupTable(t),t=e}else yield this.mapNodeToEntry(t),t=t.next}*[Symbol.iterator](){let t=this.head;for(;t;)if(t.isExpired){const e=t.next;this.removeNodeFromListAndLookupTable(t),t=e}else yield this.mapNodeToEntry(t),t=t.next}enforceSizeLimit(){let t=this.tail;for(;null!==t&&this.size>this.maxSizeInternal;){const e=t.prev;this.removeNodeFromListAndLookupTable(t),t=e}}mapNodeToEntry({key:t,value:e}){return{key:t,value:e}}setNodeAsHead(t){this.removeNodeFromList(t),this.head?(t.next=this.head,this.head.prev=t,this.head=t):(this.head=t,this.tail=t),t.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(t){null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.head===t&&(this.head=t.next),this.tail===t&&(this.tail=t.prev),t.next=null,t.prev=null}removeNodeFromListAndLookupTable(t){return t.invokeOnEvicted(),this.removeNodeFromList(t),this.lookupTable.delete(t.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const t=[];for(const e of this.lookupTable.values())e.isExpired&&t.push(e);t.forEach((t=>this.removeNodeFromListAndLookupTable(t)))}}e.LRUCache=i},397:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LRUCacheNode=void 0,e.LRUCacheNode=class{constructor(t,e,n){const{entryExpirationTimeInMS:r=null,next:i=null,prev:s=null,onEntryEvicted:o,onEntryMarkedAsMostRecentlyUsed:a,clone:c,cloneFn:h}=null!=n?n:{};if("number"==typeof r&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=null!=c&&c,this.cloneFn=null!=h?h:this.defaultClone,this.key=t,this.internalValue=this.clone?this.cloneFn(e):e,this.created=Date.now(),this.entryExpirationTimeInMS=r,this.next=i,this.prev=s,this.onEntryEvicted=o,this.onEntryMarkedAsMostRecentlyUsed=a}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return"number"==typeof this.entryExpirationTimeInMS&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:t,value:e,isExpired:n}=this;this.onEntryEvicted({key:t,value:e,isExpired:n})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:t,value:e}=this;this.onEntryMarkedAsMostRecentlyUsed({key:t,value:e})}}defaultClone(t){return"boolean"==typeof t||"string"==typeof t||"number"==typeof t?t:JSON.parse(JSON.stringify(t))}}},654:function(t,e,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(e,n);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,r,i)}:function(t,e,n,r){void 0===r&&(r=n),t[r]=e[n]}),i=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||r(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(n(145),e)}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var n=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(t,e)=>{for(var n in e)__webpack_require__.o(e,n)&&!__webpack_require__.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{"use strict";var t={};__webpack_require__.r(t),__webpack_require__.d(t,{OG:()=>O,My:()=>R,Ph:()=>T,lX:()=>I,Id:()=>P,fg:()=>z,qj:()=>L,aT:()=>C,lq:()=>U,z:()=>N,Q5:()=>M});var e={};__webpack_require__.r(e),__webpack_require__.d(e,{aK:()=>Ca,e8:()=>da,DO:()=>ua,dJ:()=>Ta,OG:()=>Ia,My:()=>pa,Ph:()=>va,lX:()=>_a,Id:()=>xa,fg:()=>La,qj:()=>Aa,aT:()=>ba,r4:()=>Sa,aY:()=>la,x:()=>Ba,lq:()=>Ea,z:()=>ka,zW:()=>ga,Q5:()=>Oa});var n=__webpack_require__(706),r=__webpack_require__(418);function i(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function s(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function o(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}const a="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0,c=t=>t instanceof Uint8Array,h=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),l=(t,e)=>t<<32-e|t>>>e;if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function u(t){if("string"==typeof t&&(t=function(t){if("string"!=typeof t)throw new Error("utf8ToBytes expected string, got "+typeof t);return new Uint8Array((new TextEncoder).encode(t))}(t)),!c(t))throw new Error("expected Uint8Array, got "+typeof t);return t}class d{clone(){return this._cloneInto()}}function f(t){const e=e=>t().update(u(e)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function p(t=32){if(a&&"function"==typeof a.getRandomValues)return a.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}class g extends d{constructor(t,e,n,r){super(),this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=h(this.buffer)}update(t){o(this);const{view:e,buffer:n,blockLen:r}=this,i=(t=u(t)).length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o!==r)n.set(t.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(e,0),this.pos=0);else{const e=h(t);for(;r<=i-s;s+=r)this.process(e,s)}}return this.length+=t.length,this.roundClean(),this}digestInto(t){o(this),function(t,e){s(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}(t,this),this.finished=!0;const{buffer:e,view:n,blockLen:r,isLE:i}=this;let{pos:a}=this;e[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>r-a&&(this.process(n,0),a=0);for(let t=a;t<r;t++)e[t]=0;!function(t,e,n,r){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,n,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(n>>i&s),a=Number(n&s),c=r?4:0,h=r?0:4;t.setUint32(e+c,o,r),t.setUint32(e+h,a,r)}(n,r-8,BigInt(8*this.length),i),this.process(n,0);const c=h(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,d=this.get();if(u>d.length)throw new Error("_sha2: outputLen bigger than state");for(let t=0;t<u;t++)c.setUint32(4*t,d[t],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:n,length:r,finished:i,destroyed:s,pos:o}=this;return t.length=r,t.pos=o,t.finished=i,t.destroyed=s,r%e&&t.buffer.set(n),t}}const y=(t,e,n)=>t&e^t&n^e&n,w=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),m=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),b=new Uint32Array(64);class v extends g{constructor(){super(64,32,8,!1),this.A=0|m[0],this.B=0|m[1],this.C=0|m[2],this.D=0|m[3],this.E=0|m[4],this.F=0|m[5],this.G=0|m[6],this.H=0|m[7]}get(){const{A:t,B:e,C:n,D:r,E:i,F:s,G:o,H:a}=this;return[t,e,n,r,i,s,o,a]}set(t,e,n,r,i,s,o,a){this.A=0|t,this.B=0|e,this.C=0|n,this.D=0|r,this.E=0|i,this.F=0|s,this.G=0|o,this.H=0|a}process(t,e){for(let n=0;n<16;n++,e+=4)b[n]=t.getUint32(e,!1);for(let t=16;t<64;t++){const e=b[t-15],n=b[t-2],r=l(e,7)^l(e,18)^e>>>3,i=l(n,17)^l(n,19)^n>>>10;b[t]=i+b[t-7]+r+b[t-16]|0}let{A:n,B:r,C:i,D:s,E:o,F:a,G:c,H:h}=this;for(let t=0;t<64;t++){const e=h+(l(o,6)^l(o,11)^l(o,25))+((u=o)&a^~u&c)+w[t]+b[t]|0,d=(l(n,2)^l(n,13)^l(n,22))+y(n,r,i)|0;h=c,c=a,a=o,o=s+e|0,s=i,i=r,r=n,n=e+d|0}var u;n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,h=h+this.H|0,this.set(n,r,i,s,o,a,c,h)}roundClean(){b.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const _=f((()=>new v)),E=(BigInt(0),BigInt(1)),k=BigInt(2),A=t=>t instanceof Uint8Array,x=Array.from({length:256},((t,e)=>e.toString(16).padStart(2,"0")));function R(t){if(!A(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=x[t[n]];return e}function S(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);return BigInt(""===t?"0":`0x${t}`)}function C(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let e=0;e<n.length;e++){const r=2*e,i=t.slice(r,r+2),s=Number.parseInt(i,16);if(Number.isNaN(s)||s<0)throw new Error("Invalid byte sequence");n[e]=s}return n}function T(t){return S(R(t))}function I(t){if(!A(t))throw new Error("Uint8Array expected");return S(R(Uint8Array.from(t).reverse()))}function U(t,e){return C(t.toString(16).padStart(2*e,"0"))}function N(t,e){return U(t,e).reverse()}function L(t,e,n){let r;if("string"==typeof e)try{r=C(e)}catch(n){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${n}`)}else{if(!A(e))throw new Error(`${t} must be hex string or Uint8Array`);r=Uint8Array.from(e)}const i=r.length;if("number"==typeof n&&i!==n)throw new Error(`${t} expected ${n} bytes, got ${i}`);return r}function P(...t){const e=new Uint8Array(t.reduce(((t,e)=>t+e.length),0));let n=0;return t.forEach((t=>{if(!A(t))throw new Error("Uint8Array expected");e.set(t,n),n+=t.length})),e}const O=t=>(k<<BigInt(t-1))-E,B=t=>new Uint8Array(t),F=t=>Uint8Array.from(t);function z(t,e,n){if("number"!=typeof t||t<2)throw new Error("hashLen must be a number");if("number"!=typeof e||e<2)throw new Error("qByteLen must be a number");if("function"!=typeof n)throw new Error("hmacFn must be a function");let r=B(t),i=B(t),s=0;const o=()=>{r.fill(1),i.fill(0),s=0},a=(...t)=>n(i,r,...t),c=(t=B())=>{i=a(F([0]),t),r=a(),0!==t.length&&(i=a(F([1]),t),r=a())},h=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let t=0;const n=[];for(;t<e;){r=a();const e=r.slice();n.push(e),t+=r.length}return P(...n)};return(t,e)=>{let n;for(o(),c(t);!(n=e(h()));)c();return o(),n}}const D={bigint:t=>"bigint"==typeof t,function:t=>"function"==typeof t,boolean:t=>"boolean"==typeof t,string:t=>"string"==typeof t,stringOrUint8Array:t=>"string"==typeof t||t instanceof Uint8Array,isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>"function"==typeof t&&Number.isSafeInteger(t.outputLen)};function M(t,e,n={}){const r=(e,n,r)=>{const i=D[n];if("function"!=typeof i)throw new Error(`Invalid validator "${n}", expected function`);const s=t[e];if(!(r&&void 0===s||i(s,t)))throw new Error(`Invalid param ${String(e)}=${s} (${typeof s}), expected ${n}`)};for(const[t,n]of Object.entries(e))r(t,n,!1);for(const[t,e]of Object.entries(n))r(t,e,!0);return t}const $=BigInt(0),K=BigInt(1),q=BigInt(2),H=BigInt(3),j=BigInt(4),V=BigInt(5),Z=BigInt(8);function W(t,e){const n=t%e;return n>=$?n:e+n}function G(t,e,n){if(n<=$||e<$)throw new Error("Expected power/modulo > 0");if(n===K)return $;let r=K;for(;e>$;)e&K&&(r=r*t%n),t=t*t%n,e>>=K;return r}function J(t,e,n){let r=t;for(;e-- >$;)r*=r,r%=n;return r}function Y(t,e){if(t===$||e<=$)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=W(t,e),r=e,i=$,s=K,o=K,a=$;for(;n!==$;){const t=r/n,e=r%n,c=i-o*t,h=s-a*t;r=n,n=e,i=o,s=a,o=c,a=h}if(r!==K)throw new Error("invert: does not exist");return W(i,e)}BigInt(9),BigInt(16);const Q=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function X(t,e){const n=void 0!==e?e:t.toString(2).length;return{nBitLength:n,nByteLength:Math.ceil(n/8)}}function tt(t){if("bigint"!=typeof t)throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function et(t){const e=tt(t);return e+Math.ceil(e/2)}class nt extends d{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,function(t){if("function"!=typeof t||"function"!=typeof t.create)throw new Error("Hash should be wrapped by utils.wrapConstructor");i(t.outputLen),i(t.blockLen)}(t);const n=u(e);if(this.iHash=t.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,s=new Uint8Array(r);s.set(n.length>r?t.create().update(n).digest():n);for(let t=0;t<s.length;t++)s[t]^=54;this.iHash.update(s),this.oHash=t.create();for(let t=0;t<s.length;t++)s[t]^=106;this.oHash.update(s),s.fill(0)}update(t){return o(this),this.iHash.update(t),this}digestInto(t){o(this),s(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:n,finished:r,destroyed:i,blockLen:s,outputLen:o}=this;return t.finished=r,t.destroyed=i,t.blockLen=s,t.outputLen=o,t.oHash=e._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const rt=(t,e,n)=>new nt(t,e).update(n).digest();rt.create=(t,e)=>new nt(t,e);const it=BigInt(0),st=BigInt(1);function ot(t){return M(t.Fp,Q.reduce(((t,e)=>(t[e]="function",t)),{ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"})),M(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...X(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}const{Ph:at,aT:ct}=t,ht={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(t){const{Err:e}=ht;if(t.length<2||2!==t[0])throw new e("Invalid signature integer tag");const n=t[1],r=t.subarray(2,n+2);if(!n||r.length!==n)throw new e("Invalid signature integer: wrong length");if(128&r[0])throw new e("Invalid signature integer: negative");if(0===r[0]&&!(128&r[1]))throw new e("Invalid signature integer: unnecessary leading zero");return{d:at(r),l:t.subarray(n+2)}},toSig(t){const{Err:e}=ht,n="string"==typeof t?ct(t):t;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||48!=n[0])throw new e("Invalid signature tag");if(n[1]!==r-2)throw new e("Invalid signature: incorrect length");const{d:i,l:s}=ht._parseInt(n.subarray(2)),{d:o,l:a}=ht._parseInt(s);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:i,s:o}},hexFromSig(t){const e=t=>8&Number.parseInt(t[0],16)?"00"+t:t,n=t=>{const e=t.toString(16);return 1&e.length?`0${e}`:e},r=e(n(t.s)),i=e(n(t.r)),s=r.length/2,o=i.length/2,a=n(s),c=n(o);return`30${n(o+s+4)}02${c}${i}02${a}${r}`}},lt=BigInt(0),ut=BigInt(1),dt=(BigInt(2),BigInt(3));function ft(t){const e=function(t){const e=ot(t);return M(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}(t),{Fp:n,n:r}=e,i=n.BYTES+1,s=2*n.BYTES+1;function o(t){return W(t,r)}function a(t){return Y(t,r)}const{ProjectivePoint:c,normPrivateKeyToScalar:h,weierstrassEquation:l,isWithinCurveOrder:u}=function(t){const e=function(t){const e=ot(t);M(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:i}=e;if(n){if(!r.eql(i,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if("object"!=typeof n||"bigint"!=typeof n.beta||"function"!=typeof n.splitScalar)throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}(t),{Fp:n}=e,r=e.toBytes||((t,e,r)=>{const i=e.toAffine();return P(Uint8Array.from([4]),n.toBytes(i.x),n.toBytes(i.y))}),i=e.fromBytes||(t=>{const e=t.subarray(1);return{x:n.fromBytes(e.subarray(0,n.BYTES)),y:n.fromBytes(e.subarray(n.BYTES,2*n.BYTES))}});function s(t){const{a:r,b:i}=e,s=n.sqr(t),o=n.mul(s,t);return n.add(n.add(o,n.mul(t,r)),i)}if(!n.eql(n.sqr(e.Gy),s(e.Gx)))throw new Error("bad generator point: equation left != right");function o(t){return"bigint"==typeof t&&lt<t&&t<e.n}function a(t){if(!o(t))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(t){const{allowedPrivateKeyLengths:n,nByteLength:r,wrapPrivateKey:i,n:s}=e;if(n&&"bigint"!=typeof t){if(t instanceof Uint8Array&&(t=R(t)),"string"!=typeof t||!n.includes(t.length))throw new Error("Invalid key");t=t.padStart(2*r,"0")}let o;try{o="bigint"==typeof t?t:T(L("private key",t,r))}catch(e){throw new Error(`private key must be ${r} bytes, hex or bigint, not ${typeof t}`)}return i&&(o=W(o,s)),a(o),o}const h=new Map;function l(t){if(!(t instanceof u))throw new Error("ProjectivePoint expected")}class u{constructor(t,e,r){if(this.px=t,this.py=e,this.pz=r,null==t||!n.isValid(t))throw new Error("x required");if(null==e||!n.isValid(e))throw new Error("y required");if(null==r||!n.isValid(r))throw new Error("z required")}static fromAffine(t){const{x:e,y:r}=t||{};if(!t||!n.isValid(e)||!n.isValid(r))throw new Error("invalid affine point");if(t instanceof u)throw new Error("projective point not allowed");const i=t=>n.eql(t,n.ZERO);return i(e)&&i(r)?u.ZERO:new u(e,r,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(t){const e=n.invertBatch(t.map((t=>t.pz)));return t.map(((t,n)=>t.toAffine(e[n]))).map(u.fromAffine)}static fromHex(t){const e=u.fromAffine(i(L("pointHex",t)));return e.assertValidity(),e}static fromPrivateKey(t){return u.BASE.multiply(c(t))}_setWindowSize(t){this._WINDOW_SIZE=t,h.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:t,y:r}=this.toAffine();if(!n.isValid(t)||!n.isValid(r))throw new Error("bad point: x or y not FE");const i=n.sqr(r),o=s(t);if(!n.eql(i,o))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:t}=this.toAffine();if(n.isOdd)return!n.isOdd(t);throw new Error("Field doesn't support isOdd")}equals(t){l(t);const{px:e,py:r,pz:i}=this,{px:s,py:o,pz:a}=t,c=n.eql(n.mul(e,a),n.mul(s,i)),h=n.eql(n.mul(r,a),n.mul(o,i));return c&&h}negate(){return new u(this.px,n.neg(this.py),this.pz)}double(){const{a:t,b:r}=e,i=n.mul(r,dt),{px:s,py:o,pz:a}=this;let c=n.ZERO,h=n.ZERO,l=n.ZERO,d=n.mul(s,s),f=n.mul(o,o),p=n.mul(a,a),g=n.mul(s,o);return g=n.add(g,g),l=n.mul(s,a),l=n.add(l,l),c=n.mul(t,l),h=n.mul(i,p),h=n.add(c,h),c=n.sub(f,h),h=n.add(f,h),h=n.mul(c,h),c=n.mul(g,c),l=n.mul(i,l),p=n.mul(t,p),g=n.sub(d,p),g=n.mul(t,g),g=n.add(g,l),l=n.add(d,d),d=n.add(l,d),d=n.add(d,p),d=n.mul(d,g),h=n.add(h,d),p=n.mul(o,a),p=n.add(p,p),d=n.mul(p,g),c=n.sub(c,d),l=n.mul(p,f),l=n.add(l,l),l=n.add(l,l),new u(c,h,l)}add(t){l(t);const{px:r,py:i,pz:s}=this,{px:o,py:a,pz:c}=t;let h=n.ZERO,d=n.ZERO,f=n.ZERO;const p=e.a,g=n.mul(e.b,dt);let y=n.mul(r,o),w=n.mul(i,a),m=n.mul(s,c),b=n.add(r,i),v=n.add(o,a);b=n.mul(b,v),v=n.add(y,w),b=n.sub(b,v),v=n.add(r,s);let _=n.add(o,c);return v=n.mul(v,_),_=n.add(y,m),v=n.sub(v,_),_=n.add(i,s),h=n.add(a,c),_=n.mul(_,h),h=n.add(w,m),_=n.sub(_,h),f=n.mul(p,v),h=n.mul(g,m),f=n.add(h,f),h=n.sub(w,f),f=n.add(w,f),d=n.mul(h,f),w=n.add(y,y),w=n.add(w,y),m=n.mul(p,m),v=n.mul(g,v),w=n.add(w,m),m=n.sub(y,m),m=n.mul(p,m),v=n.add(v,m),y=n.mul(w,v),d=n.add(d,y),y=n.mul(_,v),h=n.mul(b,h),h=n.sub(h,y),y=n.mul(b,w),f=n.mul(_,f),f=n.add(f,y),new u(h,d,f)}subtract(t){return this.add(t.negate())}is0(){return this.equals(u.ZERO)}wNAF(t){return f.wNAFCached(this,h,t,(t=>{const e=n.invertBatch(t.map((t=>t.pz)));return t.map(((t,n)=>t.toAffine(e[n]))).map(u.fromAffine)}))}multiplyUnsafe(t){const r=u.ZERO;if(t===lt)return r;if(a(t),t===ut)return this;const{endo:i}=e;if(!i)return f.unsafeLadder(this,t);let{k1neg:s,k1:o,k2neg:c,k2:h}=i.splitScalar(t),l=r,d=r,p=this;for(;o>lt||h>lt;)o&ut&&(l=l.add(p)),h&ut&&(d=d.add(p)),p=p.double(),o>>=ut,h>>=ut;return s&&(l=l.negate()),c&&(d=d.negate()),d=new u(n.mul(d.px,i.beta),d.py,d.pz),l.add(d)}multiply(t){a(t);let r,i,s=t;const{endo:o}=e;if(o){const{k1neg:t,k1:e,k2neg:a,k2:c}=o.splitScalar(s);let{p:h,f:l}=this.wNAF(e),{p:d,f:p}=this.wNAF(c);h=f.constTimeNegate(t,h),d=f.constTimeNegate(a,d),d=new u(n.mul(d.px,o.beta),d.py,d.pz),r=h.add(d),i=l.add(p)}else{const{p:t,f:e}=this.wNAF(s);r=t,i=e}return u.normalizeZ([r,i])[0]}multiplyAndAddUnsafe(t,e,n){const r=u.BASE,i=(t,e)=>e!==lt&&e!==ut&&t.equals(r)?t.multiply(e):t.multiplyUnsafe(e),s=i(this,e).add(i(t,n));return s.is0()?void 0:s}toAffine(t){const{px:e,py:r,pz:i}=this,s=this.is0();null==t&&(t=s?n.ONE:n.inv(i));const o=n.mul(e,t),a=n.mul(r,t),c=n.mul(i,t);if(s)return{x:n.ZERO,y:n.ZERO};if(!n.eql(c,n.ONE))throw new Error("invZ was invalid");return{x:o,y:a}}isTorsionFree(){const{h:t,isTorsionFree:n}=e;if(t===ut)return!0;if(n)return n(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:t,clearCofactor:n}=e;return t===ut?this:n?n(u,this):this.multiplyUnsafe(e.h)}toRawBytes(t=!0){return this.assertValidity(),r(u,this,t)}toHex(t=!0){return R(this.toRawBytes(t))}}u.BASE=new u(e.Gx,e.Gy,n.ONE),u.ZERO=new u(n.ZERO,n.ONE,n.ZERO);const d=e.nBitLength,f=function(t,e){const n=(t,e)=>{const n=e.negate();return t?n:e},r=t=>({windows:Math.ceil(e/t)+1,windowSize:2**(t-1)});return{constTimeNegate:n,unsafeLadder(e,n){let r=t.ZERO,i=e;for(;n>it;)n&st&&(r=r.add(i)),i=i.double(),n>>=st;return r},precomputeWindow(t,e){const{windows:n,windowSize:i}=r(e),s=[];let o=t,a=o;for(let t=0;t<n;t++){a=o,s.push(a);for(let t=1;t<i;t++)a=a.add(o),s.push(a);o=a.double()}return s},wNAF(e,i,s){const{windows:o,windowSize:a}=r(e);let c=t.ZERO,h=t.BASE;const l=BigInt(2**e-1),u=2**e,d=BigInt(e);for(let t=0;t<o;t++){const e=t*a;let r=Number(s&l);s>>=d,r>a&&(r-=u,s+=st);const o=e,f=e+Math.abs(r)-1,p=t%2!=0,g=r<0;0===r?h=h.add(n(p,i[o])):c=c.add(n(g,i[f]))}return{p:c,f:h}},wNAFCached(t,e,n,r){const i=t._WINDOW_SIZE||1;let s=e.get(t);return s||(s=this.precomputeWindow(t,i),1!==i&&e.set(t,r(s))),this.wNAF(i,s,n)}}}(u,e.endo?Math.ceil(d/2):d);return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:c,weierstrassEquation:s,isWithinCurveOrder:o}}({...e,toBytes(t,e,r){const i=e.toAffine(),s=n.toBytes(i.x),o=P;return r?o(Uint8Array.from([e.hasEvenY()?2:3]),s):o(Uint8Array.from([4]),s,n.toBytes(i.y))},fromBytes(t){const e=t.length,r=t[0],o=t.subarray(1);if(e!==i||2!==r&&3!==r){if(e===s&&4===r)return{x:n.fromBytes(o.subarray(0,n.BYTES)),y:n.fromBytes(o.subarray(n.BYTES,2*n.BYTES))};throw new Error(`Point of length ${e} was invalid. Expected ${i} compressed bytes or ${s} uncompressed bytes`)}{const t=T(o);if(!function(t){return lt<t&&t<n.ORDER}(t))throw new Error("Point is not on curve");const e=l(t);let i=n.sqrt(e);return!(1&~r)!=((i&ut)===ut)&&(i=n.neg(i)),{x:t,y:i}}}}),d=t=>R(U(t,e.nByteLength));function f(t){return t>r>>ut}const p=(t,e,n)=>T(t.slice(e,n));class g{constructor(t,e,n){this.r=t,this.s=e,this.recovery=n,this.assertValidity()}static fromCompact(t){const n=e.nByteLength;return t=L("compactSignature",t,2*n),new g(p(t,0,n),p(t,n,2*n))}static fromDER(t){const{r:e,s:n}=ht.toSig(L("DER",t));return new g(e,n)}assertValidity(){if(!u(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!u(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(t){return new g(this.r,this.s,t)}recoverPublicKey(t){const{r,s:i,recovery:s}=this,h=b(L("msgHash",t));if(null==s||![0,1,2,3].includes(s))throw new Error("recovery id invalid");const l=2===s||3===s?r+e.n:r;if(l>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const u=1&s?"03":"02",f=c.fromHex(u+d(l)),p=a(l),g=o(-h*p),y=o(i*p),w=c.BASE.multiplyAndAddUnsafe(f,g,y);if(!w)throw new Error("point at infinify");return w.assertValidity(),w}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new g(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return C(this.toDERHex())}toDERHex(){return ht.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return C(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}const y={isValidPrivateKey(t){try{return h(t),!0}catch(t){return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const t=et(e.n);return function(t,e,n=!1){const r=t.length,i=tt(e),s=et(e);if(r<16||r<s||r>1024)throw new Error(`expected ${s}-1024 bytes of input, got ${r}`);const o=W(n?T(t):I(t),e-K)+K;return n?N(o,i):U(o,i)}(e.randomBytes(t),e.n)},precompute:(t=8,e=c.BASE)=>(e._setWindowSize(t),e.multiply(BigInt(3)),e)};function w(t){const e=t instanceof Uint8Array,n="string"==typeof t,r=(e||n)&&t.length;return e?r===i||r===s:n?r===2*i||r===2*s:t instanceof c}const m=e.bits2int||function(t){const n=T(t),r=8*t.length-e.nBitLength;return r>0?n>>BigInt(r):n},b=e.bits2int_modN||function(t){return o(m(t))},v=O(e.nBitLength);function _(t){if("bigint"!=typeof t)throw new Error("bigint expected");if(!(lt<=t&&t<v))throw new Error(`bigint expected < 2^${e.nBitLength}`);return U(t,e.nByteLength)}const E={lowS:e.lowS,prehash:!1},k={lowS:e.lowS,prehash:!1};return c.BASE._setWindowSize(8),{CURVE:e,getPublicKey:function(t,e=!0){return c.fromPrivateKey(t).toRawBytes(e)},getSharedSecret:function(t,e,n=!0){if(w(t))throw new Error("first arg must be private key");if(!w(e))throw new Error("second arg must be public key");return c.fromHex(e).multiply(h(t)).toRawBytes(n)},sign:function(t,r,i=E){const{seed:s,k2sig:l}=function(t,r,i=E){if(["recovered","canonical"].some((t=>t in i)))throw new Error("sign() legacy options not supported");const{hash:s,randomBytes:l}=e;let{lowS:d,prehash:p,extraEntropy:y}=i;null==d&&(d=!0),t=L("msgHash",t),p&&(t=L("prehashed msgHash",s(t)));const w=b(t),v=h(r),k=[_(v),_(w)];if(null!=y){const t=!0===y?l(n.BYTES):y;k.push(L("extraEntropy",t))}const A=P(...k),x=w;return{seed:A,k2sig:function(t){const e=m(t);if(!u(e))return;const n=a(e),r=c.BASE.multiply(e).toAffine(),i=o(r.x);if(i===lt)return;const s=o(n*o(x+i*v));if(s===lt)return;let h=(r.x===i?0:2)|Number(r.y&ut),l=s;return d&&f(s)&&(l=function(t){return f(t)?o(-t):t}(s),h^=1),new g(i,l,h)}}}(t,r,i),d=e;return z(d.hash.outputLen,d.nByteLength,d.hmac)(s,l)},verify:function(t,n,r,i=k){const s=t;if(n=L("msgHash",n),r=L("publicKey",r),"strict"in i)throw new Error("options.strict was renamed to lowS");const{lowS:h,prehash:l}=i;let u,d;try{if("string"==typeof s||s instanceof Uint8Array)try{u=g.fromDER(s)}catch(t){if(!(t instanceof ht.Err))throw t;u=g.fromCompact(s)}else{if("object"!=typeof s||"bigint"!=typeof s.r||"bigint"!=typeof s.s)throw new Error("PARSE");{const{r:t,s:e}=s;u=new g(t,e)}}d=c.fromHex(r)}catch(t){if("PARSE"===t.message)throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(h&&u.hasHighS())return!1;l&&(n=e.hash(n));const{r:f,s:p}=u,y=b(n),w=a(p),m=o(y*w),v=o(f*w),_=c.BASE.multiplyAndAddUnsafe(d,m,v)?.toAffine();return!!_&&o(_.x)===f},ProjectivePoint:c,Signature:g,utils:y}}function pt(t){return{hash:t,hmac:(e,...n)=>rt(t,e,function(...t){const e=new Uint8Array(t.reduce(((t,e)=>t+e.length),0));let n=0;return t.forEach((t=>{if(!c(t))throw new Error("Uint8Array expected");e.set(t,n),n+=t.length})),e}(...n)),randomBytes:p}}BigInt(4);const gt=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),yt=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),wt=BigInt(1),mt=BigInt(2),bt=(t,e)=>(t+e/mt)/e;function vt(t){const e=gt,n=BigInt(3),r=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),h=t*t*t%e,l=h*h*t%e,u=J(l,n,e)*l%e,d=J(u,n,e)*l%e,f=J(d,mt,e)*h%e,p=J(f,i,e)*f%e,g=J(p,s,e)*p%e,y=J(g,a,e)*g%e,w=J(y,c,e)*y%e,m=J(w,a,e)*g%e,b=J(m,n,e)*l%e,v=J(b,o,e)*p%e,_=J(v,r,e)*h%e,E=J(_,mt,e);if(!_t.eql(_t.sqr(E),t))throw new Error("Cannot find square root");return E}const _t=function(t,e,n=!1,r={}){if(t<=$)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:i,nByteLength:s}=X(t,e);if(s>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=function(t){if(t%j===H){const e=(t+K)/j;return function(t,n){const r=t.pow(n,e);if(!t.eql(t.sqr(r),n))throw new Error("Cannot find square root");return r}}if(t%Z===V){const e=(t-V)/Z;return function(t,n){const r=t.mul(n,q),i=t.pow(r,e),s=t.mul(n,i),o=t.mul(t.mul(s,q),i),a=t.mul(s,t.sub(o,t.ONE));if(!t.eql(t.sqr(a),n))throw new Error("Cannot find square root");return a}}return function(t){const e=(t-K)/q;let n,r,i;for(n=t-K,r=0;n%q===$;n/=q,r++);for(i=q;i<t&&G(i,e,t)!==t-K;i++);if(1===r){const e=(t+K)/j;return function(t,n){const r=t.pow(n,e);if(!t.eql(t.sqr(r),n))throw new Error("Cannot find square root");return r}}const s=(n+K)/q;return function(t,o){if(t.pow(o,e)===t.neg(t.ONE))throw new Error("Cannot find square root");let a=r,c=t.pow(t.mul(t.ONE,i),n),h=t.pow(o,s),l=t.pow(o,n);for(;!t.eql(l,t.ONE);){if(t.eql(l,t.ZERO))return t.ZERO;let e=1;for(let n=t.sqr(l);e<a&&!t.eql(n,t.ONE);e++)n=t.sqr(n);const n=t.pow(c,K<<BigInt(a-e-1));c=t.sqr(n),h=t.mul(h,n),l=t.mul(l,c),a=e}return h}}(t)}(t),a=Object.freeze({ORDER:t,BITS:i,BYTES:s,MASK:O(i),ZERO:$,ONE:K,create:e=>W(e,t),isValid:e=>{if("bigint"!=typeof e)throw new Error("Invalid field element: expected bigint, got "+typeof e);return $<=e&&e<t},is0:t=>t===$,isOdd:t=>(t&K)===K,neg:e=>W(-e,t),eql:(t,e)=>t===e,sqr:e=>W(e*e,t),add:(e,n)=>W(e+n,t),sub:(e,n)=>W(e-n,t),mul:(e,n)=>W(e*n,t),pow:(t,e)=>function(t,e,n){if(n<$)throw new Error("Expected power > 0");if(n===$)return t.ONE;if(n===K)return e;let r=t.ONE,i=e;for(;n>$;)n&K&&(r=t.mul(r,i)),i=t.sqr(i),n>>=K;return r}(a,t,e),div:(e,n)=>W(e*Y(n,t),t),sqrN:t=>t*t,addN:(t,e)=>t+e,subN:(t,e)=>t-e,mulN:(t,e)=>t*e,inv:e=>Y(e,t),sqrt:r.sqrt||(t=>o(a,t)),invertBatch:t=>function(t,e){const n=new Array(e.length),r=e.reduce(((e,r,i)=>t.is0(r)?e:(n[i]=e,t.mul(e,r))),t.ONE),i=t.inv(r);return e.reduceRight(((e,r,i)=>t.is0(r)?e:(n[i]=t.mul(e,n[i]),t.mul(e,r))),i),n}(a,t),cmov:(t,e,n)=>n?e:t,toBytes:t=>n?N(t,s):U(t,s),fromBytes:t=>{if(t.length!==s)throw new Error(`Fp.fromBytes: expected ${s}, got ${t.length}`);return n?I(t):T(t)}});return Object.freeze(a)}(gt,void 0,void 0,{sqrt:vt}),Et=function(t,e){const n=e=>ft({...t,...pt(e)});return Object.freeze({...n(e),create:n})}({a:BigInt(0),b:BigInt(7),Fp:_t,n:yt,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=yt,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-wt*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=n,o=BigInt("0x100000000000000000000000000000000"),a=bt(s*t,e),c=bt(-r*t,e);let h=W(t-a*n-c*i,e),l=W(-a*r-c*s,e);const u=h>o,d=l>o;if(u&&(h=e-h),d&&(l=e-l),h>o||l>o)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:u,k1:h,k2neg:d,k2:l}}}},_),kt=BigInt(0),At=t=>"bigint"==typeof t&&kt<t&&t<gt,xt={};function Rt(t,...e){let n=xt[t];if(void 0===n){const e=_(Uint8Array.from(t,(t=>t.charCodeAt(0))));n=P(e,e),xt[t]=n}return _(P(n,...e))}const St=t=>t.toRawBytes(!0).slice(1),Ct=t=>U(t,32),Tt=t=>W(t,gt),It=t=>W(t,yt),Ut=Et.ProjectivePoint;function Nt(t){let e=Et.utils.normPrivateKeyToScalar(t),n=Ut.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:It(-e),bytes:St(n)}}function Lt(t){if(!At(t))throw new Error("bad x: need 0 < x < p");const e=Tt(t*t);let n=vt(Tt(e*t+BigInt(7)));n%mt!==kt&&(n=Tt(-n));const r=new Ut(t,n,wt);return r.assertValidity(),r}function Pt(...t){return It(T(Rt("BIP0340/challenge",...t)))}function Ot(t){return Nt(t).bytes}function Bt(t,e,n=p(32)){const r=L("message",t),{bytes:i,scalar:s}=Nt(e),o=L("auxRand",n,32),a=Ct(s^T(Rt("BIP0340/aux",o))),c=Rt("BIP0340/nonce",a,i,r),h=It(T(c));if(h===kt)throw new Error("sign failed: k is zero");const{bytes:l,scalar:u}=Nt(h),d=Pt(l,i,r),f=new Uint8Array(64);if(f.set(l,0),f.set(Ct(It(u+d*s)),32),!Ft(f,r,i))throw new Error("sign: Invalid signature produced");return f}function Ft(t,e,n){const r=L("signature",t,64),i=L("message",e),s=L("publicKey",n,32);try{const t=Lt(T(s)),e=T(r.subarray(0,32));if(!At(e))return!1;const n=T(r.subarray(32,64));if(!("bigint"==typeof(h=n)&&kt<h&&h<yt))return!1;const l=Pt(Ct(e),St(t),i),u=(o=t,a=n,c=It(-l),Ut.BASE.multiplyAndAddUnsafe(o,a,c));return!(!u||!u.hasEvenY()||u.toAffine().x!==e)}catch(t){return!1}var o,a,c,h}const zt=(()=>({getPublicKey:Ot,sign:Bt,verify:Ft,utils:{randomPrivateKey:Et.utils.randomPrivateKey,lift_x:Lt,pointToBytes:St,numberToBytesBE:U,bytesToNumberBE:T,taggedHash:Rt,mod:W}}))(),Dt="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0,Mt=t=>t instanceof Uint8Array,$t=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),Kt=(t,e)=>t<<32-e|t>>>e;if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");const qt=Array.from({length:256},((t,e)=>e.toString(16).padStart(2,"0")));function Ht(t){if(!Mt(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=qt[t[n]];return e}function jt(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let e=0;e<n.length;e++){const r=2*e,i=t.slice(r,r+2),s=Number.parseInt(i,16);if(Number.isNaN(s)||s<0)throw new Error("Invalid byte sequence");n[e]=s}return n}function Vt(t){if("string"==typeof t&&(t=function(t){if("string"!=typeof t)throw new Error("utf8ToBytes expected string, got "+typeof t);return new Uint8Array((new TextEncoder).encode(t))}(t)),!Mt(t))throw new Error("expected Uint8Array, got "+typeof t);return t}function Zt(...t){const e=new Uint8Array(t.reduce(((t,e)=>t+e.length),0));let n=0;return t.forEach((t=>{if(!Mt(t))throw new Error("Uint8Array expected");e.set(t,n),n+=t.length})),e}class Wt{clone(){return this._cloneInto()}}function Gt(t){const e=e=>t().update(Vt(e)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function Jt(t=32){if(Dt&&"function"==typeof Dt.getRandomValues)return Dt.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function Yt(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function Qt(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}const Xt={number:Yt,bool:function(t){if("boolean"!=typeof t)throw new Error(`Expected boolean, not ${t}`)},bytes:Qt,hash:function(t){if("function"!=typeof t||"function"!=typeof t.create)throw new Error("Hash should be wrapped by utils.wrapConstructor");Yt(t.outputLen),Yt(t.blockLen)},exists:function(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")},output:function(t,e){Qt(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}};class te extends Wt{constructor(t,e,n,r){super(),this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=$t(this.buffer)}update(t){Xt.exists(this);const{view:e,buffer:n,blockLen:r}=this,i=(t=Vt(t)).length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o!==r)n.set(t.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(e,0),this.pos=0);else{const e=$t(t);for(;r<=i-s;s+=r)this.process(e,s)}}return this.length+=t.length,this.roundClean(),this}digestInto(t){Xt.exists(this),Xt.output(t,this),this.finished=!0;const{buffer:e,view:n,blockLen:r,isLE:i}=this;let{pos:s}=this;e[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>r-s&&(this.process(n,0),s=0);for(let t=s;t<r;t++)e[t]=0;!function(t,e,n,r){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,n,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(n>>i&s),a=Number(n&s),c=r?4:0,h=r?0:4;t.setUint32(e+c,o,r),t.setUint32(e+h,a,r)}(n,r-8,BigInt(8*this.length),i),this.process(n,0);const o=$t(t),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const c=a/4,h=this.get();if(c>h.length)throw new Error("_sha2: outputLen bigger than state");for(let t=0;t<c;t++)o.setUint32(4*t,h[t],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:n,length:r,finished:i,destroyed:s,pos:o}=this;return t.length=r,t.pos=o,t.finished=i,t.destroyed=s,r%e&&t.buffer.set(n),t}}const ee=(t,e,n)=>t&e^t&n^e&n,ne=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),re=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ie=new Uint32Array(64);class se extends te{constructor(){super(64,32,8,!1),this.A=0|re[0],this.B=0|re[1],this.C=0|re[2],this.D=0|re[3],this.E=0|re[4],this.F=0|re[5],this.G=0|re[6],this.H=0|re[7]}get(){const{A:t,B:e,C:n,D:r,E:i,F:s,G:o,H:a}=this;return[t,e,n,r,i,s,o,a]}set(t,e,n,r,i,s,o,a){this.A=0|t,this.B=0|e,this.C=0|n,this.D=0|r,this.E=0|i,this.F=0|s,this.G=0|o,this.H=0|a}process(t,e){for(let n=0;n<16;n++,e+=4)ie[n]=t.getUint32(e,!1);for(let t=16;t<64;t++){const e=ie[t-15],n=ie[t-2],r=Kt(e,7)^Kt(e,18)^e>>>3,i=Kt(n,17)^Kt(n,19)^n>>>10;ie[t]=i+ie[t-7]+r+ie[t-16]|0}let{A:n,B:r,C:i,D:s,E:o,F:a,G:c,H:h}=this;for(let t=0;t<64;t++){const e=h+(Kt(o,6)^Kt(o,11)^Kt(o,25))+((l=o)&a^~l&c)+ne[t]+ie[t]|0,u=(Kt(n,2)^Kt(n,13)^Kt(n,22))+ee(n,r,i)|0;h=c,c=a,a=o,o=s+e|0,s=i,i=r,r=n,n=e+u|0}var l;n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,h=h+this.H|0,this.set(n,r,i,s,o,a,c,h)}roundClean(){ie.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class oe extends se{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const ae=Gt((()=>new se));function ce(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function he(...t){const e=(t,e)=>n=>t(e(n)),n=Array.from(t).reverse().reduce(((t,n)=>t?e(t,n.encode):n.encode),void 0),r=t.reduce(((t,n)=>t?e(t,n.decode):n.decode),void 0);return{encode:n,decode:r}}function le(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&"number"!=typeof e[0])throw new Error("alphabet.encode input should be an array of numbers");return e.map((e=>{if(ce(e),e<0||e>=t.length)throw new Error(`Digit index outside alphabet: ${e} (alphabet: ${t.length})`);return t[e]}))},decode:e=>{if(!Array.isArray(e)||e.length&&"string"!=typeof e[0])throw new Error("alphabet.decode input should be array of strings");return e.map((e=>{if("string"!=typeof e)throw new Error(`alphabet.decode: not string element=${e}`);const n=t.indexOf(e);if(-1===n)throw new Error(`Unknown letter: "${e}". Allowed: ${t}`);return n}))}}}function ue(t=""){if("string"!=typeof t)throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&"string"!=typeof e[0])throw new Error("join.encode input should be array of strings");for(let t of e)if("string"!=typeof t)throw new Error(`join.encode: non-string input=${t}`);return e.join(t)},decode:e=>{if("string"!=typeof e)throw new Error("join.decode input should be string");return e.split(t)}}}function de(t,e="="){if(ce(t),"string"!=typeof e)throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&"string"!=typeof n[0])throw new Error("padding.encode input should be array of strings");for(let t of n)if("string"!=typeof t)throw new Error(`padding.encode: non-string input=${t}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&"string"!=typeof n[0])throw new Error("padding.encode input should be array of strings");for(let t of n)if("string"!=typeof t)throw new Error(`padding.decode: non-string input=${t}`);let r=n.length;if(r*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if(!((r-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function fe(t){if("function"!=typeof t)throw new Error("normalize fn should be function");return{encode:t=>t,decode:e=>t(e)}}function pe(t,e,n){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let r=0;const i=[],s=Array.from(t);for(s.forEach((t=>{if(ce(t),t<0||t>=e)throw new Error(`Wrong integer: ${t}`)}));;){let t=0,o=!0;for(let i=r;i<s.length;i++){const a=s[i],c=e*t+a;if(!Number.isSafeInteger(c)||e*t/e!==t||c-a!=e*t)throw new Error("convertRadix: carry overflow");if(t=c%n,s[i]=Math.floor(c/n),!Number.isSafeInteger(s[i])||s[i]*n+t!==c)throw new Error("convertRadix: carry overflow");o&&(s[i]?o=!1:r=i)}if(i.push(t),o)break}for(let e=0;e<t.length-1&&0===t[e];e++)i.push(0);return i.reverse()}Gt((()=>new oe));const ge=(t,e)=>e?ge(e,t%e):t,ye=(t,e)=>t+(e-ge(t,e));function we(t,e,n,r){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(ye(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${ye(e,n)}`);let i=0,s=0;const o=2**n-1,a=[];for(const r of t){if(ce(r),r>=2**e)throw new Error(`convertRadix2: invalid data word=${r} from=${e}`);if(i=i<<e|r,s+e>32)throw new Error(`convertRadix2: carry overflow pos=${s} from=${e}`);for(s+=e;s>=n;s-=n)a.push((i>>s-n&o)>>>0);i&=2**s-1}if(i=i<<n-s&o,!r&&s>=e)throw new Error("Excess padding");if(!r&&i)throw new Error(`Non-zero padding: ${i}`);return r&&s>0&&a.push(i>>>0),a}function me(t,e=!1){if(ce(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(ye(8,t)>32||ye(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return we(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&"number"!=typeof n[0])throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(we(n,t,8,e))}}}function be(t){if("function"!=typeof t)throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch(t){}}}he(me(4),le("0123456789ABCDEF"),ue("")),he(me(5),le("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),de(5),ue(""));const ve=(he(me(5),le("0123456789ABCDEFGHIJKLMNOPQRSTUV"),de(5),ue("")),he(me(5),le("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),ue(""),fe((t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")))),he(me(6),le("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),de(6),ue(""))),_e=(he(me(6),le("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),de(6),ue("")),t=>he(function(t){return ce(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return pe(Array.from(e),256,t)},decode:e=>{if(!Array.isArray(e)||e.length&&"number"!=typeof e[0])throw new Error("radix.decode input should be array of strings");return Uint8Array.from(pe(e,t,256))}}}(58),le(t),ue(""))),Ee=(_e("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),_e("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),_e("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz"),he(le("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),ue(""))),ke=[996825010,642813549,513874426,1027748829,705979059];function Ae(t){const e=t>>25;let n=(33554431&t)<<5;for(let t=0;t<ke.length;t++)1==(e>>t&1)&&(n^=ke[t]);return n}function xe(t,e,n=1){const r=t.length;let i=1;for(let e=0;e<r;e++){const n=t.charCodeAt(e);if(n<33||n>126)throw new Error(`Invalid prefix (${t})`);i=Ae(i)^n>>5}i=Ae(i);for(let e=0;e<r;e++)i=Ae(i)^31&t.charCodeAt(e);for(let t of e)i=Ae(i)^t;for(let t=0;t<6;t++)i=Ae(i);return i^=n,Ee.encode(we([i%2**30],30,5,!1))}function Re(t){const e="bech32"===t?1:734539939,n=me(5),r=n.decode,i=n.encode,s=be(r);function o(t,n=90){if("string"!=typeof t)throw new Error("bech32.decode input should be string, not "+typeof t);if(t.length<8||!1!==n&&t.length>n)throw new TypeError(`Wrong string length: ${t.length} (${t}). Expected (8..${n})`);const r=t.toLowerCase();if(t!==r&&t!==t.toUpperCase())throw new Error("String must be lowercase or uppercase");const i=(t=r).lastIndexOf("1");if(0===i||-1===i)throw new Error('Letter "1" must be present between prefix and data only');const s=t.slice(0,i),o=t.slice(i+1);if(o.length<6)throw new Error("Data must be at least 6 characters long");const a=Ee.decode(o).slice(0,-6),c=xe(s,a,e);if(!o.endsWith(c))throw new Error(`Invalid checksum in ${t}: expected "${c}"`);return{prefix:s,words:a}}return{encode:function(t,n,r=90){if("string"!=typeof t)throw new Error("bech32.encode prefix should be string, not "+typeof t);if(!Array.isArray(n)||n.length&&"number"!=typeof n[0])throw new Error("bech32.encode words should be array of numbers, not "+typeof n);const i=t.length+7+n.length;if(!1!==r&&i>r)throw new TypeError(`Length ${i} exceeds limit ${r}`);return`${t=t.toLowerCase()}1${Ee.encode(n)}${xe(t,n,e)}`},decode:o,decodeToBytes:function(t){const{prefix:e,words:n}=o(t,!1);return{prefix:e,words:n,bytes:r(n)}},decodeUnsafe:be(o),fromWords:r,fromWordsUnsafe:s,toWords:i}}const Se=Re("bech32");Re("bech32m");function Ce(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function Te(t){if("boolean"!=typeof t)throw new Error(`boolean expected, not ${t}`)}function Ie(t){return t instanceof Uint8Array||null!=t&&"object"==typeof t&&"Uint8Array"===t.constructor.name}function Ue(t,...e){if(!Ie(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function Ne(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Le(t,e){Ue(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}he(me(4),le("0123456789abcdef"),ue(""),fe((t=>{if("string"!=typeof t||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})));const Pe=t=>new Uint8Array(t.buffer,t.byteOffset,t.byteLength),Oe=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),Be=t=>new DataView(t.buffer,t.byteOffset,t.byteLength);if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function Fe(t){if("string"==typeof t)t=function(t){if("string"!=typeof t)throw new Error("string expected, got "+typeof t);return new Uint8Array((new TextEncoder).encode(t))}(t);else{if(!Ie(t))throw new Error("Uint8Array expected, got "+typeof t);t=t.slice()}return t}function ze(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return 0===n}const De=(t,e)=>(Object.assign(e,t),e);function Me(t,e,n,r){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,n,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(n>>i&s),a=Number(n&s),c=r?4:0,h=r?0:4;t.setUint32(e+c,o,r),t.setUint32(e+h,a,r)}const $e=16,Ke=new Uint8Array(16),qe=Oe(Ke),He=t=>(t>>>0&255)<<24|(t>>>8&255)<<16|(t>>>16&255)<<8|t>>>24&255;class je{constructor(t,e){this.blockLen=$e,this.outputLen=$e,this.s0=0,this.s1=0,this.s2=0,this.s3=0,this.finished=!1,Ue(t=Fe(t),16);const n=Be(t);let r=n.getUint32(0,!1),i=n.getUint32(4,!1),s=n.getUint32(8,!1),o=n.getUint32(12,!1);const a=[];for(let t=0;t<128;t++)a.push({s0:He(r),s1:He(i),s2:He(s),s3:He(o)}),({s0:r,s1:i,s2:s,s3:o}={s3:(l=s)<<31|(u=o)>>>1,s2:(h=i)<<31|l>>>1,s1:(c=r)<<31|h>>>1,s0:c>>>1^225<<24&-(1&u)});var c,h,l,u;const d=(t=>t>65536?8:t>1024?4:2)(e||1024);if(![1,2,4,8].includes(d))throw new Error(`ghash: wrong window size=${d}, should be 2, 4 or 8`);this.W=d;const f=128/d,p=this.windowSize=2**d,g=[];for(let t=0;t<f;t++)for(let e=0;e<p;e++){let n=0,r=0,i=0,s=0;for(let o=0;o<d;o++){if(!(e>>>d-o-1&1))continue;const{s0:c,s1:h,s2:l,s3:u}=a[d*t+o];n^=c,r^=h,i^=l,s^=u}g.push({s0:n,s1:r,s2:i,s3:s})}this.t=g}_updateBlock(t,e,n,r){t^=this.s0,e^=this.s1,n^=this.s2,r^=this.s3;const{W:i,t:s,windowSize:o}=this;let a=0,c=0,h=0,l=0;const u=(1<<i)-1;let d=0;for(const f of[t,e,n,r])for(let t=0;t<4;t++){const e=f>>>8*t&255;for(let t=8/i-1;t>=0;t--){const n=e>>>i*t&u,{s0:r,s1:f,s2:p,s3:g}=s[d*o+n];a^=r,c^=f,h^=p,l^=g,d+=1}}this.s0=a,this.s1=c,this.s2=h,this.s3=l}update(t){t=Fe(t),Ne(this);const e=Oe(t),n=Math.floor(t.length/$e),r=t.length%$e;for(let t=0;t<n;t++)this._updateBlock(e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]);return r&&(Ke.set(t.subarray(n*$e)),this._updateBlock(qe[0],qe[1],qe[2],qe[3]),qe.fill(0)),this}destroy(){const{t}=this;for(const e of t)e.s0=0,e.s1=0,e.s2=0,e.s3=0}digestInto(t){Ne(this),Le(t,this),this.finished=!0;const{s0:e,s1:n,s2:r,s3:i}=this,s=Oe(t);return s[0]=e,s[1]=n,s[2]=r,s[3]=i,t}digest(){const t=new Uint8Array($e);return this.digestInto(t),this.destroy(),t}}class Ve extends je{constructor(t,e){const n=function(t){t.reverse();const e=1&t[15];let n=0;for(let e=0;e<t.length;e++){const r=t[e];t[e]=r>>>1|n,n=(1&r)<<7}return t[0]^=225&-e,t}((t=Fe(t)).slice());super(n,e),n.fill(0)}update(t){t=Fe(t),Ne(this);const e=Oe(t),n=t.length%$e,r=Math.floor(t.length/$e);for(let t=0;t<r;t++)this._updateBlock(He(e[4*t+3]),He(e[4*t+2]),He(e[4*t+1]),He(e[4*t+0]));return n&&(Ke.set(t.subarray(r*$e)),this._updateBlock(He(qe[3]),He(qe[2]),He(qe[1]),He(qe[0])),qe.fill(0)),this}digestInto(t){Ne(this),Le(t,this),this.finished=!0;const{s0:e,s1:n,s2:r,s3:i}=this,s=Oe(t);return s[0]=e,s[1]=n,s[2]=r,s[3]=i,t.reverse()}}function Ze(t){const e=(e,n)=>t(n,e.length).update(Fe(e)).digest(),n=t(new Uint8Array(16),0);return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=(e,n)=>t(e,n),e}const We=Ze(((t,e)=>new je(t,e))),Ge=Ze(((t,e)=>new Ve(t,e))),Je=16,Ye=new Uint8Array(Je);function Qe(t){return t<<1^283&-(t>>7)}function Xe(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(1&e),t=Qe(t);return n}const tn=(()=>{let t=new Uint8Array(256);for(let e=0,n=1;e<256;e++,n^=Qe(n))t[e]=n;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let r=t[255-n];r|=r<<8,e[t[n]]=255&(r^r>>4^r>>5^r>>6^r>>7^99)}return e})(),en=tn.map(((t,e)=>tn.indexOf(e))),nn=t=>t<<8|t>>>24;function rn(t,e){if(256!==t.length)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map(((n,r)=>e(t[r]))),r=n.map(nn),i=r.map(nn),s=i.map(nn),o=new Uint32Array(65536),a=new Uint32Array(65536),c=new Uint16Array(65536);for(let e=0;e<256;e++)for(let h=0;h<256;h++){const l=256*e+h;o[l]=n[e]^r[h],a[l]=i[e]^s[h],c[l]=t[e]<<8|t[h]}return{sbox:t,sbox2:c,T0:n,T1:r,T2:i,T3:s,T01:o,T23:a}}const sn=rn(tn,(t=>Xe(t,3)<<24|t<<16|t<<8|Xe(t,2))),on=rn(en,(t=>Xe(t,11)<<24|Xe(t,13)<<16|Xe(t,9)<<8|Xe(t,14))),an=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=Qe(n))t[e]=n;return t})();function cn(t){Ue(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=sn,r=Oe(t),i=r.length,s=t=>un(n,t,t,t,t),o=new Uint32Array(e+28);o.set(r);for(let t=i;t<o.length;t++){let e=o[t-1];t%i==0?e=s((a=e)<<24|a>>>8)^an[t/i-1]:i>6&&t%i==4&&(e=s(e)),o[t]=o[t-i]^e}var a;return o}function hn(t){const e=cn(t),n=e.slice(),r=e.length,{sbox2:i}=sn,{T0:s,T1:o,T2:a,T3:c}=on;for(let t=0;t<r;t+=4)for(let i=0;i<4;i++)n[t+i]=e[r-t-4+i];e.fill(0);for(let t=4;t<r-4;t++){const e=n[t],r=un(i,e,e,e,e);n[t]=s[255&r]^o[r>>>8&255]^a[r>>>16&255]^c[r>>>24]}return n}function ln(t,e,n,r,i,s){return t[n<<8&65280|r>>>8&255]^e[i>>>8&65280|s>>>24&255]}function un(t,e,n,r,i){return t[255&e|65280&n]|t[r>>>16&255|i>>>16&65280]<<16}function dn(t,e,n,r,i){const{sbox2:s,T01:o,T23:a}=sn;let c=0;e^=t[c++],n^=t[c++],r^=t[c++],i^=t[c++];const h=t.length/4-2;for(let s=0;s<h;s++){const s=t[c++]^ln(o,a,e,n,r,i),h=t[c++]^ln(o,a,n,r,i,e),l=t[c++]^ln(o,a,r,i,e,n),u=t[c++]^ln(o,a,i,e,n,r);e=s,n=h,r=l,i=u}return{s0:t[c++]^un(s,e,n,r,i),s1:t[c++]^un(s,n,r,i,e),s2:t[c++]^un(s,r,i,e,n),s3:t[c++]^un(s,i,e,n,r)}}function fn(t,e,n,r,i){const{sbox2:s,T01:o,T23:a}=on;let c=0;e^=t[c++],n^=t[c++],r^=t[c++],i^=t[c++];const h=t.length/4-2;for(let s=0;s<h;s++){const s=t[c++]^ln(o,a,e,i,r,n),h=t[c++]^ln(o,a,n,e,i,r),l=t[c++]^ln(o,a,r,n,e,i),u=t[c++]^ln(o,a,i,r,n,e);e=s,n=h,r=l,i=u}return{s0:t[c++]^un(s,e,i,r,n),s1:t[c++]^un(s,n,e,i,r),s2:t[c++]^un(s,r,n,e,i),s3:t[c++]^un(s,i,r,n,e)}}function pn(t,e){if(!e)return new Uint8Array(t);if(Ue(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function gn(t,e,n,r,i){Ue(n,Je),Ue(r),i=pn(r.length,i);const s=n,o=Oe(s),a=Be(s),c=Oe(r),h=Oe(i),l=e?0:12,u=r.length;let d=a.getUint32(l,e),{s0:f,s1:p,s2:g,s3:y}=dn(t,o[0],o[1],o[2],o[3]);for(let n=0;n+4<=c.length;n+=4)h[n+0]=c[n+0]^f,h[n+1]=c[n+1]^p,h[n+2]=c[n+2]^g,h[n+3]=c[n+3]^y,d=d+1>>>0,a.setUint32(l,d,e),({s0:f,s1:p,s2:g,s3:y}=dn(t,o[0],o[1],o[2],o[3]));const w=Je*Math.floor(c.length/4);if(w<u){const t=new Uint32Array([f,p,g,y]),e=Pe(t);for(let t=w,n=0;t<u;t++,n++)i[t]=r[t]^e[n]}return i}function yn(t){if(Ue(t),t.length%Je!=0)throw new Error("aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size 16")}function wn(t,e,n){let r=t.length;const i=r%Je;if(!e&&0!==i)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const s=Oe(t);if(e){let t=Je-i;t||(t=Je),r+=t}const o=pn(r,n);return{b:s,o:Oe(o),out:o}}function mn(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=t[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const i=t.subarray(0,-r);for(let e=0;e<r;e++)if(t[n-e-1]!==r)throw new Error("aes/pcks5: wrong padding");return i}function bn(t){const e=new Uint8Array(16),n=Oe(e);e.set(t);const r=Je-t.length;for(let t=Je-r;t<Je;t++)e[t]=r;return n}De({blockSize:16,nonceLength:16},(function(t,e){function n(n,r){const i=cn(t),s=e.slice(),o=function(t,e,n,r){Ue(e,Je),Ue(n);const i=n.length;r=pn(i,r);const s=e,o=Oe(s);let{s0:a,s1:c,s2:h,s3:l}=dn(t,o[0],o[1],o[2],o[3]);const u=Oe(n),d=Oe(r);for(let e=0;e+4<=u.length;e+=4){d[e+0]=u[e+0]^a,d[e+1]=u[e+1]^c,d[e+2]=u[e+2]^h,d[e+3]=u[e+3]^l;let n=1;for(let t=s.length-1;t>=0;t--)n=n+(255&s[t])|0,s[t]=255&n,n>>>=8;({s0:a,s1:c,s2:h,s3:l}=dn(t,o[0],o[1],o[2],o[3]))}const f=Je*Math.floor(u.length/4);if(f<i){const t=new Uint32Array([a,c,h,l]),e=Pe(t);for(let t=f,s=0;t<i;t++,s++)r[t]=n[t]^e[s]}return r}(i,s,n,r);return i.fill(0),s.fill(0),o}return Ue(t),Ue(e,Je),{encrypt:(t,e)=>n(t,e),decrypt:(t,e)=>n(t,e)}})),De({blockSize:16},(function(t,e={}){Ue(t);const n=!e.disablePadding;return{encrypt:(e,r)=>{Ue(e);const{b:i,o:s,out:o}=wn(e,n,r),a=cn(t);let c=0;for(;c+4<=i.length;){const{s0:t,s1:e,s2:n,s3:r}=dn(a,i[c+0],i[c+1],i[c+2],i[c+3]);s[c++]=t,s[c++]=e,s[c++]=n,s[c++]=r}if(n){const t=bn(e.subarray(4*c)),{s0:n,s1:r,s2:i,s3:o}=dn(a,t[0],t[1],t[2],t[3]);s[c++]=n,s[c++]=r,s[c++]=i,s[c++]=o}return a.fill(0),o},decrypt:(e,r)=>{yn(e);const i=hn(t),s=pn(e.length,r),o=Oe(e),a=Oe(s);for(let t=0;t+4<=o.length;){const{s0:e,s1:n,s2:r,s3:s}=fn(i,o[t+0],o[t+1],o[t+2],o[t+3]);a[t++]=e,a[t++]=n,a[t++]=r,a[t++]=s}return i.fill(0),mn(s,n)}}}));const vn=De({blockSize:16,nonceLength:16},(function(t,e,n={}){Ue(t),Ue(e,16);const r=!n.disablePadding;return{encrypt:(n,i)=>{const s=cn(t),{b:o,o:a,out:c}=wn(n,r,i),h=Oe(e);let l=h[0],u=h[1],d=h[2],f=h[3],p=0;for(;p+4<=o.length;)l^=o[p+0],u^=o[p+1],d^=o[p+2],f^=o[p+3],({s0:l,s1:u,s2:d,s3:f}=dn(s,l,u,d,f)),a[p++]=l,a[p++]=u,a[p++]=d,a[p++]=f;if(r){const t=bn(n.subarray(4*p));l^=t[0],u^=t[1],d^=t[2],f^=t[3],({s0:l,s1:u,s2:d,s3:f}=dn(s,l,u,d,f)),a[p++]=l,a[p++]=u,a[p++]=d,a[p++]=f}return s.fill(0),c},decrypt:(n,i)=>{yn(n);const s=hn(t),o=Oe(e),a=pn(n.length,i),c=Oe(n),h=Oe(a);let l=o[0],u=o[1],d=o[2],f=o[3];for(let t=0;t+4<=c.length;){const e=l,n=u,r=d,i=f;l=c[t+0],u=c[t+1],d=c[t+2],f=c[t+3];const{s0:o,s1:a,s2:p,s3:g}=fn(s,l,u,d,f);h[t++]=o^e,h[t++]=a^n,h[t++]=p^r,h[t++]=g^i}return s.fill(0),mn(a,r)}}}));function _n(t,e,n,r,i){const s=t.create(n,r.length+(i?.length||0));i&&s.update(i),s.update(r);const o=new Uint8Array(16),a=Be(o);return i&&Me(a,0,BigInt(8*i.length),e),Me(a,8,BigInt(8*r.length),e),s.update(o),s.digest()}De({blockSize:16,nonceLength:16},(function(t,e){function n(n,r,i){const s=cn(t),o=n.length;i=pn(o,i);const a=Oe(n),c=Oe(i),h=r?c:a,l=Oe(e);let u=l[0],d=l[1],f=l[2],p=l[3];for(let t=0;t+4<=a.length;){const{s0:e,s1:n,s2:r,s3:i}=dn(s,u,d,f,p);c[t+0]=a[t+0]^e,c[t+1]=a[t+1]^n,c[t+2]=a[t+2]^r,c[t+3]=a[t+3]^i,u=h[t++],d=h[t++],f=h[t++],p=h[t++]}const g=Je*Math.floor(a.length/4);if(g<o){({s0:u,s1:d,s2:f,s3:p}=dn(s,u,d,f,p));const t=Pe(new Uint32Array([u,d,f,p]));for(let e=g,r=0;e<o;e++,r++)i[e]=n[e]^t[r];t.fill(0)}return s.fill(0),i}return Ue(t),Ue(e,16),{encrypt:(t,e)=>n(t,!0,e),decrypt:(t,e)=>n(t,!1,e)}})),De({blockSize:16,nonceLength:12,tagLength:16},(function(t,e,n){if(Ue(e),0===e.length)throw new Error("aes/gcm: empty nonce");function r(t,e,r){const i=_n(We,!1,t,r,n);for(let t=0;t<e.length;t++)i[t]^=e[t];return i}function i(){const n=cn(t),r=Ye.slice(),i=Ye.slice();if(gn(n,!1,i,i,r),12===e.length)i.set(e);else{const t=Ye.slice();Me(Be(t),8,BigInt(8*e.length),!1),We.create(r).update(e).update(t).digestInto(i)}return{xk:n,authKey:r,counter:i,tagMask:gn(n,!1,i,Ye)}}return{encrypt:t=>{Ue(t);const{xk:e,authKey:n,counter:s,tagMask:o}=i(),a=new Uint8Array(t.length+16);gn(e,!1,s,t,a);const c=r(n,o,a.subarray(0,a.length-16));return a.set(c,t.length),e.fill(0),a},decrypt:t=>{if(Ue(t),t.length<16)throw new Error("aes/gcm: ciphertext less than tagLen (16)");const{xk:e,authKey:n,counter:s,tagMask:o}=i(),a=t.subarray(0,-16),c=t.subarray(-16);if(!ze(r(n,o,a),c))throw new Error("aes/gcm: invalid ghash tag");const h=gn(e,!1,s,a);return n.fill(0),o.fill(0),e.fill(0),h}}}));const En=(t,e,n)=>r=>{if(!Number.isSafeInteger(r)||e>r||r>n)throw new Error(`${t}: invalid value=${r}, must be [${e}..${n}]`)};De({blockSize:16,nonceLength:12,tagLength:16},(function(t,e,n){const r=En("AAD",0,2**36),i=En("plaintext",0,2**36),s=En("nonce",12,12),o=En("ciphertext",16,2**36+16);function a(){const n=t.length;if(16!==n&&24!==n&&32!==n)throw new Error(`key length must be 16, 24 or 32 bytes, got: ${n} bytes`);const r=cn(t),i=new Uint8Array(n),s=new Uint8Array(16),o=Oe(e);let a=0,c=o[0],h=o[1],l=o[2],u=0;for(const t of[s,i].map(Oe)){const e=Oe(t);for(let t=0;t<e.length;t+=2){const{s0:n,s1:i}=dn(r,a,c,h,l);e[t+0]=n,e[t+1]=i,a=++u}}return r.fill(0),{authKey:s,encKey:cn(i)}}function c(t,r,i){const s=_n(Ge,!0,r,i,n);for(let t=0;t<12;t++)s[t]^=e[t];s[15]&=127;const o=Oe(s);let a=o[0],c=o[1],h=o[2],l=o[3];return({s0:a,s1:c,s2:h,s3:l}=dn(t,a,c,h,l)),o[0]=a,o[1]=c,o[2]=h,o[3]=l,s}function h(t,e,n){let r=e.slice();return r[15]|=128,gn(t,!0,r,n)}return Ue(e),s(e.length),n&&(Ue(n),r(n.length)),{encrypt:t=>{Ue(t),i(t.length);const{encKey:e,authKey:n}=a(),r=c(e,n,t),s=new Uint8Array(t.length+16);return s.set(r,t.length),s.set(h(e,r,t)),e.fill(0),n.fill(0),s},decrypt:t=>{Ue(t),o(t.length);const e=t.subarray(-16),{encKey:n,authKey:r}=a(),i=h(n,e,t.subarray(0,-16)),s=c(n,r,i);if(n.fill(0),r.fill(0),!ze(e,s))throw new Error("invalid polyval tag");return i}}}));const kn=(t,e)=>255&t[e++]|(255&t[e++])<<8;class An{constructor(t){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,Ue(t=Fe(t),32);const e=kn(t,0),n=kn(t,2),r=kn(t,4),i=kn(t,6),s=kn(t,8),o=kn(t,10),a=kn(t,12),c=kn(t,14);this.r[0]=8191&e,this.r[1]=8191&(e>>>13|n<<3),this.r[2]=7939&(n>>>10|r<<6),this.r[3]=8191&(r>>>7|i<<9),this.r[4]=255&(i>>>4|s<<12),this.r[5]=s>>>1&8190,this.r[6]=8191&(s>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127;for(let e=0;e<8;e++)this.pad[e]=kn(t,16+2*e)}process(t,e,n=!1){const r=n?0:2048,{h:i,r:s}=this,o=s[0],a=s[1],c=s[2],h=s[3],l=s[4],u=s[5],d=s[6],f=s[7],p=s[8],g=s[9],y=kn(t,e+0),w=kn(t,e+2),m=kn(t,e+4),b=kn(t,e+6),v=kn(t,e+8),_=kn(t,e+10),E=kn(t,e+12),k=kn(t,e+14);let A=i[0]+(8191&y),x=i[1]+(8191&(y>>>13|w<<3)),R=i[2]+(8191&(w>>>10|m<<6)),S=i[3]+(8191&(m>>>7|b<<9)),C=i[4]+(8191&(b>>>4|v<<12)),T=i[5]+(v>>>1&8191),I=i[6]+(8191&(v>>>14|_<<2)),U=i[7]+(8191&(_>>>11|E<<5)),N=i[8]+(8191&(E>>>8|k<<8)),L=i[9]+(k>>>5|r),P=0,O=P+A*o+x*(5*g)+R*(5*p)+S*(5*f)+C*(5*d);P=O>>>13,O&=8191,O+=T*(5*u)+I*(5*l)+U*(5*h)+N*(5*c)+L*(5*a),P+=O>>>13,O&=8191;let B=P+A*a+x*o+R*(5*g)+S*(5*p)+C*(5*f);P=B>>>13,B&=8191,B+=T*(5*d)+I*(5*u)+U*(5*l)+N*(5*h)+L*(5*c),P+=B>>>13,B&=8191;let F=P+A*c+x*a+R*o+S*(5*g)+C*(5*p);P=F>>>13,F&=8191,F+=T*(5*f)+I*(5*d)+U*(5*u)+N*(5*l)+L*(5*h),P+=F>>>13,F&=8191;let z=P+A*h+x*c+R*a+S*o+C*(5*g);P=z>>>13,z&=8191,z+=T*(5*p)+I*(5*f)+U*(5*d)+N*(5*u)+L*(5*l),P+=z>>>13,z&=8191;let D=P+A*l+x*h+R*c+S*a+C*o;P=D>>>13,D&=8191,D+=T*(5*g)+I*(5*p)+U*(5*f)+N*(5*d)+L*(5*u),P+=D>>>13,D&=8191;let M=P+A*u+x*l+R*h+S*c+C*a;P=M>>>13,M&=8191,M+=T*o+I*(5*g)+U*(5*p)+N*(5*f)+L*(5*d),P+=M>>>13,M&=8191;let $=P+A*d+x*u+R*l+S*h+C*c;P=$>>>13,$&=8191,$+=T*a+I*o+U*(5*g)+N*(5*p)+L*(5*f),P+=$>>>13,$&=8191;let K=P+A*f+x*d+R*u+S*l+C*h;P=K>>>13,K&=8191,K+=T*c+I*a+U*o+N*(5*g)+L*(5*p),P+=K>>>13,K&=8191;let q=P+A*p+x*f+R*d+S*u+C*l;P=q>>>13,q&=8191,q+=T*h+I*c+U*a+N*o+L*(5*g),P+=q>>>13,q&=8191;let H=P+A*g+x*p+R*f+S*d+C*u;P=H>>>13,H&=8191,H+=T*l+I*h+U*c+N*a+L*o,P+=H>>>13,H&=8191,P=(P<<2)+P|0,P=P+O|0,O=8191&P,P>>>=13,B+=P,i[0]=O,i[1]=B,i[2]=F,i[3]=z,i[4]=D,i[5]=M,i[6]=$,i[7]=K,i[8]=q,i[9]=H}finalize(){const{h:t,pad:e}=this,n=new Uint16Array(10);let r=t[1]>>>13;t[1]&=8191;for(let e=2;e<10;e++)t[e]+=r,r=t[e]>>>13,t[e]&=8191;t[0]+=5*r,r=t[0]>>>13,t[0]&=8191,t[1]+=r,r=t[1]>>>13,t[1]&=8191,t[2]+=r,n[0]=t[0]+5,r=n[0]>>>13,n[0]&=8191;for(let e=1;e<10;e++)n[e]=t[e]+r,r=n[e]>>>13,n[e]&=8191;n[9]-=8192;let i=(1^r)-1;for(let t=0;t<10;t++)n[t]&=i;i=~i;for(let e=0;e<10;e++)t[e]=t[e]&i|n[e];t[0]=65535&(t[0]|t[1]<<13),t[1]=65535&(t[1]>>>3|t[2]<<10),t[2]=65535&(t[2]>>>6|t[3]<<7),t[3]=65535&(t[3]>>>9|t[4]<<4),t[4]=65535&(t[4]>>>12|t[5]<<1|t[6]<<14),t[5]=65535&(t[6]>>>2|t[7]<<11),t[6]=65535&(t[7]>>>5|t[8]<<8),t[7]=65535&(t[8]>>>8|t[9]<<5);let s=t[0]+e[0];t[0]=65535&s;for(let n=1;n<8;n++)s=(t[n]+e[n]|0)+(s>>>16)|0,t[n]=65535&s}update(t){Ne(this);const{buffer:e,blockLen:n}=this,r=(t=Fe(t)).length;for(let i=0;i<r;){const s=Math.min(n-this.pos,r-i);if(s!==n)e.set(t.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===n&&(this.process(e,0,!1),this.pos=0);else for(;n<=r-i;i+=n)this.process(t,i)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(t){Ne(this),Le(t,this),this.finished=!0;const{buffer:e,h:n}=this;let{pos:r}=this;if(r){for(e[r++]=1;r<16;r++)e[r]=0;this.process(e,0,!0)}this.finalize();let i=0;for(let e=0;e<8;e++)t[i++]=n[e]>>>0,t[i++]=n[e]>>>8;return t}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const n=t.slice(0,e);return this.destroy(),n}}const xn=function(t){const e=(e,n)=>t(n).update(Fe(e)).digest(),n=t(new Uint8Array(32));return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=e=>t(e),e}((t=>new An(t))),Rn=t=>Uint8Array.from(t.split("").map((t=>t.charCodeAt(0)))),Sn=Rn("expand 16-byte k"),Cn=Rn("expand 32-byte k"),Tn=Oe(Sn),In=Oe(Cn);function Un(t,e){return t<<e|t>>>32-e}function Nn(t){return t.byteOffset%4==0}In.slice();const Ln=2**32-1,Pn=new Uint32Array;function On(t,e){const{allowShortKeys:n,extendNonceFn:r,counterLength:i,counterRight:s,rounds:o}=function(t,e){if(null==e||"object"!=typeof e)throw new Error("options must be defined");return Object.assign({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e)}(0,e);if("function"!=typeof t)throw new Error("core must be a function");return Ce(i),Ce(o),Te(s),Te(n),(e,a,c,h,l=0)=>{Ue(e),Ue(a),Ue(c);const u=c.length;if(h||(h=new Uint8Array(u)),Ue(h),Ce(l),l<0||l>=Ln)throw new Error("arx: counter overflow");if(h.length<u)throw new Error(`arx: output (${h.length}) is shorter than data (${u})`);const d=[];let f,p,g=e.length;if(32===g)f=e.slice(),d.push(f),p=In;else{if(16!==g||!n)throw new Error(`arx: invalid 32-byte key, got length=${g}`);f=new Uint8Array(32),f.set(e),f.set(e,16),p=Tn,d.push(f)}Nn(a)||(a=a.slice(),d.push(a));const y=Oe(f);if(r){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");r(p,y,Oe(a.subarray(0,16)),y),a=a.subarray(16)}const w=16-i;if(w!==a.length)throw new Error(`arx: nonce must be ${w} or 16 bytes`);if(12!==w){const t=new Uint8Array(12);t.set(a,s?0:12-a.length),a=t,d.push(a)}const m=Oe(a);for(function(t,e,n,r,i,s,o,a){const c=i.length,h=new Uint8Array(64),l=Oe(h),u=Nn(i)&&Nn(s),d=u?Oe(i):Pn,f=u?Oe(s):Pn;for(let p=0;p<c;o++){if(t(e,n,r,l,o,a),o>=Ln)throw new Error("arx: counter overflow");const g=Math.min(64,c-p);if(u&&64===g){const t=p/4;if(p%4!=0)throw new Error("arx: invalid block position");for(let e,n=0;n<16;n++)e=t+n,f[e]=d[e]^l[n];p+=64}else{for(let t,e=0;e<g;e++)t=p+e,s[t]=i[t]^h[e];p+=g}}}(t,p,y,m,c,h,l,o);d.length>0;)d.pop().fill(0);return h}}function Bn(t,e,n,r,i,s=20){let o=t[0],a=t[1],c=t[2],h=t[3],l=e[0],u=e[1],d=e[2],f=e[3],p=e[4],g=e[5],y=e[6],w=e[7],m=i,b=n[0],v=n[1],_=n[2],E=o,k=a,A=c,x=h,R=l,S=u,C=d,T=f,I=p,U=g,N=y,L=w,P=m,O=b,B=v,F=_;for(let t=0;t<s;t+=2)E=E+R|0,P=Un(P^E,16),I=I+P|0,R=Un(R^I,12),E=E+R|0,P=Un(P^E,8),I=I+P|0,R=Un(R^I,7),k=k+S|0,O=Un(O^k,16),U=U+O|0,S=Un(S^U,12),k=k+S|0,O=Un(O^k,8),U=U+O|0,S=Un(S^U,7),A=A+C|0,B=Un(B^A,16),N=N+B|0,C=Un(C^N,12),A=A+C|0,B=Un(B^A,8),N=N+B|0,C=Un(C^N,7),x=x+T|0,F=Un(F^x,16),L=L+F|0,T=Un(T^L,12),x=x+T|0,F=Un(F^x,8),L=L+F|0,T=Un(T^L,7),E=E+S|0,F=Un(F^E,16),N=N+F|0,S=Un(S^N,12),E=E+S|0,F=Un(F^E,8),N=N+F|0,S=Un(S^N,7),k=k+C|0,P=Un(P^k,16),L=L+P|0,C=Un(C^L,12),k=k+C|0,P=Un(P^k,8),L=L+P|0,C=Un(C^L,7),A=A+T|0,O=Un(O^A,16),I=I+O|0,T=Un(T^I,12),A=A+T|0,O=Un(O^A,8),I=I+O|0,T=Un(T^I,7),x=x+R|0,B=Un(B^x,16),U=U+B|0,R=Un(R^U,12),x=x+R|0,B=Un(B^x,8),U=U+B|0,R=Un(R^U,7);let z=0;r[z++]=o+E|0,r[z++]=a+k|0,r[z++]=c+A|0,r[z++]=h+x|0,r[z++]=l+R|0,r[z++]=u+S|0,r[z++]=d+C|0,r[z++]=f+T|0,r[z++]=p+I|0,r[z++]=g+U|0,r[z++]=y+N|0,r[z++]=w+L|0,r[z++]=m+P|0,r[z++]=b+O|0,r[z++]=v+B|0,r[z++]=_+F|0}const Fn=On(Bn,{counterRight:!1,counterLength:4,allowShortKeys:!1}),zn=On(Bn,{counterRight:!1,counterLength:8,extendNonceFn:function(t,e,n,r){let i=t[0],s=t[1],o=t[2],a=t[3],c=e[0],h=e[1],l=e[2],u=e[3],d=e[4],f=e[5],p=e[6],g=e[7],y=n[0],w=n[1],m=n[2],b=n[3];for(let t=0;t<20;t+=2)i=i+c|0,y=Un(y^i,16),d=d+y|0,c=Un(c^d,12),i=i+c|0,y=Un(y^i,8),d=d+y|0,c=Un(c^d,7),s=s+h|0,w=Un(w^s,16),f=f+w|0,h=Un(h^f,12),s=s+h|0,w=Un(w^s,8),f=f+w|0,h=Un(h^f,7),o=o+l|0,m=Un(m^o,16),p=p+m|0,l=Un(l^p,12),o=o+l|0,m=Un(m^o,8),p=p+m|0,l=Un(l^p,7),a=a+u|0,b=Un(b^a,16),g=g+b|0,u=Un(u^g,12),a=a+u|0,b=Un(b^a,8),g=g+b|0,u=Un(u^g,7),i=i+h|0,b=Un(b^i,16),p=p+b|0,h=Un(h^p,12),i=i+h|0,b=Un(b^i,8),p=p+b|0,h=Un(h^p,7),s=s+l|0,y=Un(y^s,16),g=g+y|0,l=Un(l^g,12),s=s+l|0,y=Un(y^s,8),g=g+y|0,l=Un(l^g,7),o=o+u|0,w=Un(w^o,16),d=d+w|0,u=Un(u^d,12),o=o+u|0,w=Un(w^o,8),d=d+w|0,u=Un(u^d,7),a=a+c|0,m=Un(m^a,16),f=f+m|0,c=Un(c^f,12),a=a+c|0,m=Un(m^a,8),f=f+m|0,c=Un(c^f,7);let v=0;r[v++]=i,r[v++]=s,r[v++]=o,r[v++]=a,r[v++]=y,r[v++]=w,r[v++]=m,r[v++]=b},allowShortKeys:!1}),Dn=new Uint8Array(16),Mn=(t,e)=>{t.update(e);const n=e.length%16;n&&t.update(Dn.subarray(n))},$n=new Uint8Array(32);function Kn(t,e,n,r,i){const s=t(e,n,$n),o=xn.create(s);i&&Mn(o,i),Mn(o,r);const a=new Uint8Array(16),c=Be(a);Me(c,0,BigInt(i?i.length:0),!0),Me(c,8,BigInt(r.length),!0),o.update(a);const h=o.digest();return s.fill(0),h}const qn=t=>(e,n,r)=>(Ue(e,32),Ue(n),{encrypt:(i,s)=>{const o=i.length,a=o+16;s?Ue(s,a):s=new Uint8Array(a),t(e,n,i,s,1);const c=Kn(t,e,n,s.subarray(0,-16),r);return s.set(c,o),s},decrypt:(i,s)=>{const o=i.length,a=o-16;if(o<16)throw new Error("encrypted data must be at least 16 bytes");s?Ue(s,a):s=new Uint8Array(a);const c=i.subarray(0,-16);if(!ze(i.subarray(-16),Kn(t,e,n,c,r)))throw new Error("invalid tag");return t(e,n,c,s,1),s}});qn(Fn),qn(zn);class Hn extends Wt{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,Xt.hash(t);const n=Vt(e);if(this.iHash=t.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,i=new Uint8Array(r);i.set(n.length>r?t.create().update(n).digest():n);for(let t=0;t<i.length;t++)i[t]^=54;this.iHash.update(i),this.oHash=t.create();for(let t=0;t<i.length;t++)i[t]^=106;this.oHash.update(i),i.fill(0)}update(t){return Xt.exists(this),this.iHash.update(t),this}digestInto(t){Xt.exists(this),Xt.bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:n,finished:r,destroyed:i,blockLen:s,outputLen:o}=this;return t.finished=r,t.destroyed=i,t.blockLen=s,t.outputLen=o,t.oHash=e._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const jn=(t,e,n)=>new Hn(t,e).update(n).digest();jn.create=(t,e)=>new Hn(t,e);const Vn=new Uint8Array([0]),Zn=new Uint8Array;var Wn=Object.defineProperty,Gn=(t,e)=>{for(var n in e)Wn(t,n,{get:e[n],enumerable:!0})},Jn=Symbol("verified");function Yn(t){if(!(t instanceof Object))return!1;if("number"!=typeof t.kind)return!1;if("string"!=typeof t.content)return!1;if("number"!=typeof t.created_at)return!1;if("string"!=typeof t.pubkey)return!1;if(!t.pubkey.match(/^[a-f0-9]{64}$/))return!1;if(!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let t=0;t<n.length;t++)if("object"==typeof n[t])return!1}return!0}Gn({},{Queue:()=>sr,QueueNode:()=>ir,binarySearch:()=>rr,insertEventIntoAscendingList:()=>nr,insertEventIntoDescendingList:()=>er,normalizeURL:()=>tr,utf8Decoder:()=>Qn,utf8Encoder:()=>Xn});var Qn=new TextDecoder("utf-8"),Xn=new TextEncoder;function tr(t){-1===t.indexOf("://")&&(t="wss://"+t);let e=new URL(t);return e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),("80"===e.port&&"ws:"===e.protocol||"443"===e.port&&"wss:"===e.protocol)&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}function er(t,e){const[n,r]=rr(t,(t=>e.id===t.id?0:e.created_at===t.created_at?-1:t.created_at-e.created_at));return r||t.splice(n,0,e),t}function nr(t,e){const[n,r]=rr(t,(t=>e.id===t.id?0:e.created_at===t.created_at?-1:e.created_at-t.created_at));return r||t.splice(n,0,e),t}function rr(t,e){let n=0,r=t.length-1;for(;n<=r;){const i=Math.floor((n+r)/2),s=e(t[i]);if(0===s)return[i,!0];s<0?r=i-1:n=i+1}return[n,!1]}var ir=class{value;next=null;prev=null;constructor(t){this.value=t}},sr=class{first;last;constructor(){this.first=null,this.last=null}enqueue(t){const e=new ir(t);return this.last?this.last===this.first?(this.last=e,this.last.prev=this.first,this.first.next=e):(e.prev=this.last,this.last.next=e,this.last=e):(this.first=e,this.last=e),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const t=this.first;return this.first=null,this.last=null,t.value}const t=this.first;return this.first=t.next,t.value}};function or(t){return Ht(ae(Xn.encode(function(t){if(!Yn(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}(t))))}var ar=new class{generateSecretKey(){return zt.utils.randomPrivateKey()}getPublicKey(t){return Ht(zt.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=Ht(zt.getPublicKey(e)),n.id=or(n),n.sig=Ht(zt.sign(or(n),e)),n[Jn]=!0,n}verifyEvent(t){if("boolean"==typeof t[Jn])return t[Jn];const e=or(t);if(e!==t.id)return t[Jn]=!1,!1;try{const n=zt.verify(t.sig,e,t.pubkey);return t[Jn]=n,n}catch(e){return t[Jn]=!1,!1}}},cr=ar.generateSecretKey,hr=ar.getPublicKey,lr=ar.finalizeEvent,ur=ar.verifyEvent;function dr(t){return 1e3<=t&&t<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(t)}function fr(t){return[0,3].includes(t)||1e4<=t&&t<2e4}function pr(t){return 2e4<=t&&t<3e4}function gr(t){return 3e4<=t&&t<4e4}function yr(t){return dr(t)?"regular":fr(t)?"replaceable":pr(t)?"ephemeral":gr(t)?"parameterized":"unknown"}function wr(t,e){const n=e instanceof Array?e:[e];return Yn(t)&&n.includes(t.kind)||!1}Gn({},{Application:()=>Ti,BadgeAward:()=>Rr,BadgeDefinition:()=>Ei,BlockedRelaysList:()=>ri,BookmarkList:()=>ti,Bookmarksets:()=>bi,Calendar:()=>Bi,CalendarEventRSVP:()=>Fi,ChannelCreation:()=>Ir,ChannelHideMessage:()=>Lr,ChannelMessage:()=>Nr,ChannelMetadata:()=>Ur,ChannelMuteUser:()=>Pr,ClassifiedListing:()=>Ni,ClientAuth:()=>ui,CommunitiesList:()=>ei,CommunityDefinition:()=>Mi,CommunityPostApproval:()=>qr,Contacts:()=>_r,CreateOrUpdateProduct:()=>xi,CreateOrUpdateStall:()=>Ai,Curationsets:()=>vi,Date:()=>Pi,DirectMessageRelaysList:()=>ai,DraftClassifiedListing:()=>Li,DraftLong:()=>Si,Emojisets:()=>Ci,EncryptedDirectMessage:()=>Er,EventDeletion:()=>kr,FileMetadata:()=>Fr,FileServerPreference:()=>ci,Followsets:()=>yi,GenericRepost:()=>Tr,Genericlists:()=>wi,GiftWrap:()=>Br,HTTPAuth:()=>gi,Handlerinformation:()=>Di,Handlerrecommendation:()=>zi,Highlights:()=>Jr,InterestsList:()=>si,Interestsets:()=>ki,JobFeedback:()=>Vr,JobRequest:()=>Hr,JobResult:()=>jr,Label:()=>Kr,LightningPubRPC:()=>li,LiveChatMessage:()=>zr,LiveEvent:()=>Ii,LongFormArticle:()=>Ri,Metadata:()=>mr,Mutelist:()=>Yr,NWCWalletInfo:()=>hi,NWCWalletRequest:()=>di,NWCWalletResponse:()=>fi,NostrConnect:()=>pi,OpenTimestamps:()=>Or,Pinlist:()=>Qr,PrivateDirectMessage:()=>Cr,ProblemTracker:()=>Dr,ProfileBadges:()=>_i,PublicChatsList:()=>ni,Reaction:()=>xr,RecommendRelay:()=>vr,RelayList:()=>Xr,Relaysets:()=>mi,Report:()=>Mr,Reporting:()=>$r,Repost:()=>Ar,Seal:()=>Sr,SearchRelaysList:()=>ii,ShortTextNote:()=>br,Time:()=>Oi,UserEmojiList:()=>oi,UserStatuses:()=>Ui,Zap:()=>Gr,ZapGoal:()=>Zr,ZapRequest:()=>Wr,classifyKind:()=>yr,isEphemeralKind:()=>pr,isKind:()=>wr,isParameterizedReplaceableKind:()=>gr,isRegularKind:()=>dr,isReplaceableKind:()=>fr});var mr=0,br=1,vr=2,_r=3,Er=4,kr=5,Ar=6,xr=7,Rr=8,Sr=13,Cr=14,Tr=16,Ir=40,Ur=41,Nr=42,Lr=43,Pr=44,Or=1040,Br=1059,Fr=1063,zr=1311,Dr=1971,Mr=1984,$r=1984,Kr=1985,qr=4550,Hr=5999,jr=6999,Vr=7e3,Zr=9041,Wr=9734,Gr=9735,Jr=9802,Yr=1e4,Qr=10001,Xr=10002,ti=10003,ei=10004,ni=10005,ri=10006,ii=10007,si=10015,oi=10030,ai=10050,ci=10096,hi=13194,li=21e3,ui=22242,di=23194,fi=23195,pi=24133,gi=27235,yi=3e4,wi=30001,mi=30002,bi=30003,vi=30004,_i=30008,Ei=30009,ki=30015,Ai=30017,xi=30018,Ri=30023,Si=30024,Ci=30030,Ti=30078,Ii=30311,Ui=30315,Ni=30402,Li=30403,Pi=31922,Oi=31923,Bi=31924,Fi=31925,zi=31989,Di=31990,Mi=34550;function $i(t,e){if(t.ids&&-1===t.ids.indexOf(e.id))return!1;if(t.kinds&&-1===t.kinds.indexOf(e.kind))return!1;if(t.authors&&-1===t.authors.indexOf(e.pubkey))return!1;for(let n in t)if("#"===n[0]){let r=t[`#${n.slice(1)}`];if(r&&!e.tags.find((([t,e])=>t===n.slice(1)&&-1!==r.indexOf(e))))return!1}return!(t.since&&e.created_at<t.since||t.until&&e.created_at>t.until)}function Ki(t,e){for(let n=0;n<t.length;n++)if($i(t[n],e))return!0;return!1}function qi(t,e){let n=e.length+3,r=t.indexOf(`"${e}":`)+n,i=t.slice(r).indexOf('"')+r+1;return t.slice(i,i+64)}function Hi(t,e){let n=e.length,r=t.indexOf(`"${e}":`)+n+3,i=t.slice(r),s=Math.min(i.indexOf(","),i.indexOf("}"));return parseInt(i.slice(0,s),10)}function ji(t){let e=t.slice(0,22).indexOf('"EVENT"');if(-1===e)return null;let n=t.slice(e+7+1).indexOf('"');if(-1===n)return null;let r=e+7+1+n,i=t.slice(r+1,80).indexOf('"');if(-1===i)return null;let s=r+1+i;return t.slice(r+1,s)}function Vi(t,e){return e===qi(t,"id")}function Zi(t,e){return e===qi(t,"pubkey")}function Wi(t,e){return e===Hi(t,"kind")}function Gi(t,e){return{kind:ui,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}Gn({},{getHex64:()=>qi,getInt:()=>Hi,getSubscriptionId:()=>ji,matchEventId:()=>Vi,matchEventKind:()=>Wi,matchEventPubkey:()=>Zi}),Gn({},{makeAuthEvent:()=>Gi});try{WebSocket}catch{}try{WebSocket}catch{}var Ji={};Gn(Ji,{BECH32_REGEX:()=>Xi,Bech32MaxSize:()=>Qi,NostrTypeGuard:()=>Yi,decode:()=>ts,encodeBytes:()=>os,naddrEncode:()=>hs,neventEncode:()=>cs,noteEncode:()=>is,nprofileEncode:()=>as,npubEncode:()=>rs,nsecEncode:()=>ns});var Yi={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Qi=5e3,Xi=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function ts(t){let{prefix:e,words:n}=Se.decode(t,Qi),r=new Uint8Array(Se.fromWords(n));switch(e){case"nprofile":{let t=es(r);if(!t[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(32!==t[0][0].length)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:Ht(t[0][0]),relays:t[1]?t[1].map((t=>Qn.decode(t))):[]}}}case"nevent":{let t=es(r);if(!t[0]?.[0])throw new Error("missing TLV 0 for nevent");if(32!==t[0][0].length)throw new Error("TLV 0 should be 32 bytes");if(t[2]&&32!==t[2][0].length)throw new Error("TLV 2 should be 32 bytes");if(t[3]&&4!==t[3][0].length)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:Ht(t[0][0]),relays:t[1]?t[1].map((t=>Qn.decode(t))):[],author:t[2]?.[0]?Ht(t[2][0]):void 0,kind:t[3]?.[0]?parseInt(Ht(t[3][0]),16):void 0}}}case"naddr":{let t=es(r);if(!t[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!t[2]?.[0])throw new Error("missing TLV 2 for naddr");if(32!==t[2][0].length)throw new Error("TLV 2 should be 32 bytes");if(!t[3]?.[0])throw new Error("missing TLV 3 for naddr");if(4!==t[3][0].length)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:Qn.decode(t[0][0]),pubkey:Ht(t[2][0]),kind:parseInt(Ht(t[3][0]),16),relays:t[1]?t[1].map((t=>Qn.decode(t))):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:Ht(r)};default:throw new Error(`unknown prefix ${e}`)}}function es(t){let e={},n=t;for(;n.length>0;){let t=n[0],r=n[1],i=n.slice(2,2+r);if(n=n.slice(2+r),i.length<r)throw new Error(`not enough data to read on TLV ${t}`);e[t]=e[t]||[],e[t].push(i)}return e}function ns(t){return os("nsec",t)}function rs(t){return os("npub",jt(t))}function is(t){return os("note",jt(t))}function ss(t,e){let n=Se.toWords(e);return Se.encode(t,n,Qi)}function os(t,e){return ss(t,e)}function as(t){return ss("nprofile",ls({0:[jt(t.pubkey)],1:(t.relays||[]).map((t=>Xn.encode(t)))}))}function cs(t){let e;return void 0!==t.kind&&(e=function(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=255&t,e}(t.kind)),ss("nevent",ls({0:[jt(t.id)],1:(t.relays||[]).map((t=>Xn.encode(t))),2:t.author?[jt(t.author)]:[],3:e?[new Uint8Array(e)]:[]}))}function hs(t){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,t.kind,!1),ss("naddr",ls({0:[Xn.encode(t.identifier)],1:(t.relays||[]).map((t=>Xn.encode(t))),2:[jt(t.pubkey)],3:[new Uint8Array(e)]}))}function ls(t){let e=[];return Object.entries(t).reverse().forEach((([t,n])=>{n.forEach((n=>{let r=new Uint8Array(n.length+2);r.set([parseInt(t)],0),r.set([n.length],1),r.set(n,2),e.push(r)}))})),Zt(...e)}var us={};async function ds(t,e,n){const r=t instanceof Uint8Array?Ht(t):t,i=ps(Et.getSharedSecret(r,"02"+e));let s=Uint8Array.from(Jt(16)),o=Xn.encode(n),a=vn(i,s).encrypt(o);return`${ve.encode(new Uint8Array(a))}?iv=${ve.encode(new Uint8Array(s.buffer))}`}async function fs(t,e,n){const r=t instanceof Uint8Array?Ht(t):t;let[i,s]=n.split("?iv="),o=ps(Et.getSharedSecret(r,"02"+e)),a=ve.decode(s),c=ve.decode(i),h=vn(o,a).decrypt(c);return Qn.decode(h)}function ps(t){return t.slice(1,33)}Gn(us,{decrypt:()=>fs,encrypt:()=>ds}),Gn({},{NIP05_REGEX:()=>ys,isNip05:()=>ws,isValid:()=>_s,queryProfile:()=>vs,searchDomain:()=>bs,useFetchImplementation:()=>ms});var gs,ys=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,ws=t=>ys.test(t||"");try{gs=fetch}catch(t){}function ms(t){gs=t}async function bs(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`,r=await gs(n,{redirect:"manual"});if(200!==r.status)throw Error("Wrong response code");return(await r.json()).names}catch(t){return{}}}async function vs(t){const e=t.match(ys);if(!e)return null;const[,n="_",r]=e;try{const t=`https://${r}/.well-known/nostr.json?name=${n}`,e=await gs(t,{redirect:"manual"});if(200!==e.status)throw Error("Wrong response code");const i=await e.json(),s=i.names[n];return s?{pubkey:s,relays:i.relays?.[s]}:null}catch(t){return null}}async function _s(t,e){const n=await vs(e);return!!n&&n.pubkey===t}function Es(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let n,r;for(let i=t.tags.length-1;i>=0;i--){const s=t.tags[i];if("e"===s[0]&&s[1]){const[t,i,o,a,c]=s,h={id:i,relays:o?[o]:[],author:c};if("root"===a){e.root=h;continue}if("reply"===a){e.reply=h;continue}if("mention"===a){e.mentions.push(h);continue}n?r=h:n=h,e.mentions.push(h)}else{if("q"===s[0]&&s[1]){const[t,n,r]=s;e.quotes.push({id:n,relays:r?[r]:[]})}"p"===s[0]&&s[1]&&e.profiles.push({pubkey:s[1],relays:s[2]?[s[2]]:[]})}}return e.root||(e.root=r||n||e.reply),e.reply||(e.reply=n||e.root),[e.reply,e.root].forEach((t=>{if(!t)return;let n=e.mentions.indexOf(t);if(-1!==n&&e.mentions.splice(n,1),t.author){let n=e.profiles.find((e=>e.pubkey===t.author));n&&n.relays&&(t.relays||(t.relays=[]),n.relays.forEach((e=>{-1===t.relays?.indexOf(e)&&t.relays.push(e)})),n.relays=t.relays)}})),e.mentions.forEach((t=>{if(t.author){let n=e.profiles.find((e=>e.pubkey===t.author));n&&n.relays&&(t.relays||(t.relays=[]),n.relays.forEach((e=>{-1===t.relays.indexOf(e)&&t.relays.push(e)})),n.relays=t.relays)}})),e}Gn({},{parse:()=>Es}),Gn({},{fetchRelayInformation:()=>As,useFetchImplementation:()=>ks});try{fetch}catch{}function ks(t){}async function As(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}function xs(t){let e=0;for(let n=0;n<64;n+=8){const r=parseInt(t.substring(n,n+8),16);if(0!==r){e+=Math.clz32(r);break}e+=32}return e}function Rs(t,e){let n=0;const r=t,i=["nonce",n.toString(),e.toString()];for(r.tags.push(i);;){const t=Math.floor((new Date).getTime()/1e3);if(t!==r.created_at&&(n=0,r.created_at=t),i[1]=(++n).toString(),r.id=Ss(r),xs(r.id)>=e)break}return r}function Ss(t){return Ht(ae(Xn.encode(JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]))))}function Cs(t,e,n,r){return lr({kind:Ar,tags:[...t.tags??[],["e",e.id,n],["p",e.pubkey]],content:""===t.content?"":JSON.stringify(e),created_at:t.created_at},r)}function Ts(t){if(t.kind!==Ar)return;let e,n;for(let r=t.tags.length-1;r>=0&&(void 0===e||void 0===n);r--){const i=t.tags[r];i.length>=2&&("e"===i[0]&&void 0===e?e=i:"p"===i[0]&&void 0===n&&(n=i))}return void 0!==e?{id:e[1],relays:[e[2],n?.[2]].filter((t=>"string"==typeof t)),author:n?.[1]}:void 0}function Is(t,{skipVerification:e}={}){const n=Ts(t);if(void 0===n||""===t.content)return;let r;try{r=JSON.parse(t.content)}catch(t){return}return r.id===n.id&&(e||ur(r))?r:void 0}Gn({},{fastEventHash:()=>Ss,getPow:()=>xs,minePow:()=>Rs}),Gn({},{finishRepostEvent:()=>Cs,getRepostedEvent:()=>Is,getRepostedEventPointer:()=>Ts}),Gn({},{NOSTR_URI_REGEX:()=>Us,parse:()=>Ls,test:()=>Ns});var Us=new RegExp(`nostr:(${Xi.source})`);function Ns(t){return"string"==typeof t&&new RegExp(`^${Us.source}$`).test(t)}function Ls(t){const e=t.match(new RegExp(`^${Us.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:ts(e[1])}}function Ps(t,e,n){const r=e.tags.filter((t=>t.length>=2&&("e"===t[0]||"p"===t[0])));return lr({...t,kind:xr,tags:[...t.tags??[],...r,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function Os(t){if(t.kind!==xr)return;let e,n;for(let r=t.tags.length-1;r>=0&&(void 0===e||void 0===n);r--){const i=t.tags[r];i.length>=2&&("e"===i[0]&&void 0===e?e=i:"p"===i[0]&&void 0===n&&(n=i))}return void 0!==e&&void 0!==n?{id:e[1],relays:[e[2],n[2]].filter((t=>void 0!==t)),author:n[1]}:void 0}Gn({},{finishReactionEvent:()=>Ps,getReactedEventPointer:()=>Os}),Gn({},{matchAll:()=>Fs,regex:()=>Bs,replaceAll:()=>zs});var Bs=()=>new RegExp(`\\b${Us.source}\\b`,"g");function*Fs(t){const e=t.matchAll(Bs());for(const t of e)try{const[e,n]=t;yield{uri:e,value:n,decoded:ts(n),start:t.index,end:t.index+e.length}}catch(t){}}function zs(t,e){return t.replaceAll(Bs(),((t,n)=>e({uri:t,value:n,decoded:ts(n)})))}Gn({},{channelCreateEvent:()=>Ds,channelHideMessageEvent:()=>Ks,channelMessageEvent:()=>$s,channelMetadataEvent:()=>Ms,channelMuteUserEvent:()=>qs});var Ds=(t,e)=>{let n;if("object"==typeof t.content)n=JSON.stringify(t.content);else{if("string"!=typeof t.content)return;n=t.content}return lr({kind:Ir,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},Ms=(t,e)=>{let n;if("object"==typeof t.content)n=JSON.stringify(t.content);else{if("string"!=typeof t.content)return;n=t.content}return lr({kind:Ur,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},$s=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),lr({kind:Nr,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},Ks=(t,e)=>{let n;if("object"==typeof t.content)n=JSON.stringify(t.content);else{if("string"!=typeof t.content)return;n=t.content}return lr({kind:Lr,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},qs=(t,e)=>{let n;if("object"==typeof t.content)n=JSON.stringify(t.content);else{if("string"!=typeof t.content)return;n=t.content}return lr({kind:Pr,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)};Gn({},{EMOJI_SHORTCODE_REGEX:()=>js,matchAll:()=>Zs,regex:()=>Vs,replaceAll:()=>Ws});var Hs,js=/:(\w+):/,Vs=()=>new RegExp(`\\B${js.source}\\B`,"g");function*Zs(t){const e=t.matchAll(Vs());for(const t of e)try{const[e,n]=t;yield{shortcode:e,name:n,start:t.index,end:t.index+e.length}}catch(t){}}function Ws(t,e){return t.replaceAll(Vs(),((t,n)=>e({shortcode:t,name:n})))}Gn({},{useFetchImplementation:()=>Gs,validateGithub:()=>Js});try{Hs=fetch}catch{}function Gs(t){Hs=t}async function Js(t,e,n){try{return await(await Hs(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch(t){return!1}}var Ys={};Gn(Ys,{decrypt:()=>so,encrypt:()=>io,getConversationKey:()=>to,v2:()=>oo});var Qs=1,Xs=65535;function to(t,e){const n=Et.getSharedSecret(t,"02"+e).subarray(1,33);return r=ae,i=n,s="nip44-v2",Xt.hash(r),void 0===s&&(s=new Uint8Array(r.outputLen)),jn(r,Vt(s),Vt(i));var r,i,s}function eo(t,e){const n=function(t,e,n,r=32){if(Xt.hash(t),Xt.number(r),r>255*t.outputLen)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(r/t.outputLen);void 0===n&&(n=Zn);const s=new Uint8Array(i*t.outputLen),o=jn.create(t,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let e=0;e<i;e++)Vn[0]=e+1,a.update(0===e?Zn:c).update(n).update(Vn).digestInto(c),s.set(c,t.outputLen*e),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),Vn.fill(0),s.slice(0,r)}(ae,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function no(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function ro(t,e,n){if(32!==n.length)throw new Error("AAD associated data must be 32 bytes");const r=Zt(n,e);return jn(ae,t,r)}function io(t,e,n=Jt(32)){const{chacha_key:r,chacha_nonce:i,hmac_key:s}=eo(e,n),o=function(t){const e=Xn.encode(t),n=e.length,r=function(t){if(!Number.isSafeInteger(t)||t<Qs||t>Xs)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}(n);return Zt(r,e,new Uint8Array(no(n)-n))}(t),a=Fn(r,i,o),c=ro(s,a,n);return ve.encode(Zt(new Uint8Array([2]),n,a,c))}function so(t,e){const{nonce:n,ciphertext:r,mac:i}=function(t){if("string"!=typeof t)throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if("#"===t[0])throw new Error("unknown encryption version");let n;try{n=ve.decode(t)}catch(t){throw new Error("invalid base64: "+t.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const i=n[0];if(2!==i)throw new Error("unknown encryption version "+i);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}(t),{chacha_key:s,chacha_nonce:o,hmac_key:a}=eo(e,n);if(!ze(ro(a,r,n),i))throw new Error("invalid MAC");return function(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<Qs||e>Xs||n.length!==e||t.length!==2+no(e))throw new Error("invalid padding");return Qn.decode(n)}(Fn(s,o,r))}var oo={utils:{getConversationKey:to,calcPaddedLen:no},encrypt:io,decrypt:so};function ao(t){const{pathname:e,searchParams:n}=new URL(t),r=e,i=n.get("relay"),s=n.get("secret");if(!r||!i||!s)throw new Error("invalid connection string");return{pubkey:r,relay:i,secret:s}}async function co(t,e,n){const r={method:"pay_invoice",params:{invoice:n}},i=await ds(e,t,JSON.stringify(r)),s={kind:di,created_at:Math.round(Date.now()/1e3),content:i,tags:[["p",t]]};return lr(s,e)}Gn({},{makeNwcRequestEvent:()=>co,parseConnectionString:()=>ao});var ho;Gn({},{getZapEndpoint:()=>uo,makeZapReceipt:()=>go,makeZapRequest:()=>fo,useFetchImplementation:()=>lo,validateZapRequest:()=>po});try{ho=fetch}catch{}function lo(t){ho=t}async function uo(t){try{let e="",{lud06:n,lud16:r}=JSON.parse(t.content);if(n){let{words:t}=Se.decode(n,1e3),r=Se.fromWords(t);e=Qn.decode(r)}else{if(!r)return null;{let[t,n]=r.split("@");e=new URL(`/.well-known/lnurlp/${t}`,`https://${n}`).toString()}}let i=await ho(e),s=await i.json();if(s.allowsNostr&&s.nostrPubkey)return s.callback}catch(t){}return null}function fo({profile:t,event:e,amount:n,relays:r,comment:i=""}){if(!n)throw new Error("amount not given");if(!t)throw new Error("profile not given");let s={kind:9734,created_at:Math.round(Date.now()/1e3),content:i,tags:[["p",t],["amount",n.toString()],["relays",...r]]};return e&&s.tags.push(["e",e]),s}function po(t){let e;try{e=JSON.parse(t)}catch(t){return"Invalid zap request JSON."}if(!Yn(e))return"Zap request is not a valid Nostr event.";if(!ur(e))return"Invalid signature on zap request.";let n=e.tags.find((([t,e])=>"p"===t&&e));if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=e.tags.find((([t,e])=>"e"===t&&e));return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find((([t,e])=>"relays"===t&&e))?null:"Zap request doesn't have a 'relays' tag."}function go({zapRequest:t,preimage:e,bolt11:n,paidAt:r}){let i=JSON.parse(t),s=i.tags.filter((([t])=>"e"===t||"p"===t||"a"===t)),o={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...s,["P",i.pubkey],["bolt11",n],["description",t]]};return e&&o.tags.push(["preimage",e]),o}Gn({},{createRumor:()=>_o,createSeal:()=>Eo,createWrap:()=>ko,unwrapEvent:()=>Ro,unwrapManyEvents:()=>So,wrapEvent:()=>Ao,wrapManyEvents:()=>xo});var yo=()=>Math.round(Date.now()/1e3),wo=()=>Math.round(yo()-172800*Math.random()),mo=(t,e)=>to(t,e),bo=(t,e,n)=>io(JSON.stringify(t),mo(e,n)),vo=(t,e)=>JSON.parse(so(t.content,mo(e,t.pubkey)));function _o(t,e){const n={created_at:yo(),content:"",tags:[],...t,pubkey:hr(e)};return n.id=or(n),n}function Eo(t,e,n){return lr({kind:Sr,content:bo(t,e,n),created_at:wo(),tags:[]},e)}function ko(t,e){const n=cr();return lr({kind:Br,content:bo(t,n,e),created_at:wo(),tags:[["p",e]]},n)}function Ao(t,e,n){return ko(Eo(_o(t,e),e,n),n)}function xo(t,e,n){if(!n||0===n.length)throw new Error("At least one recipient is required.");const r=hr(e),i=[Ao(t,e,r)];return n.forEach((n=>{i.push(Ao(t,e,n))})),i}function Ro(t,e){const n=vo(t,e);return vo(n,e)}function So(t,e){let n=[];return t.forEach((t=>{n.push(Ro(t,e))})),n.sort(((t,e)=>t.created_at-e.created_at)),n}Gn({},{getToken:()=>To,hashPayload:()=>Bo,unpackEventFromToken:()=>Uo,validateEvent:()=>zo,validateEventKind:()=>Lo,validateEventMethodTag:()=>Oo,validateEventPayloadTag:()=>Fo,validateEventTimestamp:()=>No,validateEventUrlTag:()=>Po,validateToken:()=>Io});var Co="Nostr ";async function To(t,e,n,r=!1,i){const s={kind:gi,tags:[["u",t],["method",e]],created_at:Math.round((new Date).getTime()/1e3),content:""};i&&s.tags.push(["payload",Bo(i)]);const o=await n(s);return(r?Co:"")+ve.encode(Xn.encode(JSON.stringify(o)))}async function Io(t,e,n){const r=await Uo(t).catch((t=>{throw t}));return await zo(r,e,n).catch((t=>{throw t}))}async function Uo(t){if(!t)throw new Error("Missing token");t=t.replace(Co,"");const e=Qn.decode(ve.decode(t));if(!e||0===e.length||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function No(t){return!!t.created_at&&Math.round((new Date).getTime()/1e3)-t.created_at<60}function Lo(t){return t.kind===gi}function Po(t,e){const n=t.tags.find((t=>"u"===t[0]));return!!n&&n.length>0&&n[1]===e}function Oo(t,e){const n=t.tags.find((t=>"method"===t[0]));return!!n&&n.length>0&&n[1].toLowerCase()===e.toLowerCase()}function Bo(t){return Ht(ae(Xn.encode(JSON.stringify(t))))}function Fo(t,e){const n=t.tags.find((t=>"payload"===t[0]));if(!n)return!1;const r=Bo(e);return n.length>0&&n[1]===r}async function zo(t,e,n,r){if(!ur(t))throw new Error("Invalid nostr event, signature invalid");if(!Lo(t))throw new Error("Invalid nostr event, kind invalid");if(!No(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!Po(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!Oo(t,n))throw new Error("Invalid nostr event, method tag invalid");if(Boolean(r)&&"object"==typeof r&&Object.keys(r).length>0&&!Fo(t,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}function Do(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function Mo(t,...e){if(!((n=t)instanceof Uint8Array||ArrayBuffer.isView(n)&&"Uint8Array"===n.constructor.name))throw new Error("Uint8Array expected");var n;if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function $o(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}const Ko="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0,qo=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),Ho=(t,e)=>t<<32-e|t>>>e,jo=Array.from({length:256},((t,e)=>e.toString(16).padStart(2,"0")));function Vo(t){Mo(t);let e="";for(let n=0;n<t.length;n++)e+=jo[t[n]];return e}function Zo(t){return t>=48&&t<=57?t-48:t>=65&&t<=70?t-55:t>=97&&t<=102?t-87:void 0}function Wo(t){return"string"==typeof t&&(t=function(t){if("string"!=typeof t)throw new Error("utf8ToBytes expected string, got "+typeof t);return new Uint8Array((new TextEncoder).encode(t))}(t)),Mo(t),t}class Go{clone(){return this._cloneInto()}}function Jo(t){const e=e=>t().update(Wo(e)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function Yo(t=32){if(Ko&&"function"==typeof Ko.getRandomValues)return Ko.getRandomValues(new Uint8Array(t));if(Ko&&"function"==typeof Ko.randomBytes)return Ko.randomBytes(t);throw new Error("crypto.getRandomValues must be defined")}const Qo=(t,e,n)=>t&e^t&n^e&n;class Xo extends Go{constructor(t,e,n,r){super(),this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=qo(this.buffer)}update(t){$o(this);const{view:e,buffer:n,blockLen:r}=this,i=(t=Wo(t)).length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o!==r)n.set(t.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(e,0),this.pos=0);else{const e=qo(t);for(;r<=i-s;s+=r)this.process(e,s)}}return this.length+=t.length,this.roundClean(),this}digestInto(t){$o(this),function(t,e){Mo(t);const n=e.outputLen;if(t.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}(t,this),this.finished=!0;const{buffer:e,view:n,blockLen:r,isLE:i}=this;let{pos:s}=this;e[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>r-s&&(this.process(n,0),s=0);for(let t=s;t<r;t++)e[t]=0;!function(t,e,n,r){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,n,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(n>>i&s),a=Number(n&s),c=r?4:0,h=r?0:4;t.setUint32(e+c,o,r),t.setUint32(e+h,a,r)}(n,r-8,BigInt(8*this.length),i),this.process(n,0);const o=qo(t),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const c=a/4,h=this.get();if(c>h.length)throw new Error("_sha2: outputLen bigger than state");for(let t=0;t<c;t++)o.setUint32(4*t,h[t],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:n,length:r,finished:i,destroyed:s,pos:o}=this;return t.length=r,t.pos=o,t.finished=i,t.destroyed=s,r%e&&t.buffer.set(n),t}}const ta=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ea=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),na=new Uint32Array(64);class ra extends Xo{constructor(){super(64,32,8,!1),this.A=0|ea[0],this.B=0|ea[1],this.C=0|ea[2],this.D=0|ea[3],this.E=0|ea[4],this.F=0|ea[5],this.G=0|ea[6],this.H=0|ea[7]}get(){const{A:t,B:e,C:n,D:r,E:i,F:s,G:o,H:a}=this;return[t,e,n,r,i,s,o,a]}set(t,e,n,r,i,s,o,a){this.A=0|t,this.B=0|e,this.C=0|n,this.D=0|r,this.E=0|i,this.F=0|s,this.G=0|o,this.H=0|a}process(t,e){for(let n=0;n<16;n++,e+=4)na[n]=t.getUint32(e,!1);for(let t=16;t<64;t++){const e=na[t-15],n=na[t-2],r=Ho(e,7)^Ho(e,18)^e>>>3,i=Ho(n,17)^Ho(n,19)^n>>>10;na[t]=i+na[t-7]+r+na[t-16]|0}let{A:n,B:r,C:i,D:s,E:o,F:a,G:c,H:h}=this;for(let t=0;t<64;t++){const e=h+(Ho(o,6)^Ho(o,11)^Ho(o,25))+((l=o)&a^~l&c)+ta[t]+na[t]|0,u=(Ho(n,2)^Ho(n,13)^Ho(n,22))+Qo(n,r,i)|0;h=c,c=a,a=o,o=s+e|0,s=i,i=r,r=n,n=e+u|0}var l;n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,h=h+this.H|0,this.set(n,r,i,s,o,a,c,h)}roundClean(){na.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const ia=Jo((()=>new ra));class sa extends Go{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,function(t){if("function"!=typeof t||"function"!=typeof t.create)throw new Error("Hash should be wrapped by utils.wrapConstructor");Do(t.outputLen),Do(t.blockLen)}(t);const n=Wo(e);if(this.iHash=t.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,i=new Uint8Array(r);i.set(n.length>r?t.create().update(n).digest():n);for(let t=0;t<i.length;t++)i[t]^=54;this.iHash.update(i),this.oHash=t.create();for(let t=0;t<i.length;t++)i[t]^=106;this.oHash.update(i),i.fill(0)}update(t){return $o(this),this.iHash.update(t),this}digestInto(t){$o(this),Mo(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:n,finished:r,destroyed:i,blockLen:s,outputLen:o}=this;return t.finished=r,t.destroyed=i,t.blockLen=s,t.outputLen=o,t.oHash=e._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const oa=(t,e,n)=>new sa(t,e).update(n).digest();oa.create=(t,e)=>new sa(t,e);const aa=BigInt(0),ca=BigInt(1),ha=BigInt(2);function la(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&"Uint8Array"===t.constructor.name}function ua(t){if(!la(t))throw new Error("Uint8Array expected")}function da(t,e){if("boolean"!=typeof e)throw new Error(t+" boolean expected, got "+e)}const fa=Array.from({length:256},((t,e)=>e.toString(16).padStart(2,"0")));function pa(t){ua(t);let e="";for(let n=0;n<t.length;n++)e+=fa[t[n]];return e}function ga(t){const e=t.toString(16);return 1&e.length?"0"+e:e}function ya(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);return""===t?aa:BigInt("0x"+t)}const wa={_0:48,_9:57,A:65,F:70,a:97,f:102};function ma(t){return t>=wa._0&&t<=wa._9?t-wa._0:t>=wa.A&&t<=wa.F?t-(wa.A-10):t>=wa.a&&t<=wa.f?t-(wa.a-10):void 0}function ba(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let e=0,i=0;e<n;e++,i+=2){const n=ma(t.charCodeAt(i)),s=ma(t.charCodeAt(i+1));if(void 0===n||void 0===s){const e=t[i]+t[i+1];throw new Error('hex string expected, got non-hex character "'+e+'" at index '+i)}r[e]=16*n+s}return r}function va(t){return ya(pa(t))}function _a(t){return ua(t),ya(pa(Uint8Array.from(t).reverse()))}function Ea(t,e){return ba(t.toString(16).padStart(2*e,"0"))}function ka(t,e){return Ea(t,e).reverse()}function Aa(t,e,n){let r;if("string"==typeof e)try{r=ba(e)}catch(e){throw new Error(t+" must be hex string or Uint8Array, cause: "+e)}else{if(!la(e))throw new Error(t+" must be hex string or Uint8Array");r=Uint8Array.from(e)}const i=r.length;if("number"==typeof n&&i!==n)throw new Error(t+" of length "+n+" expected, got "+i);return r}function xa(...t){let e=0;for(let n=0;n<t.length;n++){const r=t[n];ua(r),e+=r.length}const n=new Uint8Array(e);for(let e=0,r=0;e<t.length;e++){const i=t[e];n.set(i,r),r+=i.length}return n}const Ra=t=>"bigint"==typeof t&&aa<=t;function Sa(t,e,n){return Ra(t)&&Ra(e)&&Ra(n)&&e<=t&&t<n}function Ca(t,e,n,r){if(!Sa(e,n,r))throw new Error("expected valid "+t+": "+n+" <= n < "+r+", got "+e)}function Ta(t){let e;for(e=0;t>aa;t>>=ca,e+=1);return e}const Ia=t=>(ha<<BigInt(t-1))-ca,Ua=t=>new Uint8Array(t),Na=t=>Uint8Array.from(t);function La(t,e,n){if("number"!=typeof t||t<2)throw new Error("hashLen must be a number");if("number"!=typeof e||e<2)throw new Error("qByteLen must be a number");if("function"!=typeof n)throw new Error("hmacFn must be a function");let r=Ua(t),i=Ua(t),s=0;const o=()=>{r.fill(1),i.fill(0),s=0},a=(...t)=>n(i,r,...t),c=(t=Ua())=>{i=a(Na([0]),t),r=a(),0!==t.length&&(i=a(Na([1]),t),r=a())},h=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let t=0;const n=[];for(;t<e;){r=a();const e=r.slice();n.push(e),t+=r.length}return xa(...n)};return(t,e)=>{let n;for(o(),c(t);!(n=e(h()));)c();return o(),n}}const Pa={bigint:t=>"bigint"==typeof t,function:t=>"function"==typeof t,boolean:t=>"boolean"==typeof t,string:t=>"string"==typeof t,stringOrUint8Array:t=>"string"==typeof t||la(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>"function"==typeof t&&Number.isSafeInteger(t.outputLen)};function Oa(t,e,n={}){const r=(e,n,r)=>{const i=Pa[n];if("function"!=typeof i)throw new Error("invalid validator function");const s=t[e];if(!(r&&void 0===s||i(s,t)))throw new Error("param "+String(e)+" is invalid. Expected "+n+", got "+s)};for(const[t,n]of Object.entries(e))r(t,n,!1);for(const[t,e]of Object.entries(n))r(t,e,!0);return t}function Ba(t){const e=new WeakMap;return(n,...r)=>{const i=e.get(n);if(void 0!==i)return i;const s=t(n,...r);return e.set(n,s),s}}const Fa=BigInt(0),za=BigInt(1),Da=BigInt(2),Ma=BigInt(3),$a=BigInt(4),Ka=BigInt(5),qa=BigInt(8);function Ha(t,e){const n=t%e;return n>=Fa?n:e+n}function ja(t,e,n){if(e<Fa)throw new Error("invalid exponent, negatives unsupported");if(n<=Fa)throw new Error("invalid modulus");if(n===za)return Fa;let r=za;for(;e>Fa;)e&za&&(r=r*t%n),t=t*t%n,e>>=za;return r}function Va(t,e,n){let r=t;for(;e-- >Fa;)r*=r,r%=n;return r}function Za(t,e){if(t===Fa)throw new Error("invert: expected non-zero number");if(e<=Fa)throw new Error("invert: expected positive modulus, got "+e);let n=Ha(t,e),r=e,i=Fa,s=za,o=za,a=Fa;for(;n!==Fa;){const t=r/n,e=r%n,c=i-o*t,h=s-a*t;r=n,n=e,i=o,s=a,o=c,a=h}if(r!==za)throw new Error("invert: does not exist");return Ha(i,e)}const Wa=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Ga(t,e){const n=void 0!==e?e:t.toString(2).length;return{nBitLength:n,nByteLength:Math.ceil(n/8)}}function Ja(t,e,n=!1,r={}){if(t<=Fa)throw new Error("invalid field: expected ORDER > 0, got "+t);const{nBitLength:i,nByteLength:s}=Ga(t,e);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:t,isLE:n,BITS:i,BYTES:s,MASK:Ia(i),ZERO:Fa,ONE:za,create:e=>Ha(e,t),isValid:e=>{if("bigint"!=typeof e)throw new Error("invalid field element: expected bigint, got "+typeof e);return Fa<=e&&e<t},is0:t=>t===Fa,isOdd:t=>(t&za)===za,neg:e=>Ha(-e,t),eql:(t,e)=>t===e,sqr:e=>Ha(e*e,t),add:(e,n)=>Ha(e+n,t),sub:(e,n)=>Ha(e-n,t),mul:(e,n)=>Ha(e*n,t),pow:(t,e)=>function(t,e,n){if(n<Fa)throw new Error("invalid exponent, negatives unsupported");if(n===Fa)return t.ONE;if(n===za)return e;let r=t.ONE,i=e;for(;n>Fa;)n&za&&(r=t.mul(r,i)),i=t.sqr(i),n>>=za;return r}(a,t,e),div:(e,n)=>Ha(e*Za(n,t),t),sqrN:t=>t*t,addN:(t,e)=>t+e,subN:(t,e)=>t-e,mulN:(t,e)=>t*e,inv:e=>Za(e,t),sqrt:r.sqrt||(e=>(o||(o=function(t){if(t%$a===Ma){const e=(t+za)/$a;return function(t,n){const r=t.pow(n,e);if(!t.eql(t.sqr(r),n))throw new Error("Cannot find square root");return r}}if(t%qa===Ka){const e=(t-Ka)/qa;return function(t,n){const r=t.mul(n,Da),i=t.pow(r,e),s=t.mul(n,i),o=t.mul(t.mul(s,Da),i),a=t.mul(s,t.sub(o,t.ONE));if(!t.eql(t.sqr(a),n))throw new Error("Cannot find square root");return a}}return function(t){const e=(t-za)/Da;let n,r,i;for(n=t-za,r=0;n%Da===Fa;n/=Da,r++);for(i=Da;i<t&&ja(i,e,t)!==t-za;i++)if(i>1e3)throw new Error("Cannot find square root: likely non-prime P");if(1===r){const e=(t+za)/$a;return function(t,n){const r=t.pow(n,e);if(!t.eql(t.sqr(r),n))throw new Error("Cannot find square root");return r}}const s=(n+za)/Da;return function(t,o){if(t.pow(o,e)===t.neg(t.ONE))throw new Error("Cannot find square root");let a=r,c=t.pow(t.mul(t.ONE,i),n),h=t.pow(o,s),l=t.pow(o,n);for(;!t.eql(l,t.ONE);){if(t.eql(l,t.ZERO))return t.ZERO;let e=1;for(let n=t.sqr(l);e<a&&!t.eql(n,t.ONE);e++)n=t.sqr(n);const n=t.pow(c,za<<BigInt(a-e-1));c=t.sqr(n),h=t.mul(h,n),l=t.mul(l,c),a=e}return h}}(t)}(t)),o(a,e))),invertBatch:t=>function(t,e){const n=new Array(e.length),r=e.reduce(((e,r,i)=>t.is0(r)?e:(n[i]=e,t.mul(e,r))),t.ONE),i=t.inv(r);return e.reduceRight(((e,r,i)=>t.is0(r)?e:(n[i]=t.mul(e,n[i]),t.mul(e,r))),i),n}(a,t),cmov:(t,e,n)=>n?e:t,toBytes:t=>n?ka(t,s):Ea(t,s),fromBytes:t=>{if(t.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);return n?_a(t):va(t)}});return Object.freeze(a)}function Ya(t){if("bigint"!=typeof t)throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Qa(t){const e=Ya(t);return e+Math.ceil(e/2)}const Xa=BigInt(0),tc=BigInt(1);function ec(t,e){const n=e.negate();return t?n:e}function nc(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function rc(t,e){return nc(t,e),{windows:Math.ceil(e/t)+1,windowSize:2**(t-1)}}const ic=new WeakMap,sc=new WeakMap;function oc(t){return sc.get(t)||1}function ac(t){return Oa(t.Fp,Wa.reduce(((t,e)=>(t[e]="function",t)),{ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"})),Oa(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...Ga(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}function cc(t){void 0!==t.lowS&&da("lowS",t.lowS),void 0!==t.prehash&&da("prehash",t.prehash)}const{Ph:hc,aT:lc}=e;class uc extends Error{constructor(t=""){super(t)}}const dc={Err:uc,_tlv:{encode:(t,e)=>{const{Err:n}=dc;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(1&e.length)throw new n("tlv.encode: unpadded data");const r=e.length/2,i=ga(r);if(i.length/2&128)throw new n("tlv.encode: long form length too big");const s=r>127?ga(i.length/2|128):"";return ga(t)+s+i+e},decode(t,e){const{Err:n}=dc;let r=0;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length<2||e[r++]!==t)throw new n("tlv.decode: wrong tlv");const i=e[r++];let s=0;if(128&i){const t=127&i;if(!t)throw new n("tlv.decode(long): indefinite length not supported");if(t>4)throw new n("tlv.decode(long): byte length is too big");const o=e.subarray(r,r+t);if(o.length!==t)throw new n("tlv.decode: length bytes not complete");if(0===o[0])throw new n("tlv.decode(long): zero leftmost byte");for(const t of o)s=s<<8|t;if(r+=t,s<128)throw new n("tlv.decode(long): not minimal encoding")}else s=i;const o=e.subarray(r,r+s);if(o.length!==s)throw new n("tlv.decode: wrong value length");return{v:o,l:e.subarray(r+s)}}},_int:{encode(t){const{Err:e}=dc;if(t<fc)throw new e("integer: negative integers are not allowed");let n=ga(t);if(8&Number.parseInt(n[0],16)&&(n="00"+n),1&n.length)throw new e("unexpected DER parsing assertion: unpadded hex");return n},decode(t){const{Err:e}=dc;if(128&t[0])throw new e("invalid signature integer: negative");if(0===t[0]&&!(128&t[1]))throw new e("invalid signature integer: unnecessary leading zero");return hc(t)}},toSig(t){const{Err:e,_int:n,_tlv:r}=dc,i="string"==typeof t?lc(t):t;ua(i);const{v:s,l:o}=r.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=r.decode(2,s),{v:h,l}=r.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:n.decode(a),s:n.decode(h)}},hexFromSig(t){const{_tlv:e,_int:n}=dc,r=e.encode(2,n.encode(t.r))+e.encode(2,n.encode(t.s));return e.encode(48,r)}},fc=BigInt(0),pc=BigInt(1),gc=(BigInt(2),BigInt(3));function yc(t){const e=function(t){const e=ac(t);Oa(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:i}=e;if(n){if(!r.eql(i,r.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if("object"!=typeof n||"bigint"!=typeof n.beta||"function"!=typeof n.splitScalar)throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}(t),{Fp:n}=e,r=Ja(e.n,e.nBitLength),i=e.toBytes||((t,e,r)=>{const i=e.toAffine();return xa(Uint8Array.from([4]),n.toBytes(i.x),n.toBytes(i.y))}),s=e.fromBytes||(t=>{const e=t.subarray(1);return{x:n.fromBytes(e.subarray(0,n.BYTES)),y:n.fromBytes(e.subarray(n.BYTES,2*n.BYTES))}});function o(t){const{a:r,b:i}=e,s=n.sqr(t),o=n.mul(s,t);return n.add(n.add(o,n.mul(t,r)),i)}if(!n.eql(n.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(t){const{allowedPrivateKeyLengths:n,nByteLength:r,wrapPrivateKey:i,n:s}=e;if(n&&"bigint"!=typeof t){if(la(t)&&(t=pa(t)),"string"!=typeof t||!n.includes(t.length))throw new Error("invalid private key");t=t.padStart(2*r,"0")}let o;try{o="bigint"==typeof t?t:va(Aa("private key",t,r))}catch(e){throw new Error("invalid private key, expected hex or "+r+" bytes, got "+typeof t)}return i&&(o=Ha(o,s)),Ca("private key",o,pc,s),o}function c(t){if(!(t instanceof u))throw new Error("ProjectivePoint expected")}const h=Ba(((t,e)=>{const{px:r,py:i,pz:s}=t;if(n.eql(s,n.ONE))return{x:r,y:i};const o=t.is0();null==e&&(e=o?n.ONE:n.inv(s));const a=n.mul(r,e),c=n.mul(i,e),h=n.mul(s,e);if(o)return{x:n.ZERO,y:n.ZERO};if(!n.eql(h,n.ONE))throw new Error("invZ was invalid");return{x:a,y:c}})),l=Ba((t=>{if(t.is0()){if(e.allowInfinityPoint&&!n.is0(t.py))return;throw new Error("bad point: ZERO")}const{x:r,y:i}=t.toAffine();if(!n.isValid(r)||!n.isValid(i))throw new Error("bad point: x or y not FE");const s=n.sqr(i),a=o(r);if(!n.eql(s,a))throw new Error("bad point: equation left != right");if(!t.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0}));class u{constructor(t,e,r){if(this.px=t,this.py=e,this.pz=r,null==t||!n.isValid(t))throw new Error("x required");if(null==e||!n.isValid(e))throw new Error("y required");if(null==r||!n.isValid(r))throw new Error("z required");Object.freeze(this)}static fromAffine(t){const{x:e,y:r}=t||{};if(!t||!n.isValid(e)||!n.isValid(r))throw new Error("invalid affine point");if(t instanceof u)throw new Error("projective point not allowed");const i=t=>n.eql(t,n.ZERO);return i(e)&&i(r)?u.ZERO:new u(e,r,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(t){const e=n.invertBatch(t.map((t=>t.pz)));return t.map(((t,n)=>t.toAffine(e[n]))).map(u.fromAffine)}static fromHex(t){const e=u.fromAffine(s(Aa("pointHex",t)));return e.assertValidity(),e}static fromPrivateKey(t){return u.BASE.multiply(a(t))}static msm(t,e){return function(t,e,n,r){if(function(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach(((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)}))}(n,t),function(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach(((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)}))}(r,e),n.length!==r.length)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,s=Ta(BigInt(n.length)),o=s>12?s-3:s>4?s-2:s?2:1,a=(1<<o)-1,c=new Array(a+1).fill(i);let h=i;for(let t=Math.floor((e.BITS-1)/o)*o;t>=0;t-=o){c.fill(i);for(let e=0;e<r.length;e++){const i=r[e],s=Number(i>>BigInt(t)&BigInt(a));c[s]=c[s].add(n[e])}let e=i;for(let t=c.length-1,n=i;t>0;t--)n=n.add(c[t]),e=e.add(n);if(h=h.add(e),0!==t)for(let t=0;t<o;t++)h=h.double()}return h}(u,r,t,e)}_setWindowSize(t){f.setWindowSize(this,t)}assertValidity(){l(this)}hasEvenY(){const{y:t}=this.toAffine();if(n.isOdd)return!n.isOdd(t);throw new Error("Field doesn't support isOdd")}equals(t){c(t);const{px:e,py:r,pz:i}=this,{px:s,py:o,pz:a}=t,h=n.eql(n.mul(e,a),n.mul(s,i)),l=n.eql(n.mul(r,a),n.mul(o,i));return h&&l}negate(){return new u(this.px,n.neg(this.py),this.pz)}double(){const{a:t,b:r}=e,i=n.mul(r,gc),{px:s,py:o,pz:a}=this;let c=n.ZERO,h=n.ZERO,l=n.ZERO,d=n.mul(s,s),f=n.mul(o,o),p=n.mul(a,a),g=n.mul(s,o);return g=n.add(g,g),l=n.mul(s,a),l=n.add(l,l),c=n.mul(t,l),h=n.mul(i,p),h=n.add(c,h),c=n.sub(f,h),h=n.add(f,h),h=n.mul(c,h),c=n.mul(g,c),l=n.mul(i,l),p=n.mul(t,p),g=n.sub(d,p),g=n.mul(t,g),g=n.add(g,l),l=n.add(d,d),d=n.add(l,d),d=n.add(d,p),d=n.mul(d,g),h=n.add(h,d),p=n.mul(o,a),p=n.add(p,p),d=n.mul(p,g),c=n.sub(c,d),l=n.mul(p,f),l=n.add(l,l),l=n.add(l,l),new u(c,h,l)}add(t){c(t);const{px:r,py:i,pz:s}=this,{px:o,py:a,pz:h}=t;let l=n.ZERO,d=n.ZERO,f=n.ZERO;const p=e.a,g=n.mul(e.b,gc);let y=n.mul(r,o),w=n.mul(i,a),m=n.mul(s,h),b=n.add(r,i),v=n.add(o,a);b=n.mul(b,v),v=n.add(y,w),b=n.sub(b,v),v=n.add(r,s);let _=n.add(o,h);return v=n.mul(v,_),_=n.add(y,m),v=n.sub(v,_),_=n.add(i,s),l=n.add(a,h),_=n.mul(_,l),l=n.add(w,m),_=n.sub(_,l),f=n.mul(p,v),l=n.mul(g,m),f=n.add(l,f),l=n.sub(w,f),f=n.add(w,f),d=n.mul(l,f),w=n.add(y,y),w=n.add(w,y),m=n.mul(p,m),v=n.mul(g,v),w=n.add(w,m),m=n.sub(y,m),m=n.mul(p,m),v=n.add(v,m),y=n.mul(w,v),d=n.add(d,y),y=n.mul(_,v),l=n.mul(b,l),l=n.sub(l,y),y=n.mul(b,w),f=n.mul(_,f),f=n.add(f,y),new u(l,d,f)}subtract(t){return this.add(t.negate())}is0(){return this.equals(u.ZERO)}wNAF(t){return f.wNAFCached(this,t,u.normalizeZ)}multiplyUnsafe(t){const{endo:r,n:i}=e;Ca("scalar",t,fc,i);const s=u.ZERO;if(t===fc)return s;if(this.is0()||t===pc)return this;if(!r||f.hasPrecomputes(this))return f.wNAFCachedUnsafe(this,t,u.normalizeZ);let{k1neg:o,k1:a,k2neg:c,k2:h}=r.splitScalar(t),l=s,d=s,p=this;for(;a>fc||h>fc;)a&pc&&(l=l.add(p)),h&pc&&(d=d.add(p)),p=p.double(),a>>=pc,h>>=pc;return o&&(l=l.negate()),c&&(d=d.negate()),d=new u(n.mul(d.px,r.beta),d.py,d.pz),l.add(d)}multiply(t){const{endo:r,n:i}=e;let s,o;if(Ca("scalar",t,pc,i),r){const{k1neg:e,k1:i,k2neg:a,k2:c}=r.splitScalar(t);let{p:h,f:l}=this.wNAF(i),{p:d,f:p}=this.wNAF(c);h=f.constTimeNegate(e,h),d=f.constTimeNegate(a,d),d=new u(n.mul(d.px,r.beta),d.py,d.pz),s=h.add(d),o=l.add(p)}else{const{p:e,f:n}=this.wNAF(t);s=e,o=n}return u.normalizeZ([s,o])[0]}multiplyAndAddUnsafe(t,e,n){const r=u.BASE,i=(t,e)=>e!==fc&&e!==pc&&t.equals(r)?t.multiply(e):t.multiplyUnsafe(e),s=i(this,e).add(i(t,n));return s.is0()?void 0:s}toAffine(t){return h(this,t)}isTorsionFree(){const{h:t,isTorsionFree:n}=e;if(t===pc)return!0;if(n)return n(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:t,clearCofactor:n}=e;return t===pc?this:n?n(u,this):this.multiplyUnsafe(e.h)}toRawBytes(t=!0){return da("isCompressed",t),this.assertValidity(),i(u,this,t)}toHex(t=!0){return da("isCompressed",t),pa(this.toRawBytes(t))}}u.BASE=new u(e.Gx,e.Gy,n.ONE),u.ZERO=new u(n.ZERO,n.ONE,n.ZERO);const d=e.nBitLength,f=(p=u,g=e.endo?Math.ceil(d/2):d,{constTimeNegate:ec,hasPrecomputes:t=>1!==oc(t),unsafeLadder(t,e,n=p.ZERO){let r=t;for(;e>Xa;)e&tc&&(n=n.add(r)),r=r.double(),e>>=tc;return n},precomputeWindow(t,e){const{windows:n,windowSize:r}=rc(e,g),i=[];let s=t,o=s;for(let t=0;t<n;t++){o=s,i.push(o);for(let t=1;t<r;t++)o=o.add(s),i.push(o);s=o.double()}return i},wNAF(t,e,n){const{windows:r,windowSize:i}=rc(t,g);let s=p.ZERO,o=p.BASE;const a=BigInt(2**t-1),c=2**t,h=BigInt(t);for(let t=0;t<r;t++){const r=t*i;let l=Number(n&a);n>>=h,l>i&&(l-=c,n+=tc);const u=r,d=r+Math.abs(l)-1,f=t%2!=0,p=l<0;0===l?o=o.add(ec(f,e[u])):s=s.add(ec(p,e[d]))}return{p:s,f:o}},wNAFUnsafe(t,e,n,r=p.ZERO){const{windows:i,windowSize:s}=rc(t,g),o=BigInt(2**t-1),a=2**t,c=BigInt(t);for(let t=0;t<i;t++){const i=t*s;if(n===Xa)break;let h=Number(n&o);if(n>>=c,h>s&&(h-=a,n+=tc),0===h)continue;let l=e[i+Math.abs(h)-1];h<0&&(l=l.negate()),r=r.add(l)}return r},getPrecomputes(t,e,n){let r=ic.get(e);return r||(r=this.precomputeWindow(e,t),1!==t&&ic.set(e,n(r))),r},wNAFCached(t,e,n){const r=oc(t);return this.wNAF(r,this.getPrecomputes(r,t,n),e)},wNAFCachedUnsafe(t,e,n,r){const i=oc(t);return 1===i?this.unsafeLadder(t,e,r):this.wNAFUnsafe(i,this.getPrecomputes(i,t,n),e,r)},setWindowSize(t,e){nc(e,g),sc.set(t,e),ic.delete(t)}});var p,g;return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:a,weierstrassEquation:o,isWithinCurveOrder:function(t){return Sa(t,pc,e.n)}}}function wc(t){const e=function(t){const e=ac(t);return Oa(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}(t),{Fp:n,n:r}=e,i=n.BYTES+1,s=2*n.BYTES+1;function o(t){return Ha(t,r)}function a(t){return Za(t,r)}const{ProjectivePoint:c,normPrivateKeyToScalar:h,weierstrassEquation:l,isWithinCurveOrder:u}=yc({...e,toBytes(t,e,r){const i=e.toAffine(),s=n.toBytes(i.x),o=xa;return da("isCompressed",r),r?o(Uint8Array.from([e.hasEvenY()?2:3]),s):o(Uint8Array.from([4]),s,n.toBytes(i.y))},fromBytes(t){const e=t.length,r=t[0],o=t.subarray(1);if(e!==i||2!==r&&3!==r){if(e===s&&4===r)return{x:n.fromBytes(o.subarray(0,n.BYTES)),y:n.fromBytes(o.subarray(n.BYTES,2*n.BYTES))};throw new Error("invalid Point, expected length of "+i+", or uncompressed "+s+", got "+e)}{const t=va(o);if(!Sa(t,pc,n.ORDER))throw new Error("Point is not on curve");const e=l(t);let i;try{i=n.sqrt(e)}catch(t){const e=t instanceof Error?": "+t.message:"";throw new Error("Point is not on curve"+e)}return!(1&~r)!=((i&pc)===pc)&&(i=n.neg(i)),{x:t,y:i}}}}),d=t=>pa(Ea(t,e.nByteLength));function f(t){return t>r>>pc}const p=(t,e,n)=>va(t.slice(e,n));class g{constructor(t,e,n){this.r=t,this.s=e,this.recovery=n,this.assertValidity()}static fromCompact(t){const n=e.nByteLength;return t=Aa("compactSignature",t,2*n),new g(p(t,0,n),p(t,n,2*n))}static fromDER(t){const{r:e,s:n}=dc.toSig(Aa("DER",t));return new g(e,n)}assertValidity(){Ca("r",this.r,pc,r),Ca("s",this.s,pc,r)}addRecoveryBit(t){return new g(this.r,this.s,t)}recoverPublicKey(t){const{r,s:i,recovery:s}=this,h=b(Aa("msgHash",t));if(null==s||![0,1,2,3].includes(s))throw new Error("recovery id invalid");const l=2===s||3===s?r+e.n:r;if(l>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const u=1&s?"03":"02",f=c.fromHex(u+d(l)),p=a(l),g=o(-h*p),y=o(i*p),w=c.BASE.multiplyAndAddUnsafe(f,g,y);if(!w)throw new Error("point at infinify");return w.assertValidity(),w}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new g(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return ba(this.toDERHex())}toDERHex(){return dc.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return ba(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}const y={isValidPrivateKey(t){try{return h(t),!0}catch(t){return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const t=Qa(e.n);return function(t,e,n=!1){const r=t.length,i=Ya(e),s=Qa(e);if(r<16||r<s||r>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+r);const o=Ha(n?_a(t):va(t),e-za)+za;return n?ka(o,i):Ea(o,i)}(e.randomBytes(t),e.n)},precompute:(t=8,e=c.BASE)=>(e._setWindowSize(t),e.multiply(BigInt(3)),e)};function w(t){const e=la(t),n="string"==typeof t,r=(e||n)&&t.length;return e?r===i||r===s:n?r===2*i||r===2*s:t instanceof c}const m=e.bits2int||function(t){if(t.length>8192)throw new Error("input is too large");const n=va(t),r=8*t.length-e.nBitLength;return r>0?n>>BigInt(r):n},b=e.bits2int_modN||function(t){return o(m(t))},v=Ia(e.nBitLength);function _(t){return Ca("num < 2^"+e.nBitLength,t,fc,v),Ea(t,e.nByteLength)}const E={lowS:e.lowS,prehash:!1},k={lowS:e.lowS,prehash:!1};return c.BASE._setWindowSize(8),{CURVE:e,getPublicKey:function(t,e=!0){return c.fromPrivateKey(t).toRawBytes(e)},getSharedSecret:function(t,e,n=!0){if(w(t))throw new Error("first arg must be private key");if(!w(e))throw new Error("second arg must be public key");return c.fromHex(e).multiply(h(t)).toRawBytes(n)},sign:function(t,r,i=E){const{seed:s,k2sig:l}=function(t,r,i=E){if(["recovered","canonical"].some((t=>t in i)))throw new Error("sign() legacy options not supported");const{hash:s,randomBytes:l}=e;let{lowS:d,prehash:p,extraEntropy:y}=i;null==d&&(d=!0),t=Aa("msgHash",t),cc(i),p&&(t=Aa("prehashed msgHash",s(t)));const w=b(t),v=h(r),k=[_(v),_(w)];if(null!=y&&!1!==y){const t=!0===y?l(n.BYTES):y;k.push(Aa("extraEntropy",t))}const A=xa(...k),x=w;return{seed:A,k2sig:function(t){const e=m(t);if(!u(e))return;const n=a(e),r=c.BASE.multiply(e).toAffine(),i=o(r.x);if(i===fc)return;const s=o(n*o(x+i*v));if(s===fc)return;let h=(r.x===i?0:2)|Number(r.y&pc),l=s;return d&&f(s)&&(l=function(t){return f(t)?o(-t):t}(s),h^=1),new g(i,l,h)}}}(t,r,i),d=e;return La(d.hash.outputLen,d.nByteLength,d.hmac)(s,l)},verify:function(t,n,r,i=k){const s=t;n=Aa("msgHash",n),r=Aa("publicKey",r);const{lowS:h,prehash:l,format:u}=i;if(cc(i),"strict"in i)throw new Error("options.strict was renamed to lowS");if(void 0!==u&&"compact"!==u&&"der"!==u)throw new Error("format must be compact or der");const d="string"==typeof s||la(s),f=!d&&!u&&"object"==typeof s&&null!==s&&"bigint"==typeof s.r&&"bigint"==typeof s.s;if(!d&&!f)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let p,y;try{if(f&&(p=new g(s.r,s.s)),d){try{"compact"!==u&&(p=g.fromDER(s))}catch(t){if(!(t instanceof dc.Err))throw t}p||"der"===u||(p=g.fromCompact(s))}y=c.fromHex(r)}catch(t){return!1}if(!p)return!1;if(h&&p.hasHighS())return!1;l&&(n=e.hash(n));const{r:w,s:m}=p,v=b(n),_=a(m),E=o(v*_),A=o(w*_),x=c.BASE.multiplyAndAddUnsafe(y,E,A)?.toAffine();return!!x&&o(x.x)===w},ProjectivePoint:c,Signature:g,utils:y}}function mc(t){return{hash:t,hmac:(e,...n)=>oa(t,e,function(...t){let e=0;for(let n=0;n<t.length;n++){const r=t[n];Mo(r),e+=r.length}const n=new Uint8Array(e);for(let e=0,r=0;e<t.length;e++){const i=t[e];n.set(i,r),r+=i.length}return n}(...n)),randomBytes:Yo}}BigInt(4);const bc=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),vc=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_c=BigInt(1),Ec=BigInt(2),kc=(t,e)=>(t+e/Ec)/e;function Ac(t){const e=bc,n=BigInt(3),r=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),h=t*t*t%e,l=h*h*t%e,u=Va(l,n,e)*l%e,d=Va(u,n,e)*l%e,f=Va(d,Ec,e)*h%e,p=Va(f,i,e)*f%e,g=Va(p,s,e)*p%e,y=Va(g,a,e)*g%e,w=Va(y,c,e)*y%e,m=Va(w,a,e)*g%e,b=Va(m,n,e)*l%e,v=Va(b,o,e)*p%e,_=Va(v,r,e)*h%e,E=Va(_,Ec,e);if(!xc.eql(xc.sqr(E),t))throw new Error("Cannot find square root");return E}const xc=Ja(bc,void 0,void 0,{sqrt:Ac}),Rc=function(t,e){const n=e=>wc({...t,...mc(e)});return{...n(e),create:n}}({a:BigInt(0),b:BigInt(7),Fp:xc,n:vc,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=vc,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_c*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=n,o=BigInt("0x100000000000000000000000000000000"),a=kc(s*t,e),c=kc(-r*t,e);let h=Ha(t-a*n-c*i,e),l=Ha(-a*r-c*s,e);const u=h>o,d=l>o;if(u&&(h=e-h),d&&(l=e-l),h>o||l>o)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:u,k1:h,k2neg:d,k2:l}}}},ia),Sc=BigInt(0),Cc={};function Tc(t,...e){let n=Cc[t];if(void 0===n){const e=ia(Uint8Array.from(t,(t=>t.charCodeAt(0))));n=xa(e,e),Cc[t]=n}return ia(xa(n,...e))}const Ic=t=>t.toRawBytes(!0).slice(1),Uc=t=>Ea(t,32),Nc=t=>Ha(t,bc),Lc=t=>Ha(t,vc),Pc=Rc.ProjectivePoint;function Oc(t){let e=Rc.utils.normPrivateKeyToScalar(t),n=Pc.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:Lc(-e),bytes:Ic(n)}}function Bc(t){Ca("x",t,_c,bc);const e=Nc(t*t);let n=Ac(Nc(e*t+BigInt(7)));n%Ec!==Sc&&(n=Nc(-n));const r=new Pc(t,n,_c);return r.assertValidity(),r}const Fc=va;function zc(...t){return Lc(Fc(Tc("BIP0340/challenge",...t)))}function Dc(t){return Oc(t).bytes}function Mc(t,e,n=Yo(32)){const r=Aa("message",t),{bytes:i,scalar:s}=Oc(e),o=Aa("auxRand",n,32),a=Uc(s^Fc(Tc("BIP0340/aux",o))),c=Tc("BIP0340/nonce",a,i,r),h=Lc(Fc(c));if(h===Sc)throw new Error("sign failed: k is zero");const{bytes:l,scalar:u}=Oc(h),d=zc(l,i,r),f=new Uint8Array(64);if(f.set(l,0),f.set(Uc(Lc(u+d*s)),32),!$c(f,r,i))throw new Error("sign: Invalid signature produced");return f}function $c(t,e,n){const r=Aa("signature",t,64),i=Aa("message",e),s=Aa("publicKey",n,32);try{const t=Bc(Fc(s)),e=Fc(r.subarray(0,32));if(!Sa(e,_c,bc))return!1;const n=Fc(r.subarray(32,64));if(!Sa(n,_c,vc))return!1;const h=zc(Uc(e),Ic(t),i),l=(o=t,a=n,c=Lc(-h),Pc.BASE.multiplyAndAddUnsafe(o,a,c));return!(!l||!l.hasEvenY()||l.toAffine().x!==e)}catch(t){return!1}var o,a,c}const Kc=(()=>({getPublicKey:Dc,sign:Mc,verify:$c,utils:{randomPrivateKey:Rc.utils.randomPrivateKey,lift_x:Bc,pointToBytes:Ic,numberToBytesBE:Ea,bytesToNumberBE:va,taggedHash:Tc,mod:Ha}}))();var qc=__webpack_require__(654);function Hc(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&"Uint8Array"===t.constructor.name}function jc(t,e){return!!Array.isArray(e)&&(0===e.length||(t?e.every((t=>"string"==typeof t)):e.every((t=>Number.isSafeInteger(t)))))}function Vc(t){if("function"!=typeof t)throw new Error("function expected");return!0}function Zc(t,e){if("string"!=typeof e)throw new Error(`${t}: string expected`);return!0}function Wc(t){if(!Number.isSafeInteger(t))throw new Error(`invalid integer: ${t}`)}function Gc(t){if(!Array.isArray(t))throw new Error("array expected")}function Jc(t,e){if(!jc(!0,e))throw new Error(`${t}: array of strings expected`)}function Yc(t,e){if(!jc(!1,e))throw new Error(`${t}: array of numbers expected`)}function Qc(...t){const e=t=>t,n=(t,e)=>n=>t(e(n));return{encode:t.map((t=>t.encode)).reduceRight(n,e),decode:t.map((t=>t.decode)).reduce(n,e)}}function Xc(t){const e="string"==typeof t?t.split(""):t,n=e.length;Jc("alphabet",e);const r=new Map(e.map(((t,e)=>[t,e])));return{encode:r=>(Gc(r),r.map((r=>{if(!Number.isSafeInteger(r)||r<0||r>=n)throw new Error(`alphabet.encode: digit index outside alphabet "${r}". Allowed: ${t}`);return e[r]}))),decode:e=>(Gc(e),e.map((e=>{Zc("alphabet.decode",e);const n=r.get(e);if(void 0===n)throw new Error(`Unknown letter: "${e}". Allowed: ${t}`);return n})))}}function th(t=""){return Zc("join",t),{encode:e=>(Jc("join.decode",e),e.join(t)),decode:e=>(Zc("join.decode",e),e.split(t))}}function eh(t,e="="){return Wc(t),Zc("padding",e),{encode(n){for(Jc("padding.encode",n);n.length*t%8;)n.push(e);return n},decode(n){Jc("padding.decode",n);let r=n.length;if(r*t%8)throw new Error("padding: invalid, string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if((r-1)*t%8==0)throw new Error("padding: invalid, string has too much padding");return n.slice(0,r)}}}function nh(t){return Vc(t),{encode:t=>t,decode:e=>t(e)}}function rh(t,e,n){if(e<2)throw new Error(`convertRadix: invalid from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: invalid to=${n}, base cannot be less than 2`);if(Gc(t),!t.length)return[];let r=0;const i=[],s=Array.from(t,(t=>{if(Wc(t),t<0||t>=e)throw new Error(`invalid integer: ${t}`);return t})),o=s.length;for(;;){let t=0,a=!0;for(let i=r;i<o;i++){const o=s[i],c=e*t,h=c+o;if(!Number.isSafeInteger(h)||c/e!==t||h-o!==c)throw new Error("convertRadix: carry overflow");const l=h/n;t=h%n;const u=Math.floor(l);if(s[i]=u,!Number.isSafeInteger(u)||u*n+t!==h)throw new Error("convertRadix: carry overflow");a&&(u?a=!1:r=i)}if(i.push(t),a)break}for(let e=0;e<t.length-1&&0===t[e];e++)i.push(0);return i.reverse()}const ih=(t,e)=>0===e?t:ih(e,t%e),sh=(t,e)=>t+(e-ih(t,e)),oh=(()=>{let t=[];for(let e=0;e<40;e++)t.push(2**e);return t})();function ah(t,e,n,r){if(Gc(t),e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(sh(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${sh(e,n)}`);let i=0,s=0;const o=oh[e],a=oh[n]-1,c=[];for(const r of t){if(Wc(r),r>=o)throw new Error(`convertRadix2: invalid data word=${r} from=${e}`);if(i=i<<e|r,s+e>32)throw new Error(`convertRadix2: carry overflow pos=${s} from=${e}`);for(s+=e;s>=n;s-=n)c.push((i>>s-n&a)>>>0);const t=oh[s];if(void 0===t)throw new Error("invalid carry");i&=t-1}if(i=i<<n-s&a,!r&&s>=e)throw new Error("Excess padding");if(!r&&i>0)throw new Error(`Non-zero padding: ${i}`);return r&&s>0&&c.push(i>>>0),c}function ch(t,e=!1){if(Wc(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(sh(8,t)>32||sh(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!Hc(n))throw new Error("radix2.encode input should be Uint8Array");return ah(Array.from(n),8,t,!e)},decode:n=>(Yc("radix2.decode",n),Uint8Array.from(ah(n,t,8,e)))}}function hh(t){return Vc(t),function(...e){try{return t.apply(null,e)}catch(t){}}}Qc(ch(4),Xc("0123456789ABCDEF"),th("")),Qc(ch(5),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),eh(5),th(""));const lh=(Qc(ch(5),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),th("")),Qc(ch(5),Xc("0123456789ABCDEFGHIJKLMNOPQRSTUV"),eh(5),th("")),Qc(ch(5),Xc("0123456789ABCDEFGHIJKLMNOPQRSTUV"),th("")),Qc(ch(5),Xc("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),th(""),nh((t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")))),Qc(ch(6),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),eh(6),th(""))),uh=(Qc(ch(6),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),th("")),Qc(ch(6),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),eh(6),th("")),Qc(ch(6),Xc("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),th("")),t=>Qc(function(t){return Wc(t),{encode:e=>{if(!Hc(e))throw new Error("radix.encode input should be Uint8Array");return rh(Array.from(e),256,t)},decode:e=>(Yc("radix.decode",e),Uint8Array.from(rh(e,t,256)))}}(58),Xc(t),th(""))),dh=(uh("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),uh("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),uh("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz"),Qc(Xc("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),th(""))),fh=[996825010,642813549,513874426,1027748829,705979059];function ph(t){const e=t>>25;let n=(33554431&t)<<5;for(let t=0;t<fh.length;t++)1==(e>>t&1)&&(n^=fh[t]);return n}function gh(t,e,n=1){const r=t.length;let i=1;for(let e=0;e<r;e++){const n=t.charCodeAt(e);if(n<33||n>126)throw new Error(`Invalid prefix (${t})`);i=ph(i)^n>>5}i=ph(i);for(let e=0;e<r;e++)i=ph(i)^31&t.charCodeAt(e);for(let t of e)i=ph(i)^t;for(let t=0;t<6;t++)i=ph(i);return i^=n,dh.encode(ah([i%oh[30]],30,5,!1))}function yh(t){const e="bech32"===t?1:734539939,n=ch(5),r=n.decode,i=n.encode,s=hh(r);function o(t,n,r=90){Zc("bech32.encode prefix",t),Hc(n)&&(n=Array.from(n)),Yc("bech32.encode",n);const i=t.length;if(0===i)throw new TypeError(`Invalid prefix length ${i}`);const s=i+7+n.length;if(!1!==r&&s>r)throw new TypeError(`Length ${s} exceeds limit ${r}`);const o=t.toLowerCase(),a=gh(o,n,e);return`${o}1${dh.encode(n)}${a}`}function a(t,n=90){Zc("bech32.decode input",t);const r=t.length;if(r<8||!1!==n&&r>n)throw new TypeError(`invalid string length: ${r} (${t}). Expected (8..${n})`);const i=t.toLowerCase();if(t!==i&&t!==t.toUpperCase())throw new Error("String must be lowercase or uppercase");const s=i.lastIndexOf("1");if(0===s||-1===s)throw new Error('Letter "1" must be present between prefix and data only');const o=i.slice(0,s),a=i.slice(s+1);if(a.length<6)throw new Error("Data must be at least 6 characters long");const c=dh.decode(a).slice(0,-6),h=gh(o,c,e);if(!a.endsWith(h))throw new Error(`Invalid checksum in ${t}: expected "${h}"`);return{prefix:o,words:c}}return{encode:o,decode:a,encodeFromBytes:function(t,e){return o(t,i(e))},decodeToBytes:function(t){const{prefix:e,words:n}=a(t,!1);return{prefix:e,words:n,bytes:r(n)}},decodeUnsafe:hh(a),fromWords:r,fromWordsUnsafe:s,toWords:i}}const wh=yh("bech32");yh("bech32m");function mh(t,e,n="write"){if(!t.outboxTracker)return;const r=t.outboxTracker.data.get(e);return r?"write"===n?r.writeRelays:r.readRelays:void 0}function bh(t,e,n,{count:r,preferredRelays:i}={}){r??=2,i??=new Set;const s=t.pool,o=s.connectedRelays();o.forEach((t=>{i.add(t.url)}));const a=new Map,{pubkeysToRelays:c,authorsMissingRelays:h}=function(t,e,n="read"){const r=new Map,i=new Set;return e.forEach((e=>{const s=mh(t,e,n);s&&s.size>0?(s.forEach((t=>{(r.get(t)||new Set).add(e)})),r.set(e,s)):i.add(e)})),{pubkeysToRelays:r,authorsMissingRelays:i}}(t,e,n),l=function(t,e){const n=new Map;return e.forEach((e=>{const r=mh(t,e);r&&r.forEach((t=>{const e=n.get(t)||0;n.set(t,e+1)}))})),Array.from(n.entries()).sort(((t,e)=>e[1]-t[1])).map((t=>t[0]))}(t,e),u=(t,e)=>{const n=a.get(e)||[];n.push(t),a.set(e,n)};for(const[t,e]of c.entries()){let n=r;for(const r of o)e.has(r.url)&&(u(t,r.url),n--);for(const r of e)a.has(r)&&(u(t,r),n--);if(!(n<=0))for(const r of l){if(n<=0)break;e.has(r)&&(u(t,r),n--)}}for(const t of h)s.permanentAndConnectedRelays().forEach((e=>{const n=a.get(e.url)||[];n.push(t),a.set(e.url,n)}));return a}function vh(t){try{return _h(t)}catch{return}}function _h(t){let e=function(t,e={}){if("string"!=typeof(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e}).defaultProtocol||e.defaultProtocol.endsWith(":")||(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return Rh(t,e);if(xh(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const r=new URL(t);if(e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&"https:"===r.protocol&&(r.protocol="http:"),e.forceHttps&&"http:"===r.protocol&&(r.protocol="https:"),e.stripAuthentication&&(r.username="",r.password=""),e.stripHash?r.hash="":e.stripTextFragment&&(r.hash=r.hash.replace(/#?:~:text.*?$/i,"")),r.pathname){const t=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let e=0,n="";for(;;){const i=t.exec(r.pathname);if(!i)break;const s=i[0],o=i.index;n+=r.pathname.slice(e,o).replace(/\/{2,}/g,"/"),n+=s,e=o+s.length}n+=r.pathname.slice(e,r.pathname.length).replace(/\/{2,}/g,"/"),r.pathname=n}if(r.pathname)try{r.pathname=decodeURI(r.pathname)}catch{}if(!0===e.removeDirectoryIndex&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let t=r.pathname.split("/");const n=t[t.length-1];kh(n,e.removeDirectoryIndex)&&(t=t.slice(0,-1),r.pathname=t.slice(1).join("/")+"/")}if(r.hostname&&(r.hostname=r.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(r.hostname)&&(r.hostname=r.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const t of[...r.searchParams.keys()])kh(t,e.removeQueryParameters)&&r.searchParams.delete(t);if(Array.isArray(e.keepQueryParameters)||!0!==e.removeQueryParameters||(r.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const t of[...r.searchParams.keys()])kh(t,e.keepQueryParameters)||r.searchParams.delete(t);if(e.sortQueryParameters){r.searchParams.sort();try{r.search=decodeURIComponent(r.search)}catch{}}e.removeTrailingSlash&&(r.pathname=r.pathname.replace(/\/$/,"")),e.removeExplicitPort&&r.port&&(r.port="");const i=t;return t=r.toString(),e.removeSingleSlash||"/"!==r.pathname||i.endsWith("/")||""!==r.hash||(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||"/"===r.pathname)&&""===r.hash&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}(t.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function Eh(t){const e=new Set;for(const n of t)try{e.add(_h(n))}catch{}return Array.from(e)}Qc(ch(4),Xc("0123456789abcdef"),th(""),nh((t=>{if("string"!=typeof t||t.length%2!=0)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()}))),__webpack_require__(705);var kh=(t,e)=>e.some((e=>e instanceof RegExp?e.test(t):e===t)),Ah=new Set(["https:","http:","file:"]),xh=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!Ah.has(e)}catch{return!1}},Rh=(t,{stripHash:e})=>{const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);let r=n.groups?.type??"",i=n.groups?.data??"",s=n.groups?.hash??"";const o=r.split(";");s=e?"":s;let a=!1;"base64"===o[o.length-1]&&(o.pop(),a=!0);const c=o.shift()?.toLowerCase()??"",h=[...o.map((t=>{let[e,n=""]=t.split("=").map((t=>t.trim()));return"charset"===e&&(n=n.toLowerCase(),"us-ascii"===n)?"":`${e}${n?`=${n}`:""}`})).filter(Boolean)];return a&&h.push("base64"),(h.length>0||c&&"text/plain"!==c)&&h.unshift(c),`data:${h.join(";")},${a?i.trim():i}${s?`#${s}`:""}`},Sh=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,n,r){super(t),this.errors=e,this.publishedToRelays=n,this.intendedRelaySet=r}get relayErrors(){const t=[];for(const[e,n]of this.errors)t.push(`${e.url}: ${n}`);return t.join("\n")}},Ch=class t{relays;debug;ndk;pool;constructor(t,e,n){this.relays=t,this.ndk=e,this.pool=n??e.pool,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map((t=>t.url))}static fromRelayUrls(e,n,r=!0,i){if(!(i=i??n.pool))throw new Error("No pool provided");const s=new Set;for(const t of e){const o=i.relays.get(_h(t));if(o)o.status<5&&r&&o.connect(),s.add(o);else{const r=new sl(_h(t),n?.relayAuthDefaultPolicy,n);i.useTemporaryRelay(r,void 0,"requested from fromRelayUrls "+e),s.add(r)}}return new t(new Set(s),n,i)}async publish(t,e,n=1){const r=new Set,i=new Map,s=t.isEphemeral();t.publishStatus="pending";const o=Array.from(this.relays).map((n=>new Promise((o=>{n.publish(t,e).then((t=>{r.add(n),o()})).catch((t=>{s||i.set(n,t),o()}))}))));if(await Promise.all(o),r.size<n){if(!s){const e=new Sh("Not enough relays received the event",i,r,this);throw t.publishStatus="error",t.publishError=e,this.ndk.emit("event:publish-failed",t,e,this.relayUrls),e}}else t.emit("published",{relaySet:this,publishedToRelays:r});return r}get size(){return this.relays.size}},Th=r("ndk:outbox:calculate");function Ih(t,e,n){return function(t,e,n){const r=new Map,i=new Set;if(e.forEach((t=>{t.authors&&t.authors.forEach((t=>i.add(t)))})),i.size>0){const n=function(t,e,n=2){return bh(t,e,"write",{count:n})}(t,Array.from(i));for(const t of n.keys())r.set(t,[]);for(const t of e)if(t.authors)for(const[e,i]of n.entries()){const n=t.authors.filter((t=>i.includes(t)));r.set(e,[...r.get(e),{...t,authors:n}])}else for(const e of n.keys())r.set(e,[...r.get(e),t])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach((t=>{r.set(t,e)}));return 0===r.size&&n.permanentAndConnectedRelays().slice(0,5).forEach((t=>{r.set(t.url,e)})),r}(t,e,n)}async function Uh(t){return""}function Nh(){if(void 0===this.kind)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function Lh(){if(void 0===this.kind)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function Ph(){if(void 0===this.kind)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var Oh,Bh="nip44";async function Fh(t,e,n=Bh){if(!this.ndk)throw new Error("No NDK instance found!");if(e||(await this.ndk.assertSigner(),e=this.ndk.signer),!t){const e=this.getMatchingTags("p");if(1!==e.length)throw new Error("No recipient could be determined and no explicit recipient was provided");t=this.ndk.getUser({pubkey:e[0][1]})}this.content=await(e?.encrypt(t,this.content,n))}async function zh(t,e,n){if(!this.ndk)throw new Error("No NDK instance found!");e||(await this.ndk.assertSigner(),e=this.ndk.signer),t||(t=this.author),n||(n=this.content.match(/\?iv=/)?"nip04":"nip44"),this.content=await(e?.decrypt(t,this.content,n))}function Dh(t=2){let e=[];return this.onRelays.length>0?e=this.onRelays.map((t=>t.url)):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?Ji.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?Ji.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):Ji.noteEncode(this.tagId())}async function Mh(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new Xh(this.ndk,{kind:(r=this,1===r.kind?6:16)});var r;return n.content=JSON.stringify(this.rawEvent()),n.tag(this),1!==this.kind&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function $h(t){return t.getMatchingTags("e").some((t=>t[3]))}async function Kh(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(0===n.length)return;const[r,i,s]=n[0];return await this.ndk.fetchEvent(i,{},void 0)}async function qh(t){if(!this.ndk)throw new Error("NDK instance not found");const e=function(t,e){e??=t.tagType();const n=t.tags.find((t=>"root"===t[3]));if(!n){if($h(t))return;const n=t.getMatchingTags(e);if(n.length<3)return n[0]}return n}(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function Hh(t){if(!this.ndk)throw new Error("NDK instance not found");const e=function(t,e){e??=t.tagType();let n=t.tags.find((t=>"reply"===t[3]));if(n)return n;if(n||(n=t.tags.find((t=>"root"===t[3]))),!n){if($h(t))return;const n=t.getMatchingTags(e);if(1===n.length)return n[0];if(2===n.length)return n[1]}}(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function jh(t=!1,e=!1){const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}var Vh={},Zh=/^[a-f0-9]{64}$/;function Wh(){if("number"!=typeof this.kind)return!1;if("string"!=typeof this.content)return!1;if("number"!=typeof this.created_at)return!1;if("string"!=typeof this.pubkey)return!1;if(!this.pubkey.match(Zh))return!1;if(!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if("object"==typeof e[t])return!1}return!0}var Gh=new qc.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function Jh(t){if("boolean"==typeof this.signatureVerified)return this.signatureVerified;const e=Gh.get(this.id);if(null!==e)return this.signatureVerified=!!e;try{if(!this.ndk?.asyncSigVerification){const t=ia((new TextEncoder).encode(this.serialize())),e=Kc.verify(this.sig,t,this.pubkey);return e?Gh.set(this.id,this.sig):Gh.set(this.id,!1),this.signatureVerified=e}(async function(t){return new Promise((e=>{const n=t.serialize();let r=!1;Vh[t.id]||(Vh[t.id]={event:t,resolves:[]},r=!0),Vh[t.id].resolves.push(e),r&&Oh.postMessage({serialized:n,id:t.id,sig:t.sig,pubkey:t.pubkey})}))})(this).then((e=>{t&&(this.signatureVerified=e,e&&Gh.set(this.id,this.sig)),e||(this.ndk.emit("event:invalid-sig",this),Gh.set(this.id,!1))}))}catch(t){return this.signatureVerified=!1}}function Yh(){return t=this.serialize(),Vo(ia((new TextEncoder).encode(t)));var t}var Qh=[3],Xh=class t extends n.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let t=[];return this.ndk?t=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&t.push(this.relay),t}publishStatus="success";publishError;constructor(e,n){super(),this.ndk=e,this.created_at=n?.created_at,this.content=n?.content||"",this.tags=n?.tags||[],this.id=n?.id||"",this.sig=n?.sig,this.pubkey=n?.pubkey||"",this.kind=n?.kind,n instanceof t&&(this.relay&&(this.relay=n.relay,this.ndk?.subManager.seenEvent(n.id,this.relay)),this.publishStatus=n.publishStatus,this.publishError=n.publishError)}static deserialize(e,n){return new t(e,function(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};return e.length>=7&&(n.sig=e[6]),e.length>=8&&(n.id=e[7]),n}(n))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(t){this.pubkey=t.pubkey,this._author=t,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const t=this.ndk.getUser({pubkey:this.pubkey});return this._author=t,t}tagExternal(t,e,n){let r=["i"],i=["k"];switch(e){case"url":const n=new URL(t);n.hash="",r.push(n.toString()),i.push(`${n.protocol}//${n.host}`);break;case"hashtag":r.push(`#${t.toLowerCase()}`),i.push("#");break;case"geohash":r.push(`geo:${t.toLowerCase()}`),i.push("geo");break;case"isbn":r.push(`isbn:${t.replace(/-/g,"")}`),i.push("isbn");break;case"podcast:guid":r.push(`podcast:guid:${t}`),i.push("podcast:guid");break;case"podcast:item:guid":r.push(`podcast:item:guid:${t}`),i.push("podcast:item:guid");break;case"podcast:publisher:guid":r.push(`podcast:publisher:guid:${t}`),i.push("podcast:publisher:guid");break;case"isan":r.push(`isan:${t.split("-").slice(0,4).join("-")}`),i.push("isan");break;case"doi":r.push(`doi:${t.toLowerCase()}`),i.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${e}`)}n&&r.push(n),this.tags.push(r),this.tags.push(i)}tag(e,n,r,i){let s=[];if(void 0!==e.fetchProfile){i??="p";const t=[i,e.pubkey];n&&t.push("",n),s.push(t)}else if(e instanceof t){const t=e;r??=t?.pubkey===this.pubkey,s=t.referenceTags(n,r,i);for(const e of t.getMatchingTags("p"))e[1]!==this.pubkey&&(this.tags.find((t=>"p"===t[0]&&t[1]===e[1]))||this.tags.push(["p",e[1]]))}else{if(!Array.isArray(e))throw new Error("Invalid argument",e);s=[e]}this.tags=function(t,e){const n=new Map,r=(t,e)=>t.every(((t,n)=>t===e[n]));return t.concat(e).forEach((t=>{for(const[e,i]of n)if(r(i,t)||r(t,i))return void(t.length>=i.length&&n.set(e,t));n.set((t=>t.join(","))(t),t)})),Array.from(n.values())}(this.tags,s)}async toNostrEvent(t){if(!t&&""===this.pubkey){const t=await(this.ndk?.signer?.user());this.pubkey=t?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:e,tags:n}=await this.generateTags();this.content=e||"",this.tags=n;try{this.id=this.getEventHash()}catch(t){}return this.rawEvent()}serialize=jh.bind(this);getEventHash=Yh.bind(this);validate=Wh.bind(this);verifySignature=Jh.bind(this);isReplaceable=Nh.bind(this);isEphemeral=Lh.bind(this);isParamReplaceable=Ph.bind(this);encode=Dh.bind(this);encrypt=Fh.bind(this);decrypt=zh.bind(this);getMatchingTags(t,e){const n=this.tags.filter((e=>e[0]===t));return void 0===e?n:n.filter((t=>t[3]===e))}hasTag(t,e){return this.tags.some((n=>n[0]===t&&(!e||n[3]===e)))}tagValue(t){const e=this.getMatchingTags(t);if(0!==e.length)return e[0][1]}get alt(){return this.tagValue("alt")}set alt(t){this.removeTag("alt"),t&&this.tags.push(["alt",t])}get dTag(){return this.tagValue("d")}set dTag(t){this.removeTag("d"),t&&this.tags.push(["d",t])}removeTag(t){const e=Array.isArray(t)?t:[t];this.tags=this.tags.filter((t=>!e.includes(t[0])))}async sign(t){t?this.author=await t.user():(this.ndk?.assertSigner(),t=this.ndk.signer);const e=await this.toNostrEvent();return this.sig=await t.sign(e),this.sig}async publishReplaceable(t,e,n){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(t,e,n)}async publish(t,e,n){if(this.sig||await this.sign(),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if(t||(t=this.ndk.devWriteRelaySet||await async function(t,e){const n=new Set,r=await async function(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),mh(t,e,n)}(t,e.pubkey);r&&r.forEach((e=>{const r=t.pool?.getRelay(e);r&&n.add(r)}));let i=e.tags.filter((t=>["a","e"].includes(t[0]))).map((t=>t[2])).filter((t=>t&&t.startsWith("wss://"))).filter((t=>{try{return new URL(t),!0}catch{return!1}})).map((t=>_h(t)));i=Array.from(new Set(i)).slice(0,5),i.forEach((e=>{const r=t.pool?.getRelay(e,!0,!0);r&&(Th("Adding relay hint %s",e),n.add(r))}));const s=e.getMatchingTags("p").map((t=>t[1]));return s.length<5?Array.from(bh(t,s,"read",{preferredRelays:new Set(r)}).keys()).forEach((e=>{const r=t.pool?.getRelay(e,!1,!0);r&&(Th("Adding p-tagged relay %s",e),n.add(r))})):Th("Too many p-tags to consider %d",s.length),t.pool?.permanentAndConnectedRelays().forEach((t=>n.add(t))),new Ch(n,t)}(this.ndk,this)),5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds){const t=this.getMatchingTags("e").map((t=>t[1]));this.ndk.cacheAdapter.deleteEventIds(t)}const r=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent)try{this.ndk.cacheAdapter.addUnpublishedEvent(this,t.relayUrls)}catch(t){console.error("Error adding unpublished event to cache",t)}5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map((t=>t[1]))),this.ndk.subManager.dispatchEvent(r,void 0,!0);const i=await t.publish(this,e,n);return i.forEach((t=>this.ndk?.subManager.seenEvent(this.id,t))),i}async generateTags(){let t=[];const e=await async function(t,e=[]){const n=[],r=t=>{e.find((e=>["q",t[0]].includes(e[0])&&e[1]===t[1]))||e.push(t)};return t=t.replace(/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,(t=>{try{const e=t.split(/(@|nostr:)/)[2],{type:i,data:s}=Ji.decode(e);let o;switch(i){case"npub":o=["p",s];break;case"nprofile":o=["p",s.pubkey];break;case"note":n.push(new Promise((async t=>{r(["e",s,await Uh(),"mention"]),t()})));break;case"nevent":n.push(new Promise((async t=>{const{id:e,author:n}=s;let{relays:i}=s;i&&0!==i.length||(i=[await Uh()]),r(["e",e,i[0],"mention"]),n&&r(["p",n]),t()})));break;case"naddr":n.push(new Promise((async t=>{const e=[s.kind,s.pubkey,s.identifier].join(":");let n=s.relays??[];0===n.length&&(n=[await Uh()]),r(["a",e,n[0],"mention"]),r(["p",s.pubkey]),t()})));break;default:return t}return o&&r(o),`nostr:${e}`}catch(e){return t}})),await Promise.all(n),{content:t=t.replace(/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g,((t,n)=>{const r=["t",n.slice(1)];return e.find((t=>t[0]===r[0]&&t[1]===r[1]))||e.push(r),t})),tags:e}}(this.content,this.tags),n=e.content;if(t=e.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const e=this.tagValue("title");let n=[...Array(e?6:16)].map((()=>Math.random().toString(36)[2])).join("");e&&e.length>0&&(n=e.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+n),t.push(["d",n])}if(this.shouldAddClientTag){const e=["client",this.ndk.clientName??""];this.ndk.clientNip89&&e.push(this.ndk.clientNip89),t.push(e)}else t=t.filter((t=>"client"!==t[0]));return{content:n||"",tags:t}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||Qh.includes(this.kind)||this.isEphemeral()||this.hasTag("client"))}muted(){const t=this.ndk?.mutedIds.get(this.pubkey);if(t&&"p"===t)return"author";const e=this.tagReference(),n=this.ndk?.mutedIds.get(e[1]);return n&&n===e[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const t=this.getMatchingTags("d")[0];return t?t[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return 0===this.kind||3===this.kind||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw new Error("This must only be called on replaceable events");const t=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${t}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(t){let e;return e=this.isParamReplaceable()?["a",this.tagAddress()]:["e",this.tagId()],this.relay?e.push(this.relay.url):e.push(""),e.push(t??""),this.isParamReplaceable()||e.push(this.pubkey),e}referenceTags(t,e,n){let r=[];return r=this.isParamReplaceable()?[[n??"a",this.tagAddress()],[n??"e",this.id]]:[[n??"e",this.id]],r=r.map((e=>("e"===e[0]||t?e.push(this.relay?.url??""):this.relay?.url&&e.push(this.relay?.url),e))),r.forEach((e=>{"e"===e[0]?(e.push(t??""),e.push(this.pubkey)):t&&e.push(t)})),r=[...r,...this.getMatchingTags("h")],e||r.push(...this.author.referenceTags()),r}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async delete(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new t(this.ndk,{kind:5,content:e||""});return r.tag(this,void 0,!0),r.tags.push(["k",this.kind.toString()]),n&&(this.emit("deleted"),await r.publish()),r}fetchTaggedEvent=Kh.bind(this);fetchRootEvent=qh.bind(this);fetchReplyEvent=Hh.bind(this);repost=Mh.bind(this);async react(e,n=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new t(this.ndk,{kind:7,content:e});return r.tag(this),n?await r.publish():await r.sign(),r}get isValid(){return this.validate()}reply(){const e=new t(this.ndk);if(1===this.kind)e.kind=1,this.hasTag("e")?e.tags=[...e.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply")]:e.tag(this,"root");else{e.kind=1111;const t=["A","E","I","P"],n=this.tags.filter((e=>t.includes(e[0])));if(n.length>0){const t=this.tagValue("K");e.tags.push(...n),t&&e.tags.push(["K",t]);const[r,i,s,...o]=this.tagReference(),a=[r,i,...o];e.tags.push(a)}else{const[t,n,r,i]=this.tagReference(),s=[t,n,i??""];"e"===t&&s.push(this.pubkey),e.tags.push(s);const o=[...s];o[0]=o[0].toUpperCase(),e.tags.push(o),e.tags.push(["K",this.kind.toString()]),e.tags.push(["P",this.pubkey])}e.tags.push(["k",this.kind.toString()]),e.tags.push(...this.getMatchingTags("p")),e.tags.push(["p",this.pubkey])}return e}},tl=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;constructor(t,e){this.ndkRelay=t,this._status=1;const n=Math.floor(1e3*Math.random());this.debug=this.ndkRelay.debug.extend("connectivity"+n),this.ndk=e}async connect(t,e=!0){if(2!==this._status&&1!==this._status||this.reconnectTimeout)this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);else{this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout((()=>this.onConnectionError(e)),this.timeoutMs));try{this.updateConnectionStats.attempt(),1===this._status?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(t){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,t),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",1728e5),t}}}disconnect(){this._status=0;try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),5===this._status&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv");try{const e=JSON.parse(t.data),[n,r,...i]=e;switch(n){case"EVENT":{const t=this.openSubs.get(r),n=e[2];return t?void t.onevent(n):void this.debug(`Received event for unknown subscription ${r}`)}case"COUNT":{const t=e[2],n=this.openCountRequests.get(r);return void(n&&(n.resolve(t.count),this.openCountRequests.delete(r)))}case"EOSE":{const t=this.openSubs.get(r);if(!t)return;return void t.oneose(r)}case"OK":{const t=e[2],n=e[3],i=this.openEventPublishes.get(r),s=i?.pop();return i&&s?(t?s.resolve(n):s.reject(new Error(n)),void(0===i.length?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,i))):void this.debug("Received OK for unknown event publish",r)}case"CLOSED":{const t=this.openSubs.get(r);if(!t)return;return void t.onclosed(e[2])}case"NOTICE":return void this.onNotice(e[1]);case"AUTH":return void this.onAuthRequested(e[1])}}catch(t){return void this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t?.stack)}}async onAuthRequested(t){const e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),7!==this._status)if(this._status=6,e){if(this._status>=5){let n;this._status=7;try{n=await e(this.ndkRelay,t)}catch(t){this.debug("Authentication policy threw an error",t),n=!1}if(this.debug("Authentication policy returned",!!n),n instanceof Xh||!0===n){n instanceof Xh&&await this.auth(n);const e=async()=>{if(this._status>=5&&this._status<8){const e=new Xh(this.ndk);e.kind=22242,e.tags=[["relay",this.ndkRelay.url],["challenge",t]],await e.sign(),this.auth(e).then((()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")})).catch((t=>{this._status=6,this.ndkRelay.emit("auth:failed",t),this.debug("Authentication failed",t)}))}else this.debug("Authentication failed, it changed status, status is %d",this._status)};!0===n&&(this.ndk?.signer?e().catch((t=>{console.error("Error authenticating",t)})):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",e))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t);else this.debug("Already authenticating, ignoring")}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return 5===this._status}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!=0)return!1;const e=t.reduce(((t,e)=>t+e),0)/t.length,n=t.map((t=>Math.pow(t-e,2))).reduce(((t,e)=>t+e),0)/t.length;return Math.sqrt(n)<1e3}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping())return this.ndkRelay.emit("flapping",this._connectionStats),void(this._status=3);const e=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout((()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch((e=>{t<5?setTimeout((()=>{this.handleReconnection(t+1)}),1e3*(t+1)^4):this.debug("Reconnect failed")}))}),e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send")):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status)}async auth(t){const e=new Promise(((e,n)=>{const r=this.openEventPublishes.get(t.id)??[];r.push({resolve:e,reject:n}),this.openEventPublishes.set(t.id,r)}));return this.send('["AUTH",'+JSON.stringify(t.rawEvent())+"]"),e}async publish(t){const e=new Promise(((e,n)=>{const r=this.openEventPublishes.get(t.id)??[];r.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+t.id+" twice"),r.push({resolve:e,reject:n}),this.openEventPublishes.set(t.id,r)}));return this.send('["EVENT",'+JSON.stringify(t)+"]"),e}async count(t,e){this.serial++;const n=e?.id||"count:"+this.serial,r=new Promise(((t,e)=>{this.openCountRequests.set(n,{resolve:t,reject:e})}));return this.send('["COUNT","'+n+'",'+JSON.stringify(t).substring(1)),r}close(t,e){this.send('["CLOSE","'+t+'"]');const n=this.openSubs.get(t);this.openSubs.delete(t),n&&n.onclose(e)}req(t){this.send('["REQ","'+t.subId+'",'+JSON.stringify(t.executeFilters).substring(1)),this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},el=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let n;const r=()=>new Promise(((e,n)=>{try{this.publishEvent(t).then((n=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),e(!0)})).catch(n)}catch(t){n(t)}})),i=new Promise(((t,r)=>{n=setTimeout((()=>{n=void 0,r(new Error("Timeout: "+e+"ms"))}),e)})),s=()=>{r().then((t=>o(t))).catch((t=>a(t)))};let o,a;const c=e=>{throw this.ndkRelay.debug("Publish failed",e,t.id),this.ndkRelay.emit("publish:failed",t,e),t.emit("relay:publish:failed",this.ndkRelay,e),e},h=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",s)};return this.ndkRelay.status>=5?Promise.race([r(),i]).catch(c).finally(h):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise(((t,e)=>{o=t,a=e,this.ndkRelay.once("connect",s)})),i]).catch(c).finally(h))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function nl(t){const e=[],n={};return t.filter((t=>!!t.limit)).forEach((t=>e.push(t))),0===(t=t.filter((t=>!t.limit))).length?e:(t.forEach((t=>{Object.entries(t).forEach((([t,e])=>{Array.isArray(e)?void 0===n[t]?n[t]=[...e]:n[t]=Array.from(new Set([...n[t],...e])):n[t]=e}))})),[...e,n])}var rl=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,n){this.relay=t,this.topSubManager=n,this.debug=t.debug.extend("subscription-"+this.id),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId||(this._subId=this.fingerprint.slice(0,15)),this._subId}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),3!==this.status&&t.subId&&(!this._subId||this._subId.length<48)&&(0!==this.status&&1!==this.status||this.addSubIdPart(t.subId)),this.status){case 0:case 1:this.evaluateExecutionPlan(t);break;case 3:console.log("BUG: This should not happen: This subscription needs to catch up with a subscription that was already running",e);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),0===this.items.size){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(4===this.status)return;const t=this.status;if(this.status=4,3===t)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable())return this.status=1,void this.execute();if(t.filters.find((t=>!!t.limit))&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10))return this.status=1,void this.execute();const e=t.groupableDelay,n=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(0===this.status)this.schedule(e,n);else{const t=this.delayType,r=this.fireTime-Date.now();if("at-least"===t&&"at-least"===n)r<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if("at-least"===t&&"at-most"===n)r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if("at-most"===t&&"at-most"===n)r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else{if("at-most"!==t||"at-least"!==n)throw new Error("Unknown delay type combination "+t+" "+n);r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n))}}}schedule(t,e){this.status=1;const n=Date.now();this.fireTime=n+t,this.delayType=e;const r=setTimeout(this.execute.bind(this),t);"at-least"===e&&(this.executionTimer=r)}executeOnRelayReady=()=>{if(2===this.status){if(0===this.items.size)return this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),void this.cleanup();this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}reExecuteAfterAuth=(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s 👉 %s",t,this.subId)}).bind(this);execute(){if(1===this.status){if(!this.relay.connected)return this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),void this.relay.once("ready",this.executeOnRelayReady);this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId)return this.debug("Received EOSE for an abandoned subscription",t,this.subId),void this.relay.close(t);0===this.items.size&&this.close();for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:t.filters,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(t))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map((t=>t.filters));if(!e[0])return this.debug("👀 No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const n=e[0].length;for(let r=0;r<n;r++){const n=e.map((t=>t[r]));t.push(...nl(n))}return t}},il=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let n;if(t.isGroupable()){const r=function(t,e){const n=[];for(const e of t){const t=Object.entries(e||{}).map((([t,e])=>["since","until"].includes(t)?t+":"+e:t)).sort().join("-");n.push(t)}let r=e?"+":"";return r+=n.join("|"),r}(e,t.closeOnEose);r&&(n=(this.subscriptions.get(r)||[]).find((t=>t.status<3))),n??=this.createSubscription(t,e,r)}else n=this.createSubscription(t,e);n.addItem(t,e)}createSubscription(t,e,n){const r=new rl(this.relay,n||null,this.generalSubManager);r.onClose=this.onRelaySubscriptionClose.bind(this);const i=this.subscriptions.get(r.fingerprint)??[];return this.subscriptions.set(r.fingerprint,[...i,r]),r}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?1===e.length?this.subscriptions.delete(t.fingerprint):(e=e.filter((e=>e.id!==t.id)),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},sl=class t extends n.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(t,e,n)=>{if(void 0===t.lowestValidationRatio||void 0===t.targetValidationRatio)return 1;let r=t.validationRatio;if(t.validationRatio>t.targetValidationRatio){const n=e/100;r=Math.max(t.lowestValidationRatio,t.validationRatio-n)}return r<t.validationRatio?r:t.validationRatio};constructor(e,n,i){super(),this.url=_h(e),this.scores=new Map,this.debug=r(`ndk:relay:${e}`),this.connectivity=new tl(this,i),this.connectivity.netDebug=i?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new il(this,i.subManager),this.publisher=new el(this),this.authPolicy=n,this.targetValidationRatio=i?.initialValidationRatio,this.lowestValidationRatio=i?.lowestValidationRatio,this.validationRatioFn=(i?.validationRatioFn??t.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),i||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout((()=>{this.updateValidationRatio()}),3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(t,e=!0){return this.connectivity.connect(t,e)}disconnect(){1!==this.status&&this.connectivity.disconnect()}subscribe(t,e){this.subs.addSubscription(t,e)}async publish(t,e=2500){return this.publisher.publish(t,e)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return 0===this.nonValidatedEventCount?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return!this.trusted&&(void 0===this.targetValidationRatio||this.validationRatio<this.targetValidationRatio)}get connected(){return this.connectivity.connected}req;close},ol=class extends n.EventEmitter{_relays=new Map;autoConnectRelays=new Set;blacklistRelayUrls;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;constructor(t=[],e=[],n,r){super(),this.debug=r??n.debug.extend("pool"),this.ndk=n,this.relayUrls=t,this.blacklistRelayUrls=new Set(e)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const t=new sl(e,void 0,this.ndk);t.connectivity.netDebug=this.ndk.netDebug,this.addRelay(t,!1)}}set name(t){this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,n){const r=this.relays.has(t.url);r||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,n));const i=this.temporaryRelayTimers.get(t.url);if(i&&clearTimeout(i),!r||i){const n=setTimeout((()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)}),e);this.temporaryRelayTimers.set(t.url,n)}}addRelay(t,e=!0){const n=this.relays.has(t.url),r=this.blacklistRelayUrls?.has(t.url),i=t.url.includes("/npub1");let s=!0;const o=t.url;if(n)return;if(r)return void this.debug(`Refusing to add relay ${o}: blacklisted`);if(i)return void this.debug(`Refusing to add relay ${o}: is a filter relay`);if(this.ndk.cacheAdapter?.getRelayStatus){const n=this.ndk.cacheAdapter.getRelayStatus(o);if(n&&n.dontConnectBefore){if(n.dontConnectBefore>Date.now()){const r=n.dontConnectBefore-Date.now();return this.debug(`Refusing to add relay ${o}: delayed connect for ${r}ms`),void setTimeout((()=>{this.addRelay(t,e)}),r)}s=!1}}const a=e=>this.emit("notice",t,e),c=()=>this.handleRelayConnect(o),h=()=>this.handleRelayReady(t),l=()=>this.emit("relay:disconnect",t),u=()=>this.handleFlapping(t),d=e=>this.emit("relay:auth",t,e),f=()=>this.emit("relay:authed",t);t.off("notice",a),t.off("connect",c),t.off("ready",h),t.off("disconnect",l),t.off("flapping",u),t.off("auth",d),t.off("authed",f),t.on("notice",a),t.on("connect",c),t.on("ready",h),t.on("disconnect",l),t.on("flapping",u),t.on("auth",d),t.on("authed",f),t.on("delayed-connect",(e=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+e})})),this.relays.set(o,t),e&&this.autoConnectRelays.add(o),e&&(this.emit("relay:connecting",t),t.connect(void 0,s).catch((t=>{this.debug(`Failed to connect to relay ${o}`,t)})))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const n=this.temporaryRelayTimers.get(t);return n&&(clearTimeout(n),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=_h(t),n=this.relays.get(e);return!!n&&5===n.status}getRelay(t,e=!0,n=!1,r){let i=this.relays.get(_h(t));return i||(i=new sl(t,void 0,this.ndk),i.connectivity.netDebug=this.ndk.netDebug,n?this.useTemporaryRelay(i,3e4,r):this.addRelay(i,e)),i}handleRelayConnect(t){const e=this.relays.get(t);e?(this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")):console.error("NDK BUG: relay not found in pool",{relayUrl:t})}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){const e=[];this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}...`:""}`);const n=new Set(this.autoConnectRelays.keys());this.ndk.explicitRelayUrls?.forEach((t=>{const e=_h(t);n.add(e)}));for(const r of n){const n=this.relays.get(r);if(!n)continue;const i=new Promise(((e,r)=>(this.emit("relay:connecting",n),n.connect(t).then(e).catch(r))));if(t){const r=new Promise(((e,n)=>{setTimeout((()=>n(`Timed out after ${t}ms`)),t)}));e.push(Promise.race([i,r]).catch((t=>{this.debug(`Failed to connect to relay ${n.url}: ${t??"No reason specified"}`)})))}else e.push(i)}t&&setTimeout((()=>{const t=this.stats().connected===this.relays.size,e=this.stats().connected>0;!t&&e&&this.emit("connect")}),t),await Promise.all(e)}checkOnFlappingRelays(){if(this.flappingRelays.size/this.relays.size>=.8)for(const t of this.flappingRelays)this.backoffTimes.set(t,0)}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e*=2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout((()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()}),e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,5===e.status?t.connected++:1===e.status?t.disconnected++:4===e.status&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter((t=>t.status>=5))}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter((t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url)))}urls(){return Array.from(this.relays.keys())}};function al(t){return!(!t.filter.ids||!function(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}(t))}function cl(t){let e;if(t.match(hl)){const[e,n,r]=t.split(":"),i={authors:[n],kinds:[parseInt(e)]};return r&&(i["#d"]=[r]),i}if(t.match(ll))try{switch(e=Ji.decode(t),e.type){case"nevent":{const t={ids:[e.data.id]};return e.data.author&&(t.authors=[e.data.author]),e.data.kind&&(t.kinds=[e.data.kind]),t}case"note":return{ids:[e.data]};case"naddr":const t={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(t["#d"]=[e.data.identifier]),t}}catch(e){console.error("Error decoding",t,e)}return{ids:[t]}}var hl=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,ll=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;var ul={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},dl=class extends n.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;constructor(t,e,n,r,i){if(super(),this.ndk=t,this.pool=n?.pool||t.pool,this.opts={...ul,...n||{}},this.filters=e instanceof Array?e:[e],this.subId=i||n?.subId,this.internalId=Math.random().toString(36).substring(7),this.relaySet=r,this.debug=t.debug.extend(`subscription[${n?.subId??this.internalId}]`),this.skipVerification=n?.skipVerification||!1,this.skipValidation=n?.skipValidation||!1,this.closeOnEose=n?.closeOnEose||!1,this.skipOptimisticPublishEvent=n?.skipOptimisticPublishEvent||!1,"ONLY_CACHE"===this.opts.cacheUsage&&!this.opts.closeOnEose)throw new Error("Cannot use cache-only options with a persistent subscription")}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter((t=>!this.eosesSeen.has(this.pool.getRelay(t,!1,!1)))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return"ONLY_RELAY"!==this.opts?.cacheUsage}shouldQueryRelays(){return"ONLY_CACHE"!==this.opts?.cacheUsage}shouldWaitForCache(){return this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&"PARALLEL"!==this.opts.cacheUsage}async start(){let t;this.shouldQueryCache()&&(t=this.startWithCache(),this.shouldWaitForCache()&&(await t,al(this)))?this.emit("eose",this):this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{this.relayFilters?.has(t.url)||Ih(this.ndk,this.filters,this.pool).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners(),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some((t=>t.authors?.length))}async startWithCache(){if(this.ndk.cacheAdapter?.query){const t=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await t}}startWithRelays(){if(this.relaySet&&0!==this.relaySet.relays.size){this.relayFilters=new Map;for(const t of this.relaySet.relays)this.relayFilters.set(t.url,this.filters)}else this.relayFilters=Ih(this.ndk,this.filters,this.pool);if(this.relayFilters&&0!==this.relayFilters.size)for(const[t,e]of this.relayFilters)this.pool.getRelay(t,!0,!0,e).subscribe(this,e)}eventReceived(t,e,n=!1,r=!1){const i=t.id,s=this.eventFirstSeen.has(i);let o;if(t instanceof Xh&&(o=t),s){const n=Date.now()-(this.eventFirstSeen.get(i)||0);if(this.emit("event:dup",i,e,n,this),e){const n=Gh.get(i);n&&"string"==typeof n&&t.sig===n&&e.addValidatedEvent()}}else{if(o??=new Xh(this.ndk,t),o.ndk=this.ndk,o.relay=e,!n&&!r){if(!this.skipValidation&&!o.isValid)return void this.debug("Event failed validation %s from relay %s",i,e?.url);if(e)if(!1!==e?.shouldValidateEvent()){if(!this.skipVerification){if(!o.verifySignature(!0)&&!this.ndk.asyncSigVerification)return void this.debug("Event failed signature validation",t);e&&e.addValidatedEvent()}}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(o,this.filters,e)}!n&&e&&this.ndk.emit("event",o,e),r&&!0===this.skipOptimisticPublishEvent||(this.emit("event",o,e,this),this.eventFirstSeen.set(i,Date.now()))}this.lastEventReceivedAt=Date.now()}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const n=this.eosesSeen.size===this.relayFilters?.size,r=al(this),i=t=>{this.debug("Performing EOSE: %s %d",t,this.eosed),this.eosed||(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0)};if(r||n)i("query filled or seen all");else if(this.relayFilters){let t=1e3;const n=new Set(this.pool.connectedRelays().map((t=>t.url))),r=Array.from(this.relayFilters.keys()).filter((t=>n.has(t)));if(0===r.length)return;const s=this.eosesSeen.size/r.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:s,seen:this.eosesSeen.size,total:r.length}),this.eosesSeen.size>=2&&s>=.5){if(t*=1-s,0===t)return void i("time to wait was 0");this.eoseTimeout&&clearTimeout(this.eoseTimeout);const n=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,void 0!==e&&e<20?this.eoseTimeout=setTimeout(n,t):i("send eose timeout: "+t)};this.eoseTimeout=setTimeout(n,t)}}}};async function fl(t,e,n=3){if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(r){const t=new Set;return r.tags.forEach((e=>{"p"===e[0]&&t.add(e[1])})),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(t)),[...t].reduce(((t,e)=>{const n=new _l({pubkey:e});return n.ndk=this.ndk,t.add(n),t}),new Set)}return new Set}function pl(t){const e={};let n;try{n=JSON.parse(t.content)}catch(t){throw new Error(`Failed to parse profile event: ${t}`)}return e.created_at=t.created_at,e.profileEvent=JSON.stringify(t.rawEvent()),Object.keys(n).forEach((t=>{switch(t){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.image=n.picture||n.image;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"zapService":e.zapService=n.zapService;break;case"website":e.website=n.website;break;default:e[t]=n[t]}})),e}function gl(t){const e={};for(const[n,r]of Object.entries(t))switch(n){case"username":case"name":e.name=r;break;case"displayName":e.display_name=r;break;case"image":case"picture":e.picture=r;break;case"bio":case"about":e.about=r;break;default:e[n]=r}return JSON.stringify(e)}var yl=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function wl(t,e,n=fetch,r={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter&&t.cacheAdapter.loadNip05){const n=await t.cacheAdapter.loadNip05(e);if("missing"!==n){if(n){const e=new _l({pubkey:n.pubkey,relayUrls:n.relays,nip46Urls:n.nip46});return e.ndk=t,e}if("no-cache"!==r.cache)return null}}const i=e.match(yl);if(!i)return null;const[s,o="_",a]=i;try{const i=await n(`https://${a}/.well-known/nostr.json?name=${o}`,r),{names:s,relays:c,nip46:h}=function(t){const e={names:{}};for(const[n,r]of Object.entries(t.names))"string"==typeof n&&"string"==typeof r&&(e.names[n.toLowerCase()]=r);if(t.relays){e.relays={};for(const[n,r]of Object.entries(t.relays))"string"==typeof n&&Array.isArray(r)&&(e.relays[n]=r.filter((t=>"string"==typeof t)))}if(t.nip46){e.nip46={};for(const[n,r]of Object.entries(t.nip46))"string"==typeof n&&Array.isArray(r)&&(e.nip46[n]=r.filter((t=>"string"==typeof t)))}return e}(await i.json()),l=s[o.toLowerCase()];let u=null;return l&&(u={pubkey:l,relays:c?.[l],nip46:h?.[l]}),t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t.cacheAdapter.saveNip05(e,u),u}catch(n){return t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,n),null}}})}var ml=class t extends Xh{static kind=10019;static kinds=[10019];_p2pk;constructor(t,e){super(t,e),this.kind??=10019}static from(e){return new t(e.ndk,e)}set relays(t){this.tags=this.tags.filter((t=>"relay"!==t[0]));for(const e of t)this.tags.push(["relay",e])}get relays(){const t=[];for(const e of this.tags)"relay"===e[0]&&t.push(e[1]);return t}set mints(t){this.tags=this.tags.filter((t=>"mint"!==t[0]));for(const e of t)this.tags.push(["mint",e])}get mints(){const t=[];for(const e of this.tags)"mint"===e[0]&&t.push(e[1]);return Array.from(new Set(t))}get p2pk(){return this._p2pk||(this._p2pk=this.tagValue("pubkey")??this.pubkey),this._p2pk}set p2pk(t){this._p2pk=t,this.removeTag("pubkey"),t&&this.tags.push(["pubkey",t])}get relaySet(){return Ch.fromRelayUrls(this.relays,this.ndk)}},bl=r("ndk:zapper:ln");async function vl({lud06:t,lud16:e},n){let r;if(e&&!e.startsWith("LNURL")){const[t,n]=e.split("@");r=`https://${n}/.well-known/lnurlp/${t}`}else if(t){const{words:e}=wh.decode(t,1e3),n=wh.fromWords(e);r=new TextDecoder("utf-8").decode(n)}if(!r)throw bl("No zap endpoint found %o",{lud06:t,lud16:e}),new Error("No zap endpoint found");try{const t=n.httpFetch||fetch,e=await t(r);if(200!==e.status){const t=await e.text();throw new Error(`Unable to fetch zap endpoint ${r}: ${t}`)}return await e.json()}catch(t){throw new Error(`Unable to fetch zap endpoint ${r}: ${t}`)}}var _l=class t{ndk;profile;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(t){t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=Ji.npubEncode(this.pubkey)}return this._npub}get nprofile(){return console.log("encoding with pubkey",this.pubkey),Ji.nprofileEncode({pubkey:this.pubkey})}set npub(t){this._npub=t}get hexpubkey(){return this.pubkey}set hexpubkey(t){this._pubkey=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=Ji.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}async getZapInfo(t=!0,e=["nip61","nip57"]){if(!this.ndk)throw new Error("No NDK instance found");const n=[];if(e.includes("nip61")&&n.push(10019),e.includes("nip57")&&n.push(0),0===n.length)return[];let r=await this.ndk.fetchEvents({kinds:n,authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",groupable:!1});r.size<e.length&&(r=await this.ndk.fetchEvents({kinds:n,authors:[this.pubkey]},{cacheUsage:"ONLY_RELAY"}));const i=[],s=Array.from(r).find((t=>10019===t.kind)),o=Array.from(r).find((t=>0===t.kind));if(s){const e=ml.from(s);if(e.mints.length>0&&i.push({type:"nip61",data:{mints:e.mints,relays:e.relays,p2pk:e.p2pk}}),!t)return i}if(o){const t=pl(o),{lud06:e,lud16:n}=t;try{const t=await vl({lud06:e,lud16:n},this.ndk);t&&i.push({type:"nip57",data:t})}catch(t){console.error("Error getting NIP-57 zap spec",t)}}return i}async getZapConfiguration(t){if(t??=this.ndk,!t)throw new Error("No NDK instance found");return await t.queuesZapConfig.add({id:this.pubkey,func:async()=>{if(this.ndk?.cacheAdapter?.loadUsersLNURLDoc){const t=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if("missing"!==t){if(null===t)return;if(t)return t}}let e;try{if(await this.fetchProfile({groupable:!1}),this.profile){const{lud06:n,lud16:r}=this.profile;e=await vl({lud06:n,lud16:r},t)}}catch{}if(this.ndk?.cacheAdapter?.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,e||null),e)return e}})}async getZapperPubkey(){const t=await this.getZapConfiguration();return t?.nostrPubkey}static async fromNip05(e,n,r=!1){if(!n)throw new Error("No NDK instance found");const i={};r&&(i.cache="no-cache");const s=await wl(n,e,n?.httpFetch,i);if(s){const e=new t({pubkey:s.pubkey,relayUrls:s.relays,nip46Urls:s.nip46});return e.ndk=n,e}}async fetchProfile(t,e=!1){if(!this.ndk)throw new Error("NDK not set");this.profile||(this.profile={});let n=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&"ONLY_RELAY"!==t?.cacheUsage){const t=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(t)return this.profile=t,t}!t&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(n=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),t={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),n&&0!==n.size||(n=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},t));const r=Array.from(n).sort(((t,e)=>t.created_at-e.created_at));if(0===r.length)return null;const i=r[0];return this.profile=pl(i),e&&(this.profile.profileEvent=JSON.stringify(i)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile}follows=fl.bind(this);async followSet(t,e,n=3){const r=await this.follows(t,e,n);return new Set(Array.from(r).map((t=>t.pubkey)))}tagReference(){return["p",this.pubkey]}referenceTags(t){const e=[["p",this.pubkey]];return t?(e[0].push("",t),e):e}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner();const t=new Xh(this.ndk,{kind:0,content:gl(this.profile)});await t.publish()}async follow(t,e,n=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,n)),e.has(t))return!1;e.add(t);const r=new Xh(this.ndk,{kind:n});for(const t of e)r.tag(t);return await r.publish(),!0}async unfollow(t,e,n=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,n));const r=new Set;let i=!1;for(const n of e)n.pubkey!==t.pubkey?r.add(n):i=!0;if(!i)return!1;const s=new Xh(this.ndk,{kind:n});for(const t of r)s.tag(t);return await s.publish()}async validateNip05(t){if(!this.ndk)throw new Error("No NDK instance found");const e=await wl(this.ndk,t);return null===e?null:e.pubkey===this.pubkey}},El=class t extends Xh{_encryptedTags;encryptedTagsLength;constructor(t,e){super(t,e),this.kind??=30001}static from(e){return new t(e.ndk,e)}get title(){return this.tagValue("title")||this.tagValue("name")||(3===this.kind?"Contacts":1e4===this.kind?"Mute":10001===this.kind?"Pinned Notes":10002===this.kind?"Relay Metadata":10003===this.kind?"Bookmarks":10004===this.kind?"Communities":10005===this.kind?"Public Chats":10006===this.kind?"Blocked Relays":10007===this.kind?"Search Relays":10050===this.kind?"Direct Message Receive Relays":10015===this.kind?"Interests":10030===this.kind?"Emojis":this.tagValue("d"))}set title(t){this.removeTag(["title","name"]),t&&this.tags.push(["title",t])}get name(){return this.title}set name(t){this.title=t}get description(){return this.tagValue("description")}set description(t){this.removeTag("description"),t&&this.tags.push(["description",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}isEncryptedTagsCacheValid(){return!(!this._encryptedTags||this.encryptedTagsLength!==this.content.length)}async encryptedTags(t=!0){if(t&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const e=await this.ndk.signer.user();try{if(this.content.length>0)try{const t=await this.ndk.signer.decrypt(e,this.content),n=JSON.parse(t);return n&&n[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=n):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch(t){console.log(`error decrypting ${this.content}`)}}catch(t){}return[]}validateTag(t){return!0}getItems(t){return this.tags.filter((e=>e[0]===t))}get items(){return this.tags.filter((t=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(t[0])))}async addItem(t,e=void 0,n=!1,r="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let i;if(t instanceof Xh)i=[t.tagReference(e)];else if(t instanceof _l)i=t.referenceTags();else if(t instanceof sl)i=t.referenceTags();else{if(!Array.isArray(t))throw new Error("Invalid object type");i=[t]}if(e&&i[0].push(e),n){const t=await this.ndk.signer.user(),e=await this.encryptedTags();"top"===r?e.unshift(...i):e.push(...i),this._encryptedTags=e,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(e),await this.encrypt(t)}else"top"===r?this.tags.unshift(...i):this.tags.push(...i);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(t,e=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const n=this.tags.findIndex((e=>e[1]===t));n>=0&&this.tags.splice(n,1);const r=await this.ndk.signer.user(),i=await this.encryptedTags(),s=i.findIndex((e=>e[1]===t));if(s>=0&&(i.splice(s,1),this._encryptedTags=i,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(i),await this.encrypt(r)),e)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(t,e){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(e){const e=await this.ndk.signer.user(),n=await this.encryptedTags();n.splice(t,1),this._encryptedTags=n,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(n),await this.encrypt(e)}else this.tags.splice(t,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(t){return this.items.some((e=>e[1]===t))}filterForItems(){const t=new Set,e=new Map,n=[];for(const n of this.items)if("e"===n[0]&&n[1])t.add(n[1]);else if("a"===n[0]&&n[1]){const[t,r,i]=n[1].split(":");if(!t||!r)continue;const s=`${t}:${r}`,o=e.get(s)||[];o.push(i||""),e.set(s,o)}if(t.size>0&&n.push({ids:Array.from(t)}),e.size>0)for(const[t,r]of e.entries()){const[e,i]=t.split(":");n.push({kinds:[parseInt(e)],authors:[i],"#d":r})}return n}},kl="read",Al="write",xl=class t extends Xh{constructor(t,e){super(t,e),this.kind??=10002}static from(e){return new t(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter((t=>"r"===t[0]||"relay"===t[0])).filter((t=>!t[2]||t[2]&&t[2]===kl)).map((t=>vh(t[1]))).filter((t=>!!t))}set readRelayUrls(t){for(const e of t)this.tags.push(["r",e,kl])}get writeRelayUrls(){return this.tags.filter((t=>"r"===t[0]||"relay"===t[0])).filter((t=>!t[2]||t[2]&&t[2]===Al)).map((t=>vh(t[1]))).filter((t=>!!t))}set writeRelayUrls(t){for(const e of t)this.tags.push(["r",e,Al])}get bothRelayUrls(){return this.tags.filter((t=>"r"===t[0]||"relay"===t[0])).filter((t=>!t[2])).map((t=>t[1]))}set bothRelayUrls(t){for(const e of t)this.tags.push(["r",e])}get relays(){return this.tags.filter((t=>"r"===t[0]||"relay"===t[0])).map((t=>t[1]))}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new Ch(new Set(this.relays.map((t=>this.ndk.pool.getRelay(t)))),this.ndk)}};function Rl(t,e){try{const n=JSON.parse(e.content),r=new xl(t),i=new Set,s=new Set;for(let[t,e]of Object.entries(n)){try{t=_h(t)}catch{continue}if(e){const n=e;n.write&&s.add(t),n.read&&i.add(t)}else i.add(t),s.add(t)}return r.readRelayUrls=Array.from(i),r.writeRelayUrls=Array.from(s),r}catch{}}(class t extends Xh{debug;_proofs=[];static kind=9321;static kinds=[t.kind];constructor(t,e){super(t,e),this.kind??=9321,this.debug=t?.debug.extend("nutzap")??r("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(t){const e=new this(t.ndk,t);try{const t=e.getMatchingTags("proof");t.length?e._proofs=t.map((t=>JSON.parse(t[1]))):e._proofs=JSON.parse(e.content)}catch{return}if(e._proofs&&e._proofs.length)return e}set comment(t){this.content=t??""}get comment(){return this.tagValue("comment")||this.content}set proofs(t){this._proofs=t,this.tags=this.tags.filter((t=>"proof"!==t[0]));for(const e of t)this.tags.push(["proof",JSON.stringify(e)]);this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()])}get proofs(){return this._proofs}get p2pk(){const t=this.proofs[0];try{const e=JSON.parse(t.secret);let n={};if("string"==typeof e?(n=JSON.parse(e),this.debug("stringified payload",t.secret)):"object"==typeof e&&(n=e),"P2PK"===n[0]&&n[1]?.data){const t=n[1].data.slice(2,-1);if(t)return t}}catch(t){this.debug("error parsing p2pk pubkey",t,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(t){this.removeTag("u"),this.tag(["u",t])}get unit(){return this.tagValue("unit")??"msat"}set unit(t){this.removeTag("unit"),t&&this.tag(["unit",t])}get amount(){return 1e3*this.proofs.reduce(((t,e)=>t+e.amount),0)}sender=this.author;set target(t){this.tags=this.tags.filter((t=>"p"!==t[0])),t instanceof Xh&&this.tags.push(t.tagReference())}set recipientPubkey(t){this.removeTag("p"),this.tag(["p",t])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const t=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:t}):new _l({pubkey:t})}get isValid(){let t=0,e=0;for(const n of this.tags)"p"===n[0]&&t++,"u"===n[0]&&e++;return 1===t&&1===e&&this.proofs.length>0}});async function Sl(t,e,n,r,i,s){try{await t.sign(n),i(t)}catch(n){r(`Failed to publish auth event to relay ${e.url}`,n),s(t)}}var Cl=function({ndk:t,signer:e,debug:n}={}){return n??=r("ndk:auth-policies:signIn"),async(r,i)=>{n(`Relay ${r.url} requested authentication, signing in`);const s=new Xh(t);return s.kind=22242,s.tags=[["relay",r.url],["challenge",i]],e??=t?.signer,new Promise((async(i,o)=>{e?await Sl(s,r,e,n,i,o):t?.once("signer:ready",(async t=>{await Sl(s,r,t,n,i,o)}))}))}},Tl=class t{_user;_privateKey;constructor(t){if(t){if("string"==typeof t)if(t.startsWith("nsec1")){const{type:e,data:n}=Ji.decode(t);"nsec"===e&&(this._privateKey=n)}else{if(64!==t.length)throw new Error("Invalid private key provided.");this._privateKey=function(t){if("string"!=typeof t)throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let e=0,i=0;e<n;e++,i+=2){const n=Zo(t.charCodeAt(i)),s=Zo(t.charCodeAt(i+1));if(void 0===n||void 0===s){const e=t[i]+t[i+1];throw new Error('hex string expected, got non-hex character "'+e+'" at index '+i)}r[e]=16*n+s}return r}(t)}else this._privateKey=t;this._privateKey&&(this._user=new _l({pubkey:hr(this._privateKey)}))}}get privateKey(){if(this._privateKey)return Vo(this._privateKey)}static generate(){const e=cr();return new t(e)}async blockUntilReady(){if(!this._user)throw new Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return lr(t,this._privateKey).sig}getConversationKey(t){if(!this._privateKey)throw Error("Attempted to get conversation key without a private key");const e=t.pubkey;return Ys.getConversationKey(this._privateKey,e)}async nip44Encrypt(t,e){const n=this.getConversationKey(t);return await Ys.encrypt(e,n)}async nip44Decrypt(t,e){const n=this.getConversationKey(t);return await Ys.decrypt(e,n)}async encrypt(t,e,n=Bh){return"nip44"===n?this.nip44Encrypt(t,e):this.nip04Encrypt(t,e)}async decrypt(t,e,n=Bh){return"nip44"===n?this.nip44Decrypt(t,e):this.nip04Decrypt(t,e)}async nip04Encrypt(t,e){if(!this._privateKey)throw Error("Attempted to encrypt without a private key");const n=t.pubkey;return await us.encrypt(this._privateKey,n,e)}async nip04Decrypt(t,e){if(!this._privateKey)throw Error("Attempted to decrypt without a private key");const n=t.pubkey;return await us.decrypt(this._privateKey,n,e)}};n.EventEmitter;async function Il(t,e,n=!1){const r=e.outboxPool||e.pool,i=new Set;for(const t of r.relays.values())i.add(t);const s=new Map,o=new Map,a=new Ch(i,e);if(e.cacheAdapter?.locking&&!n){const n=await e.fetchEvents({kinds:[3,10002],authors:t},{cacheUsage:"ONLY_CACHE"});for(const t of n)10002===t.kind&&s.set(t.pubkey,xl.from(t));for(const t of n)if(3===t.kind){if(s.has(t.pubkey))continue;const n=Rl(e,t);n&&o.set(t.pubkey,n)}t=t.filter((t=>!s.has(t)&&!o.has(t)))}if(0===t.length)return s;const c=new Map,h=new Map;return new Promise((async n=>{const i=e.subscribe({kinds:[3,10002],authors:t},{closeOnEose:!0,pool:r,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},a,!1);i.on("event",(t=>{if(10002===t.kind){const e=c.get(t.pubkey);if(e&&e.created_at>t.created_at)return;c.set(t.pubkey,t)}else if(3===t.kind){const e=h.get(t.pubkey);if(e&&e.created_at>t.created_at)return;h.set(t.pubkey,t)}})),i.on("eose",(()=>{for(const t of c.values())s.set(t.pubkey,xl.from(t));for(const n of t){if(s.has(n))continue;const t=h.get(n);if(!t)continue;const r=Rl(e,t);r&&s.set(n,r)}n(s)})),i.start()}))}n.EventEmitter;var Ul=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},Nl=class extends n.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new qc.LRUCache({maxSize:1e5,entryExpirationTimeInMS:12e4})}async trackUsers(t,e=!1){const n=[];for(let r=0;r<t.length;r+=400){const i=t.slice(r,r+400).map((t=>Ll(t))).filter((t=>!this.data.has(t)));if(0!==i.length){for(const t of i)this.data.set(t,new Ul("user"));n.push(new Promise((t=>{Il(i,this.ndk,e).then((t=>{for(const[e,n]of t){let t=this.data.get(e);if(t??=new Ul("user"),n){t.readRelays=new Set(Eh(n.readRelayUrls)),t.writeRelays=new Set(Eh(n.writeRelayUrls));for(const e of t.readRelays)this.ndk.pool.blacklistRelayUrls.has(e)&&t.readRelays.delete(e);for(const e of t.writeRelays)this.ndk.pool.blacklistRelayUrls.has(e)&&t.writeRelays.delete(e);this.data.set(e,t)}}})).finally(t)})))}}return Promise.all(n)}track(t,e,n=!0){const r=Ll(t);e??=function(t){return t instanceof _l?"user":"kind"}(t);let i=this.data.get(r);return i||(i=new Ul(e),t instanceof _l&&this.trackUsers([t])),i}};function Ll(t){return t instanceof _l?t.pubkey:t}function Pl(t){if(!t||""===t)return!1;try{return new URL(t),!0}catch(t){return!1}}async function Ol(t,e,n,r={type:"timeout"}){const i=this.debug.extend("fetch-event-from-tag"),[s,o,a]=t;i("fetching event from tag",t,n={},r);const c=mh(this,e.pubkey);if(c&&c.size>0){i("fetching event from author relays %o",Array.from(c));const t=Ch.fromRelayUrls(Array.from(c),this),e=await this.fetchEvent(o,n,t);if(e)return e}else i("no author relays found for %s",e.pubkey,e);const h=Ih(this,[{ids:[o]}],this.pool);i("fetching event without relay hint",h);const l=await this.fetchEvent(o,n);if(l)return l;if(a&&""!==a){const t=await this.fetchEvent(o,n,this.pool.getRelay(a,!0,!0,[{ids:[o]}]));if(t)return t}let u;const d=Pl(a)?this.pool.getRelay(a,!1,!0,[{ids:[o]}]):void 0,f=new Promise((t=>{this.fetchEvent(o,n,d).then(t)}));if(!Pl(a)||"none"===r.type)return f;const p=new Promise((async t=>{const e=r.relaySet,s=r.timeout??1500,a=new Promise((t=>setTimeout(t,s)));"timeout"===r.type&&await a,u?t(u):(i("fallback fetch triggered"),t(await this.fetchEvent(o,n,e)))}));switch(r.type){case"timeout":return Promise.race([f,p]);case"eose":return u=await f,u||p}}var Bl=class{ndk;spec;url;nip98Required=!1;constructor(t,e){this.url=`https://${t}/.well-known/nostr/nip96.json`,this.ndk=e}async prepareUpload(t,e="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw new Error("Failed to fetch NIP96 spec");let n={};return this.nip98Required&&(n={Authorization:await this.generateNip98Header(this.spec.api_url,e,t)}),{url:this.spec.api_url,headers:n}}async xhrUpload(t,e){const n="POST",{url:r,headers:i}=await this.prepareUpload(e,n);t.open(n,r,!0),i.Authorization&&t.setRequestHeader("Authorization",i.Authorization);const s=new FormData;return s.append("file",e),new Promise(((e,n)=>{t.onload=function(){t.status>=200&&t.status<300?e(JSON.parse(t.responseText)):n(new Error(t.statusText))},t.onerror=function(){n(new Error("Network Error"))},t.send(s)}))}async upload(t){const e="POST",{url:n,headers:r}=await this.prepareUpload(t,e),i=new FormData;i.append("file",t);const s=await this.ndk.httpFetch(this.spec.api_url,{method:e,headers:r,body:i});if(200!==s.status)throw new Error(`Failed to upload file to ${n}`);const o=await s.json();if("success"!==o.status)throw new Error(o.message);return o}validateHttpFetch(){if(!this.ndk)throw new Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw new Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();const t=await this.ndk.httpFetch(this.url);if(200!==t.status)throw new Error(`Failed to fetch NIP96 spec from ${this.url}`);const e=await t.json();if(!e)throw new Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=e,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(t,e,n){const r=new Xh(this.ndk,{kind:27235,tags:[["u",t],["method",e]]});if(["POST","PUT","PATCH"].includes(e)){const t=await this.calculateSha256(n);r.tags.push(["payload",t])}return await r.sign(),`Nostr ${btoa(JSON.stringify(r.rawEvent()))}`}async calculateSha256(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map((t=>t.toString(16).padStart(2,"0"))).join("")}},Fl=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise(((e,n)=>{this.queue.push({...t,func:()=>t.func().then((t=>(e(t),t)),(t=>{throw n(t),t}))}),this.process()}));return this.promises.set(t.id,e),e.finally((()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()})),e}process(){if(this.processing.size>=this.maxConcurrency||0===this.queue.length)return;const t=this.queue.shift();t&&!this.processing.has(t.id)&&(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},zl=class{subscriptions;seenEvents=new Map;debug;constructor(t){this.subscriptions=new Map,this.debug=t.extend("sub-manager")}add(t){this.subscriptions.set(t.internalId,t),t.onStopped&&console.log("SUB-MANAGER BUG: Subscription already had onStopped! 🤔",t.internalId),t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",(()=>{this.subscriptions.delete(t.internalId)}))}seenEvent(t,e){const n=this.seenEvents.get(t)||[];n.push(e),this.seenEvents.set(t,n)}filterMatchingTime=0;filterMatchingCount=0;dispatchEvent(t,e,n=!1){e&&this.seenEvent(t.id,e);const r=this.subscriptions.values(),i=[],s=Date.now();for(const e of r)Ki(e.filters,t)&&i.push(e);this.filterMatchingTime+=Date.now()-s,this.filterMatchingCount+=i.length;for(const e of i)e.eventReceived(t,void 0,!1,n)}},Dl=r("ndk:active-user");async function Ml(t){if(!this.autoConnectUserRelays)return;const e=await async function(t,e){return(await Il([t],e)).get(t)}(t.pubkey,this);if(e){for(const t of e.relays){let e=this.pool.relays.get(t);e||(e=new sl(t,this.relayAuthDefaultPolicy,this),this.pool.addRelay(e))}return e}}async function $l(t){const e=this.outboxPool||this.pool;e.connectedRelays.length>0?Kl.call(this,t):e.once("connect",(()=>{Kl.call(this,t)}))}async function Kl(t){const e=await Ml.call(this,t),n=[{kinds:[10006],authors:[t.pubkey]}];this.autoFetchUserMutelist&&n[0].kinds.push(1e4);const r=e?e.relaySet:void 0,i=this.subscribe(n,{subId:"active-user-settings",closeOnEose:!0},r,!1),s=new Map;i.on("event",(t=>{const e=s.get(t.kind);e&&e.created_at>=t.created_at||s.set(t.kind,t)})),i.on("eose",(()=>{for(const t of s.values())ql.call(this,t)})),i.start()}async function ql(t){10006===t.kind?Hl.call(this,t):1e4===t.kind&&jl.call(this,t)}function Hl(t){const e=El.from(t);for(const t of e.items)this.pool.blacklistRelayUrls.add(t[0]);Dl("Added %d relays to relay blacklist",e.items.length)}function jl(t){const e=El.from(t);for(const t of e.items)this.mutedIds.set(t[1],t[0]);Dl("Added %d users to mute list",e.items.length)}var Vl=["wss://purplepag.es/","wss://nos.lol/"],Zl=["wss://brb.io/","wss://nostr.mutinywallet.com/"],Wl=class extends n.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;mutedIds;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=1;validationRatioFn;subManager;publishingFailureHandled=!1;relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;autoFetchUserMutelist=!0;walletConfig;constructor(t={}){super(),this.debug=t.debug||r("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new zl(this.debug),this.pool=new ol(t.explicitRelayUrls||[],t.blacklistRelayUrls||Zl,this),this.pool.name="main",this.pool.on("relay:auth",(async(t,e)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(t,e)})),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.autoFetchUserMutelist=t.autoFetchUserMutelist??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel&&(this.outboxPool=new ol(t.outboxRelayUrls||Vl,t.blacklistRelayUrls||Zl,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new Nl(this)),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.mutedIds=t.mutedIds||new Map,t.devWriteRelayUrls&&(this.devWriteRelaySet=Ch.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Fl("zaps",3),this.queuesNip05=new Fl("nip05",10),this.signatureVerificationWorker=t.signatureVerificationWorker,this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t,this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this.asyncSigVerification=!!t,t&&((Oh=t).onmessage=t=>{const[e,n]=t.data,r=Vh[e];if(r){delete Vh[e];for(const t of r.resolves)t(n)}else console.error("No record found for event",e)})}addExplicitRelay(t,e,n=!0){let r;return r="string"==typeof t?new sl(t,e,this):t,this.pool.addRelay(r,n),this.explicitRelayUrls.push(r.url),r}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){const e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,t&&e?$l.call(this,t):t||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then((t=>{t.ndk=this,this.activeUser=t}))}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await(this._signer.relays?.(this))),this._signer.relays)&&(await this._signer.relays(this)).forEach((t=>this.pool.addRelay(t)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.debug("Connecting to relays %o",{timeoutMs:t}),Promise.allSettled(e).then((()=>{}))}getUser(t){const e=new _l(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return _l.fromNip05(t,this,e)}subscribe(t,e,n,r=!0){const i=new dl(this,t,e,n);this.subManager.add(i);const s=e?.pool??this.pool;if(n)for(const t of n.relays)s.useTemporaryRelay(t,void 0,i.filters);if(this.outboxPool&&i.hasAuthorsFilter()){const t=i.filters.filter((t=>t.authors&&t.authors?.length>0)).map((t=>t.authors)).flat();this.outboxTracker?.trackUsers(t)}return r&&setTimeout((()=>i.start()),0),i}async publish(t,e,n){return this.debug("Deprecated: Use `event.publish()` instead"),t.publish(e,n)}fetchEventFromTag=Ol.bind(this);async fetchEvent(t,e,n){let r,i;if(n instanceof sl?i=new Ch(new Set([n]),this):n instanceof Ch&&(i=n),!n&&"string"==typeof t&&null===t.match(hl)){const e=function(t,e){try{const n=Ji.decode(t);if(["naddr","nevent"].includes(n?.type)){const t=n.data;if(t?.relays)return t.relays.map((t=>new sl(t,e.relayAuthDefaultPolicy,e)))}}catch(t){}return[]}(t,this);e.length>0&&(i=new Ch(new Set(e),this),i=function(t,e){const n=e.connectedRelays();if(!Array.from(t.relays).some((t=>n.map((t=>t.url)).includes(t.url))))for(const e of n)t.addRelay(e);if(0===n.length)for(const n of e.relays.values())t.addRelay(n);return t}(i,this.pool))}if(r="string"==typeof t?[cl(t)]:Array.isArray(t)?t:[t],0===r.length)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise((t=>{let n=null;const s=this.subscribe(r,{...e||{},closeOnEose:!0},i,!1),o=setTimeout((()=>{s.stop(),t(n)}),1e4);s.on("event",(e=>{e.ndk=this,e.isReplaceable()?(!n||n.created_at<e.created_at)&&(n=e):(clearTimeout(o),t(e))})),s.on("eose",(()=>{clearTimeout(o),t(n)})),s.start()}))}async fetchEvents(t,e,n){return new Promise((r=>{const i=new Map,s=this.subscribe(t,{...e||{},closeOnEose:!0},n,!1);s.on("event",(t=>{t instanceof Xh||(t=new Xh(void 0,t));const e=t.deduplicationKey(),n=i.get(e);var r,s;n&&(s=t,t=(r=n).created_at>s.created_at?r:s),t.ndk=this,i.set(e,t)})),s.on("eose",(()=>{r(new Set(i.values()))})),s.start()}))}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getNip96(t){return new Bl(t,this)}set wallet(t){console.log("setting wallet",{lnPay:t?.lnPay,cashuPay:t?.cashuPay}),t?(this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)):this.walletConfig=void 0}};r("ndk:zapper");n.EventEmitter;const Gl="undefined"!=typeof window;var Jl;!function(t){t[t.TRACE=600]="TRACE",t[t.DEBUG=500]="DEBUG",t[t.INFO=400]="INFO",t[t.WARN=300]="WARN",t[t.ERROR=200]="ERROR",t[t.FATAL=100]="FATAL",t[t.OFF=0]="OFF"}(Jl||(Jl={}));class Yl{level;constructor(t){this.level=t}log(t,e,n,...r){if(this.level&&e>this.level)return;let i="";if(!Gl){const t=new Date;i+=`[${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)} ${("0"+t.getHours()).slice(-2)}:${("0"+t.getMinutes()).slice(-2)}:${("0"+t.getSeconds()).slice(-2)}] `}i+=`[${t.name}] `,Gl||(i+=`[${Jl[e]}] `);const s=n.length?`   ${n.join(",")}`:"";e<=Jl.ERROR?console.error(i,...r,s):e<=Jl.WARN?console.warn(i,...r,s):e<=Jl.INFO?console.info(i,...r,s):console.log(i,...r,s)}}class Ql{endpoint;level;authKey;constructor(t,e,n){this.endpoint=t,this.level=n,this.authKey=e}log(t,e,n,...r){if(this.level&&e>this.level)return;const i=(t,e=new Set)=>{if(t){if(e.has(t))return"[Circular]";e.add(t)}const n=typeof t;if("function"===n)return t.toString()+"\n"+(new Error).stack;if("undefined"===n)return"undefined";if(null===t)return"null";if("string"===n||"number"===n||"bigint"===n||"boolean"===n)return String(t);if(t instanceof Error)return(t.message||t.toString())+"\n"+t.stack;if(t instanceof ArrayBuffer||t instanceof Uint8Array)return"Buffer:"+Array.prototype.map.call(new Uint8Array(t),(t=>("00"+t.toString(16)).slice(-2))).join("");if("object"==n&&Array.isArray(t))return JSON.stringify(t.map((t=>i(t,e))));if(t instanceof Set)return JSON.stringify(Array.from(t).map((t=>i(t,e))));{try{const e=t.toString();if(!e.startsWith("[object")||!e.endsWith("]"))return e}catch(t){console.error(t)}const n={};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=i(t[r],e));return JSON.stringify(n)}},s=Jl[e];let o=new URL(this.endpoint);this.authKey&&o.searchParams.append("authKey",this.authKey),fetch(o.href,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({logger:t.name,tags:n,level:s,message:r.map((t=>i(t))).join(" "),createdAt:(new Date).toISOString()})}).catch((()=>{}))}}class Xl{tags=[];globalTags={};attachments=[];name;level;groupTags=[];constructor(t,e,n,r,i){this.name=t,this.tags.push(...n),this.globalTags=r||{},this.level=e,i&&this.groupTags.push(...i)}addAttachment(t){this.attachments.push(t)}group(t){this.groupTags.push(t)}groupEnd(){this.groupTags.pop()}fork(t){const e=new Xl(this.name,this.level,[...this.tags],this.globalTags,[...this.groupTags,t]);for(const t of this.attachments)e.addAttachment(t);return e}log(t,...e){if(!(t>this.level))for(const n of this.attachments)try{n.log(this,t,[...this.tags,...this.groupTags,...Object.entries(this.globalTags).map((([t,e])=>`${t}:${e}`))],...e)}catch(t){console.error("Error in log attachment",t)}}logLazy(t,e){if("function"!=typeof e)throw new Error("lazy log needs a function to call");if(!(t>this.level))try{const n=e(),r=e=>{e=Array.isArray(e)?e:[e],this.log(t,...e)};n instanceof Promise?n.then(r).catch((t=>this.error("Error in lazy log",t))).catch((t=>console.error("Error in lazy log",t))):r(n)}catch(t){this.error("Error in lazy log",t)}}debug(...t){this.log(Jl.DEBUG,...t)}trace(...t){this.log(Jl.TRACE,...t)}info(...t){this.log(Jl.INFO,...t)}warn(...t){this.log(Jl.WARN,...t)}error(...t){this.log(Jl.ERROR,...t)}fatal(...t){this.log(Jl.FATAL,...t)}debugLazy(t){this.logLazy(Jl.DEBUG,t)}traceLazy(t){this.logLazy(Jl.TRACE,t)}infoLazy(t){this.logLazy(Jl.INFO,t)}warnLazy(t){this.logLazy(Jl.WARN,t)}errorLazy(t){this.logLazy(Jl.ERROR,t)}fatalLazy(t){this.logLazy(Jl.FATAL,t)}}let tu={},eu={};function nu(t,e){null==e?delete tu[t]:tu[t]=e}function ru(t="default",e=[],n){let r="",i="production",s="";try{i="production"}catch(t){console.log(t)}try{r="/write"}catch(t){console.log(t)}try{n=n??"INFO"}catch(t){console.log(t)}try{s=""}catch(t){console.log(t)}r=eu?.endpoint??r,s=eu?.authKey??s,i=eu?.env??i,n=(n=eu?.level??n)??("development"===i?"TRACE":"INFO"),Gl?e.push("frontend"):e.push("backend");const o=new Xl(t,Jl[n],e,tu);if(eu?.attachments)for(const t of eu.attachments)o.addAttachment(t);else"development"===i?(o.addAttachment(new Yl),r&&o.addAttachment(new Ql(r,s))):o.addAttachment(new Yl);return o}"undefined"!=typeof window&&(tu=window?.globalLoggerTags,eu=window?.globalLoggerConfig,tu||(window.globalLoggerTags=tu={}),eu||(window.globalLoggerConfig=eu={})),void 0!==__webpack_require__.g&&(tu=__webpack_require__.g?.globalLoggerTags,tu||(__webpack_require__.g.globalLoggerTags=tu={}),eu=__webpack_require__.g?.globalLoggerConfig,eu||(__webpack_require__.g.globalLoggerConfig=eu={}));const iu=ru("nostrtc:NDKAdapter");class su{ndk;relaySet;signers=new WeakMap;constructor(t,e){this.ndk=t,this.relaySet=e}async getSigner(t){return this.signers.has(t)||this.signers.set(t,new Tl(await t.priv())),this.signers.get(t)}async publishToRelays(t,e,n){const r={created_at:t.created_at||Math.floor(Date.now()/1e3),content:t.content,tags:t.tags,kind:t.kind,pubkey:t.pubkey},i=await this.getSigner(e),s=new Xh(this.ndk,r);if(await s.sign(i),!(s.sig&&s.pubkey&&s.content&&s.created_at&&s.kind))throw new Error("Failed to sign event");const o=n?Ch.fromRelayUrls(n,this.ndk):this.relaySet,a=await o.publish(s);return{id:s.id,sig:s.sig,pubkey:s.pubkey,signatureVerified:s.signatureVerified||!1,content:s.content,created_at:s.created_at,kind:s.kind,tags:s.tags,relays:n?new Set(Array.from(a).map((t=>t.url))):new Set}}async subscribeToRelays(t,e,n,r,i){const s=i?Ch.fromRelayUrls(i,this.ndk):this.relaySet,o=t.map((t=>{const e={ids:t.ids,kinds:t.kinds,authors:t.authors,since:t.since,until:t.until,limit:t.limit,search:t.search};for(const[n,r]of Object.entries(t))n.startsWith("#")&&(e[n]=r);return e})),a=this.ndk.subscribe(o,void 0,s,!1),c={close:async()=>{await a.stop()}};return a.on("event",(async t=>{try{if(e){if(!(t.sig&&t.pubkey&&t.content&&t.created_at&&t.kind))throw new Error("Invalid event");const n={id:t.id,sig:t.sig,pubkey:t.pubkey,signatureVerified:t.signatureVerified||!1,content:t.content,created_at:t.created_at,kind:t.kind,tags:t.tags,relays:new Set(Array.from(s?.relays??[]).map((t=>t.url)))};await e(c,n)}}catch(t){iu.error("Invalid event",t)}})),a.on("close",(async()=>{try{n&&await n(c)}catch(t){iu.error("Invalid event",t)}})),a.on("eose",(async()=>{try{r&&await r(c)}catch(t){iu.error("Invalid event",t)}})),await a.start(),c}async encrypt(t,e,n){const r=await this.getSigner(n),i=new _l({pubkey:t}),s=await(r?.nip04Encrypt(i,e));if(!s)throw new Error("Failed to encrypt");return s}async decrypt(t,e,n){const r=await this.getSigner(n),i=new _l({pubkey:t}),s=await(r?.nip04Decrypt(i,e));if(!s)throw new Error("Failed to decrypt");return s}newKeyPair(t){const e=t?new Tl(t):Tl.generate();return{getPubKey:async()=>(await e.blockUntilReady(),(await e.user()).pubkey),priv:async()=>(await e.blockUntilReady(),e.privateKey||"")}}}let ou;const au=new Uint8Array(16);function cu(){if(!ou){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ou=crypto.getRandomValues.bind(crypto)}return ou(au)}const hu=[];for(let t=0;t<256;++t)hu.push((t+256).toString(16).slice(1));const lu={};function uu(t,e,n,r,i=0){if(t.length<16)throw new Error("Random bytes length must be >= 16");if(r){if(i<0||i+16>r.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`)}else r=new Uint8Array(16),i=0;return e??=Date.now(),n??=127*t[6]<<24|t[7]<<16|t[8]<<8|t[9],r[i++]=e/1099511627776&255,r[i++]=e/4294967296&255,r[i++]=e/16777216&255,r[i++]=e/65536&255,r[i++]=e/256&255,r[i++]=255&e,r[i++]=112|n>>>28&15,r[i++]=n>>>20&255,r[i++]=128|n>>>14&63,r[i++]=n>>>6&255,r[i++]=n<<2&255|3&t[10],r[i++]=t[11],r[i++]=t[12],r[i++]=t[13],r[i++]=t[14],r[i++]=t[15],r}const du=function(t,e,n){let r;if(t)r=uu(t.random??t.rng?.()??cu(),t.msecs,t.seq,e,n);else{const t=Date.now(),i=cu();!function(t,e,n){t.msecs??=-1/0,t.seq??=0,e>t.msecs?(t.seq=n[6]<<23|n[7]<<16|n[8]<<8|n[9],t.msecs=e):(t.seq=t.seq+1|0,0===t.seq&&t.msecs++)}(lu,t,i),r=uu(i,lu.msecs,lu.seq,e,n)}return e?r:function(t,e=0){return(hu[t[e+0]]+hu[t[e+1]]+hu[t[e+2]]+hu[t[e+3]]+"-"+hu[t[e+4]]+hu[t[e+5]]+"-"+hu[t[e+6]]+hu[t[e+7]]+"-"+hu[t[e+8]]+hu[t[e+9]]+"-"+hu[t[e+10]]+hu[t[e+11]]+hu[t[e+12]]+hu[t[e+13]]+hu[t[e+14]]+hu[t[e+15]]).toLowerCase()}(r)},fu={ANNOUNCE_INTERVAL:1e4,PEER_EXPIRATION:3e5,GC_INTERVAL:6e4,KIND:29999,CONNECTING_TIMEOUT:1e4},pu=ru("nostrtc:NostrRTCConnection");var gu;!function(t){t.disconnected="disconnected",t.connecting="connecting",t.connected="connected"}(gu||(gu={}));class yu extends n.EventEmitter{localIceCandidates=[];connectionId;rtcConnection;info;settings;channel;stopped;status;lastStatusUpdate=Date.now();candidateEmissionTimeout;candidateEmissionLoop;isChannelReady=!1;useTURN=!1;static async connect(t){const e=new yu(t,void 0),n=await e.initializeConnection();return{connection:e,description:n}}static async open(t,e,n){const r=new yu(t,e),i=await r.openConnection(n);return{connection:r,description:i}}constructor(t,e,n=fu){super(),this.connectionId=e??du(),this.info=t,this.rtcConnection=new RTCPeerConnection({iceServers:[]}),this.settings=n,this.status=gu.connecting,this.rtcConnection.ondatachannel=t=>{this.setDataChannel(t.channel)};const r=()=>{this.candidateEmissionTimeout&&clearTimeout(this.candidateEmissionTimeout),this.candidateEmissionTimeout=setTimeout((()=>{this.emit("candidates",this,this.localIceCandidates)}),1e3)};this.rtcConnection.onicecandidate=t=>{let e=!1;t.candidate&&(this.localIceCandidates.includes(t.candidate)||(this.localIceCandidates.push(t.candidate),e=!0)),e&&r()},this.rtcConnection.oniceconnectionstatechange=()=>{const t="failed"===this.rtcConnection.iceConnectionState;this.useTURN!==t&&this.emit("p2pState",this,!t),this.useTURN=t},this.candidateEmissionLoop=setInterval((()=>{r()}),1e4),this.on("ready",(async()=>{this.setStatus(gu.connected);const t=await this.getChannel();t.binaryType="arraybuffer",t.addEventListener("message",(t=>{const e=t.data;this.emit("data",this,e)}))}))}setStatus(t){this.status=t,this.lastStatusUpdate=Date.now()}getStatus(){return this.status===gu.connecting&&Date.now()-this.lastStatusUpdate>this.settings.CONNECTING_TIMEOUT?gu.disconnected:this.status}getConnectionId(){return this.connectionId}getInfo(){return this.info}setDataChannel(t){this.channel=t,"open"===this.channel.readyState?this.emit("ready",this):this.channel.addEventListener("open",(()=>{this.emit("ready",this)})),this.channel.addEventListener("close",(()=>{this.emit("close",this)})),this.channel.addEventListener("error",(t=>{this.emit("error",this,t.error)}))}async initializeConnection(){const t=this.rtcConnection.createDataChannel(`nostrtc:${this.connectionId}`);t.binaryType="arraybuffer";const e=await this.rtcConnection.createOffer();return await(this.rtcConnection?.setLocalDescription(e)),this.setDataChannel(t),{sdp:e.sdp,type:e.type}}async openConnection(t){await this.rtcConnection.setRemoteDescription(new RTCSessionDescription(t));const e=await this.rtcConnection.createAnswer();if(!e)throw new Error("No answer");return await(this.rtcConnection?.setLocalDescription(e)),{sdp:e.sdp,type:e.type}}async setRemoteDescription(t){await this.rtcConnection.setRemoteDescription(new RTCSessionDescription(t))}async addRemoteIceCandidates(t){for(const e of t)await(this.rtcConnection?.addIceCandidate(e))}async close(t){this.stopped||(this.stopped=!0,this.channel&&this.channel.close(),this.rtcConnection&&this.rtcConnection.close(),this.setStatus(gu.disconnected),t&&t instanceof Error&&this.emit("error",this,t),this.emit("close",this,t),this.candidateEmissionTimeout&&clearTimeout(this.candidateEmissionTimeout),this.candidateEmissionLoop&&clearInterval(this.candidateEmissionLoop),this.turn&&await this.turn.close())}async getChannel(){if(!this.channel)throw new Error("No channel");const t=this.channel;return"open"!==t.readyState&&await new Promise(((e,n)=>{const r=()=>{t.removeEventListener("open",r),e(void 0)};t.addEventListener("error",(t=>{pu.error("Channel error",t),n(t)})),t.addEventListener("close",(()=>{n(new Error("Channel closed"))})),t.addEventListener("open",r)})),this.isChannelReady||(t.addEventListener("error",(t=>{this.emit("error",this,t.error)})),t.addEventListener("close",(()=>{this.close("Channel closed").catch((t=>{pu.error("Failed to close connection",t)}))})),this.isChannelReady=!0),t}turn;setTURN(t){this.turn=t,this.turn.on("data",((t,e)=>{this.emit("data",this,e)}))}async write(t){this.turn&&this.useTURN?await(this.turn?.write(t)):(await this.getChannel()).send(t)}}function wu(t){let e=t.length;for(;--e>=0;)t[e]=0}const mu=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),bu=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),vu=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),_u=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Eu=new Array(576);wu(Eu);const ku=new Array(60);wu(ku);const Au=new Array(512);wu(Au);const xu=new Array(256);wu(xu);const Ru=new Array(29);wu(Ru);const Su=new Array(30);function Cu(t,e,n,r,i){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=t&&t.length}let Tu,Iu,Uu;function Nu(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}wu(Su);const Lu=t=>t<256?Au[t]:Au[256+(t>>>7)],Pu=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},Ou=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,Pu(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},Bu=(t,e,n)=>{Ou(t,n[2*e],n[2*e+1])},Fu=(t,e)=>{let n=0;do{n|=1&t,t>>>=1,n<<=1}while(--e>0);return n>>>1},zu=(t,e,n)=>{const r=new Array(16);let i,s,o=0;for(i=1;i<=15;i++)o=o+n[i-1]<<1,r[i]=o;for(s=0;s<=e;s++){let e=t[2*s+1];0!==e&&(t[2*s]=Fu(r[e]++,e))}},Du=t=>{let e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},Mu=t=>{t.bi_valid>8?Pu(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},$u=(t,e,n,r)=>{const i=2*e,s=2*n;return t[i]<t[s]||t[i]===t[s]&&r[e]<=r[n]},Ku=(t,e,n)=>{const r=t.heap[n];let i=n<<1;for(;i<=t.heap_len&&(i<t.heap_len&&$u(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!$u(e,r,t.heap[i],t.depth));)t.heap[n]=t.heap[i],n=i,i<<=1;t.heap[n]=r},qu=(t,e,n)=>{let r,i,s,o,a=0;if(0!==t.sym_next)do{r=255&t.pending_buf[t.sym_buf+a++],r+=(255&t.pending_buf[t.sym_buf+a++])<<8,i=t.pending_buf[t.sym_buf+a++],0===r?Bu(t,i,e):(s=xu[i],Bu(t,s+256+1,e),o=mu[s],0!==o&&(i-=Ru[s],Ou(t,i,o)),r--,s=Lu(r),Bu(t,s,n),o=bu[s],0!==o&&(r-=Su[s],Ou(t,r,o)))}while(a<t.sym_next);Bu(t,256,e)},Hu=(t,e)=>{const n=e.dyn_tree,r=e.stat_desc.static_tree,i=e.stat_desc.has_stree,s=e.stat_desc.elems;let o,a,c,h=-1;for(t.heap_len=0,t.heap_max=573,o=0;o<s;o++)0!==n[2*o]?(t.heap[++t.heap_len]=h=o,t.depth[o]=0):n[2*o+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=h<2?++h:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,i&&(t.static_len-=r[2*c+1]);for(e.max_code=h,o=t.heap_len>>1;o>=1;o--)Ku(t,n,o);c=s;do{o=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Ku(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=o,t.heap[--t.heap_max]=a,n[2*c]=n[2*o]+n[2*a],t.depth[c]=(t.depth[o]>=t.depth[a]?t.depth[o]:t.depth[a])+1,n[2*o+1]=n[2*a+1]=c,t.heap[1]=c++,Ku(t,n,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const n=e.dyn_tree,r=e.max_code,i=e.stat_desc.static_tree,s=e.stat_desc.has_stree,o=e.stat_desc.extra_bits,a=e.stat_desc.extra_base,c=e.stat_desc.max_length;let h,l,u,d,f,p,g=0;for(d=0;d<=15;d++)t.bl_count[d]=0;for(n[2*t.heap[t.heap_max]+1]=0,h=t.heap_max+1;h<573;h++)l=t.heap[h],d=n[2*n[2*l+1]+1]+1,d>c&&(d=c,g++),n[2*l+1]=d,l>r||(t.bl_count[d]++,f=0,l>=a&&(f=o[l-a]),p=n[2*l],t.opt_len+=p*(d+f),s&&(t.static_len+=p*(i[2*l+1]+f)));if(0!==g){do{for(d=c-1;0===t.bl_count[d];)d--;t.bl_count[d]--,t.bl_count[d+1]+=2,t.bl_count[c]--,g-=2}while(g>0);for(d=c;0!==d;d--)for(l=t.bl_count[d];0!==l;)u=t.heap[--h],u>r||(n[2*u+1]!==d&&(t.opt_len+=(d-n[2*u+1])*n[2*u],n[2*u+1]=d),l--)}})(t,e),zu(n,h,t.bl_count)},ju=(t,e,n)=>{let r,i,s=-1,o=e[1],a=0,c=7,h=4;for(0===o&&(c=138,h=3),e[2*(n+1)+1]=65535,r=0;r<=n;r++)i=o,o=e[2*(r+1)+1],++a<c&&i===o||(a<h?t.bl_tree[2*i]+=a:0!==i?(i!==s&&t.bl_tree[2*i]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,s=i,0===o?(c=138,h=3):i===o?(c=6,h=3):(c=7,h=4))},Vu=(t,e,n)=>{let r,i,s=-1,o=e[1],a=0,c=7,h=4;for(0===o&&(c=138,h=3),r=0;r<=n;r++)if(i=o,o=e[2*(r+1)+1],!(++a<c&&i===o)){if(a<h)do{Bu(t,i,t.bl_tree)}while(0!=--a);else 0!==i?(i!==s&&(Bu(t,i,t.bl_tree),a--),Bu(t,16,t.bl_tree),Ou(t,a-3,2)):a<=10?(Bu(t,17,t.bl_tree),Ou(t,a-3,3)):(Bu(t,18,t.bl_tree),Ou(t,a-11,7));a=0,s=i,0===o?(c=138,h=3):i===o?(c=6,h=3):(c=7,h=4)}};let Zu=!1;const Wu=(t,e,n,r)=>{Ou(t,0+(r?1:0),3),Mu(t),Pu(t,n),Pu(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var Gu={_tr_init:t=>{Zu||((()=>{let t,e,n,r,i;const s=new Array(16);for(n=0,r=0;r<28;r++)for(Ru[r]=n,t=0;t<1<<mu[r];t++)xu[n++]=r;for(xu[n-1]=r,i=0,r=0;r<16;r++)for(Su[r]=i,t=0;t<1<<bu[r];t++)Au[i++]=r;for(i>>=7;r<30;r++)for(Su[r]=i<<7,t=0;t<1<<bu[r]-7;t++)Au[256+i++]=r;for(e=0;e<=15;e++)s[e]=0;for(t=0;t<=143;)Eu[2*t+1]=8,t++,s[8]++;for(;t<=255;)Eu[2*t+1]=9,t++,s[9]++;for(;t<=279;)Eu[2*t+1]=7,t++,s[7]++;for(;t<=287;)Eu[2*t+1]=8,t++,s[8]++;for(zu(Eu,287,s),t=0;t<30;t++)ku[2*t+1]=5,ku[2*t]=Fu(t,5);Tu=new Cu(Eu,mu,257,286,15),Iu=new Cu(ku,bu,0,30,15),Uu=new Cu(new Array(0),vu,0,19,7)})(),Zu=!0),t.l_desc=new Nu(t.dyn_ltree,Tu),t.d_desc=new Nu(t.dyn_dtree,Iu),t.bl_desc=new Nu(t.bl_tree,Uu),t.bi_buf=0,t.bi_valid=0,Du(t)},_tr_stored_block:Wu,_tr_flush_block:(t,e,n,r)=>{let i,s,o=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,n=4093624447;for(e=0;e<=31;e++,n>>>=1)if(1&n&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<256;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),Hu(t,t.l_desc),Hu(t,t.d_desc),o=(t=>{let e;for(ju(t,t.dyn_ltree,t.l_desc.max_code),ju(t,t.dyn_dtree,t.d_desc.max_code),Hu(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*_u[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),i=t.opt_len+3+7>>>3,s=t.static_len+3+7>>>3,s<=i&&(i=s)):i=s=n+5,n+4<=i&&-1!==e?Wu(t,e,n,r):4===t.strategy||s===i?(Ou(t,2+(r?1:0),3),qu(t,Eu,ku)):(Ou(t,4+(r?1:0),3),((t,e,n,r)=>{let i;for(Ou(t,e-257,5),Ou(t,n-1,5),Ou(t,r-4,4),i=0;i<r;i++)Ou(t,t.bl_tree[2*_u[i]+1],3);Vu(t,t.dyn_ltree,e-1),Vu(t,t.dyn_dtree,n-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,o+1),qu(t,t.dyn_ltree,t.dyn_dtree)),Du(t),r&&Mu(t)},_tr_tally:(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,0===e?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(xu[n]+256+1)]++,t.dyn_dtree[2*Lu(e)]++),t.sym_next===t.sym_end),_tr_align:t=>{Ou(t,2,3),Bu(t,256,Eu),(t=>{16===t.bi_valid?(Pu(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)}},Ju=(t,e,n,r)=>{let i=65535&t,s=t>>>16&65535,o=0;for(;0!==n;){o=n>2e3?2e3:n,n-=o;do{i=i+e[r++]|0,s=s+i|0}while(--o);i%=65521,s%=65521}return i|s<<16};const Yu=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var Qu=(t,e,n,r)=>{const i=Yu,s=r+n;t^=-1;for(let n=r;n<s;n++)t=t>>>8^i[255&(t^e[n])];return~t},Xu={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},td={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:ed,_tr_stored_block:nd,_tr_flush_block:rd,_tr_tally:id,_tr_align:sd}=Gu,{Z_NO_FLUSH:od,Z_PARTIAL_FLUSH:ad,Z_FULL_FLUSH:cd,Z_FINISH:hd,Z_BLOCK:ld,Z_OK:ud,Z_STREAM_END:dd,Z_STREAM_ERROR:fd,Z_DATA_ERROR:pd,Z_BUF_ERROR:gd,Z_DEFAULT_COMPRESSION:yd,Z_FILTERED:wd,Z_HUFFMAN_ONLY:md,Z_RLE:bd,Z_FIXED:vd,Z_DEFAULT_STRATEGY:_d,Z_UNKNOWN:Ed,Z_DEFLATED:kd}=td,Ad=258,xd=262,Rd=42,Sd=113,Cd=666,Td=(t,e)=>(t.msg=Xu[e],e),Id=t=>2*t-(t>4?9:0),Ud=t=>{let e=t.length;for(;--e>=0;)t[e]=0},Nd=t=>{let e,n,r,i=t.w_size;e=t.hash_size,r=e;do{n=t.head[--r],t.head[r]=n>=i?n-i:0}while(--e);e=i,r=e;do{n=t.prev[--r],t.prev[r]=n>=i?n-i:0}while(--e)};let Ld=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const Pd=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),0!==n&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,0===e.pending&&(e.pending_out=0))},Od=(t,e)=>{rd(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Pd(t.strm)},Bd=(t,e)=>{t.pending_buf[t.pending++]=e},Fd=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},zd=(t,e,n,r)=>{let i=t.avail_in;return i>r&&(i=r),0===i?0:(t.avail_in-=i,e.set(t.input.subarray(t.next_in,t.next_in+i),n),1===t.state.wrap?t.adler=Ju(t.adler,e,i,n):2===t.state.wrap&&(t.adler=Qu(t.adler,e,i,n)),t.next_in+=i,t.total_in+=i,i)},Dd=(t,e)=>{let n,r,i=t.max_chain_length,s=t.strstart,o=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-xd?t.strstart-(t.w_size-xd):0,h=t.window,l=t.w_mask,u=t.prev,d=t.strstart+Ad;let f=h[s+o-1],p=h[s+o];t.prev_length>=t.good_match&&(i>>=2),a>t.lookahead&&(a=t.lookahead);do{if(n=e,h[n+o]===p&&h[n+o-1]===f&&h[n]===h[s]&&h[++n]===h[s+1]){s+=2,n++;do{}while(h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&s<d);if(r=Ad-(d-s),s=d-Ad,r>o){if(t.match_start=e,o=r,r>=a)break;f=h[s+o-1],p=h[s+o]}}}while((e=u[e&l])>c&&0!=--i);return o<=t.lookahead?o:t.lookahead},Md=t=>{const e=t.w_size;let n,r,i;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-xd)&&(t.window.set(t.window.subarray(e,e+e-r),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),Nd(t),r+=e),0===t.strm.avail_in)break;if(n=zd(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=n,t.lookahead+t.insert>=3)for(i=t.strstart-t.insert,t.ins_h=t.window[i],t.ins_h=Ld(t,t.ins_h,t.window[i+1]);t.insert&&(t.ins_h=Ld(t,t.ins_h,t.window[i+3-1]),t.prev[i&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=i,i++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<xd&&0!==t.strm.avail_in)},$d=(t,e)=>{let n,r,i,s=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,o=0,a=t.strm.avail_in;do{if(n=65535,i=t.bi_valid+42>>3,t.strm.avail_out<i)break;if(i=t.strm.avail_out-i,r=t.strstart-t.block_start,n>r+t.strm.avail_in&&(n=r+t.strm.avail_in),n>i&&(n=i),n<s&&(0===n&&e!==hd||e===od||n!==r+t.strm.avail_in))break;o=e===hd&&n===r+t.strm.avail_in?1:0,nd(t,0,0,o),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Pd(t.strm),r&&(r>n&&(r=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+r),t.strm.next_out),t.strm.next_out+=r,t.strm.avail_out-=r,t.strm.total_out+=r,t.block_start+=r,n-=r),n&&(zd(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(0===o);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),o?4:e!==od&&e!==hd&&0===t.strm.avail_in&&t.strstart===t.block_start?2:(i=t.window_size-t.strstart,t.strm.avail_in>i&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,i+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),i>t.strm.avail_in&&(i=t.strm.avail_in),i&&(zd(t.strm,t.window,t.strstart,i),t.strstart+=i,t.insert+=i>t.w_size-t.insert?t.w_size-t.insert:i),t.high_water<t.strstart&&(t.high_water=t.strstart),i=t.bi_valid+42>>3,i=t.pending_buf_size-i>65535?65535:t.pending_buf_size-i,s=i>t.w_size?t.w_size:i,r=t.strstart-t.block_start,(r>=s||(r||e===hd)&&e!==od&&0===t.strm.avail_in&&r<=i)&&(n=r>i?i:r,o=e===hd&&0===t.strm.avail_in&&n===r?1:0,nd(t,t.block_start,n,o),t.block_start+=n,Pd(t.strm)),o?3:1)},Kd=(t,e)=>{let n,r;for(;;){if(t.lookahead<xd){if(Md(t),t.lookahead<xd&&e===od)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=Ld(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==n&&t.strstart-n<=t.w_size-xd&&(t.match_length=Dd(t,n)),t.match_length>=3)if(r=id(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=Ld(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Ld(t,t.ins_h,t.window[t.strstart+1]);else r=id(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(Od(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===hd?(Od(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Od(t,!1),0===t.strm.avail_out)?1:2},qd=(t,e)=>{let n,r,i;for(;;){if(t.lookahead<xd){if(Md(t),t.lookahead<xd&&e===od)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=Ld(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==n&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-xd&&(t.match_length=Dd(t,n),t.match_length<=5&&(t.strategy===wd||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-3,r=id(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=i&&(t.ins_h=Ld(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(Od(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(r=id(t,0,t.window[t.strstart-1]),r&&Od(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=id(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===hd?(Od(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Od(t,!1),0===t.strm.avail_out)?1:2};function Hd(t,e,n,r,i){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=r,this.func=i}const jd=[new Hd(0,0,0,0,$d),new Hd(4,4,8,4,Kd),new Hd(4,5,16,8,Kd),new Hd(4,6,32,32,Kd),new Hd(4,4,16,16,qd),new Hd(8,16,32,32,qd),new Hd(8,16,128,128,qd),new Hd(8,32,128,256,qd),new Hd(32,128,258,1024,qd),new Hd(32,258,258,4096,qd)];function Vd(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=kd,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Ud(this.dyn_ltree),Ud(this.dyn_dtree),Ud(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Ud(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Ud(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Zd=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==Rd&&57!==e.status&&69!==e.status&&73!==e.status&&91!==e.status&&103!==e.status&&e.status!==Sd&&e.status!==Cd?1:0},Wd=t=>{if(Zd(t))return Td(t,fd);t.total_in=t.total_out=0,t.data_type=Ed;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=2===e.wrap?57:e.wrap?Rd:Sd,t.adler=2===e.wrap?0:1,e.last_flush=-2,ed(e),ud},Gd=t=>{const e=Wd(t);var n;return e===ud&&((n=t.state).window_size=2*n.w_size,Ud(n.head),n.max_lazy_match=jd[n.level].max_lazy,n.good_match=jd[n.level].good_length,n.nice_match=jd[n.level].nice_length,n.max_chain_length=jd[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),e},Jd=(t,e,n,r,i,s)=>{if(!t)return fd;let o=1;if(e===yd&&(e=6),r<0?(o=0,r=-r):r>15&&(o=2,r-=16),i<1||i>9||n!==kd||r<8||r>15||e<0||e>9||s<0||s>vd||8===r&&1!==o)return Td(t,fd);8===r&&(r=9);const a=new Vd;return t.state=a,a.strm=t,a.status=Rd,a.wrap=o,a.gzhead=null,a.w_bits=r,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=i+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<i+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=s,a.method=n,Gd(t)};var Yd=Jd,Qd=(t,e)=>Zd(t)||2!==t.state.wrap?fd:(t.state.gzhead=e,ud),Xd=(t,e)=>{if(Zd(t)||e>ld||e<0)return t?Td(t,fd):fd;const n=t.state;if(!t.output||0!==t.avail_in&&!t.input||n.status===Cd&&e!==hd)return Td(t,0===t.avail_out?gd:fd);const r=n.last_flush;if(n.last_flush=e,0!==n.pending){if(Pd(t),0===t.avail_out)return n.last_flush=-1,ud}else if(0===t.avail_in&&Id(e)<=Id(r)&&e!==hd)return Td(t,gd);if(n.status===Cd&&0!==t.avail_in)return Td(t,gd);if(n.status===Rd&&0===n.wrap&&(n.status=Sd),n.status===Rd){let e=kd+(n.w_bits-8<<4)<<8,r=-1;if(r=n.strategy>=md||n.level<2?0:n.level<6?1:6===n.level?2:3,e|=r<<6,0!==n.strstart&&(e|=32),e+=31-e%31,Fd(n,e),0!==n.strstart&&(Fd(n,t.adler>>>16),Fd(n,65535&t.adler)),t.adler=1,n.status=Sd,Pd(t),0!==n.pending)return n.last_flush=-1,ud}if(57===n.status)if(t.adler=0,Bd(n,31),Bd(n,139),Bd(n,8),n.gzhead)Bd(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Bd(n,255&n.gzhead.time),Bd(n,n.gzhead.time>>8&255),Bd(n,n.gzhead.time>>16&255),Bd(n,n.gzhead.time>>24&255),Bd(n,9===n.level?2:n.strategy>=md||n.level<2?4:0),Bd(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Bd(n,255&n.gzhead.extra.length),Bd(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Qu(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Bd(n,0),Bd(n,0),Bd(n,0),Bd(n,0),Bd(n,0),Bd(n,9===n.level?2:n.strategy>=md||n.level<2?4:0),Bd(n,3),n.status=Sd,Pd(t),0!==n.pending)return n.last_flush=-1,ud;if(69===n.status){if(n.gzhead.extra){let e=n.pending,r=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+r>n.pending_buf_size;){let i=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>e&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex+=i,Pd(t),0!==n.pending)return n.last_flush=-1,ud;e=0,r-=i}let i=new Uint8Array(n.gzhead.extra);n.pending_buf.set(i.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending+=r,n.gzhead.hcrc&&n.pending>e&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let e,r=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-r,r)),Pd(t),0!==n.pending)return n.last_flush=-1,ud;r=0}e=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Bd(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>r&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let e,r=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-r,r)),Pd(t),0!==n.pending)return n.last_flush=-1,ud;r=0}e=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Bd(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>r&&(t.adler=Qu(t.adler,n.pending_buf,n.pending-r,r))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Pd(t),0!==n.pending))return n.last_flush=-1,ud;Bd(n,255&t.adler),Bd(n,t.adler>>8&255),t.adler=0}if(n.status=Sd,Pd(t),0!==n.pending)return n.last_flush=-1,ud}if(0!==t.avail_in||0!==n.lookahead||e!==od&&n.status!==Cd){let r=0===n.level?$d(n,e):n.strategy===md?((t,e)=>{let n;for(;;){if(0===t.lookahead&&(Md(t),0===t.lookahead)){if(e===od)return 1;break}if(t.match_length=0,n=id(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,n&&(Od(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===hd?(Od(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Od(t,!1),0===t.strm.avail_out)?1:2})(n,e):n.strategy===bd?((t,e)=>{let n,r,i,s;const o=t.window;for(;;){if(t.lookahead<=Ad){if(Md(t),t.lookahead<=Ad&&e===od)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(i=t.strstart-1,r=o[i],r===o[++i]&&r===o[++i]&&r===o[++i])){s=t.strstart+Ad;do{}while(r===o[++i]&&r===o[++i]&&r===o[++i]&&r===o[++i]&&r===o[++i]&&r===o[++i]&&r===o[++i]&&r===o[++i]&&i<s);t.match_length=Ad-(s-i),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(n=id(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(n=id(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),n&&(Od(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===hd?(Od(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Od(t,!1),0===t.strm.avail_out)?1:2})(n,e):jd[n.level].func(n,e);if(3!==r&&4!==r||(n.status=Cd),1===r||3===r)return 0===t.avail_out&&(n.last_flush=-1),ud;if(2===r&&(e===ad?sd(n):e!==ld&&(nd(n,0,0,!1),e===cd&&(Ud(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),Pd(t),0===t.avail_out))return n.last_flush=-1,ud}return e!==hd?ud:n.wrap<=0?dd:(2===n.wrap?(Bd(n,255&t.adler),Bd(n,t.adler>>8&255),Bd(n,t.adler>>16&255),Bd(n,t.adler>>24&255),Bd(n,255&t.total_in),Bd(n,t.total_in>>8&255),Bd(n,t.total_in>>16&255),Bd(n,t.total_in>>24&255)):(Fd(n,t.adler>>>16),Fd(n,65535&t.adler)),Pd(t),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?ud:dd)},tf=t=>{if(Zd(t))return fd;const e=t.state.status;return t.state=null,e===Sd?Td(t,pd):ud},ef=(t,e)=>{let n=e.length;if(Zd(t))return fd;const r=t.state,i=r.wrap;if(2===i||1===i&&r.status!==Rd||r.lookahead)return fd;if(1===i&&(t.adler=Ju(t.adler,e,n,0)),r.wrap=0,n>=r.w_size){0===i&&(Ud(r.head),r.strstart=0,r.block_start=0,r.insert=0);let t=new Uint8Array(r.w_size);t.set(e.subarray(n-r.w_size,n),0),e=t,n=r.w_size}const s=t.avail_in,o=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Md(r);r.lookahead>=3;){let t=r.strstart,e=r.lookahead-2;do{r.ins_h=Ld(r,r.ins_h,r.window[t+3-1]),r.prev[t&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=t,t++}while(--e);r.strstart=t,r.lookahead=2,Md(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,t.next_in=o,t.input=a,t.avail_in=s,r.wrap=i,ud};const nf=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var rf=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const e in n)nf(n,e)&&(t[e]=n[e])}}return t},sf=t=>{let e=0;for(let n=0,r=t.length;n<r;n++)e+=t[n].length;const n=new Uint8Array(e);for(let e=0,r=0,i=t.length;e<i;e++){let i=t[e];n.set(i,r),r+=i.length}return n};let of=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){of=!1}const af=new Uint8Array(256);for(let t=0;t<256;t++)af[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;af[254]=af[254]=1;var cf=t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,n,r,i,s,o=t.length,a=0;for(i=0;i<o;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<o&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),s=0,i=0;s<a;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<o&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),n<128?e[s++]=n:n<2048?(e[s++]=192|n>>>6,e[s++]=128|63&n):n<65536?(e[s++]=224|n>>>12,e[s++]=128|n>>>6&63,e[s++]=128|63&n):(e[s++]=240|n>>>18,e[s++]=128|n>>>12&63,e[s++]=128|n>>>6&63,e[s++]=128|63&n);return e},hf=(t,e)=>{const n=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let r,i;const s=new Array(2*n);for(i=0,r=0;r<n;){let e=t[r++];if(e<128){s[i++]=e;continue}let o=af[e];if(o>4)s[i++]=65533,r+=o-1;else{for(e&=2===o?31:3===o?15:7;o>1&&r<n;)e=e<<6|63&t[r++],o--;o>1?s[i++]=65533:e<65536?s[i++]=e:(e-=65536,s[i++]=55296|e>>10&1023,s[i++]=56320|1023&e)}}return((t,e)=>{if(e<65534&&t.subarray&&of)return String.fromCharCode.apply(null,t.length===e?t:t.subarray(0,e));let n="";for(let r=0;r<e;r++)n+=String.fromCharCode(t[r]);return n})(s,i)},lf=(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&128==(192&t[n]);)n--;return n<0||0===n?e:n+af[t[n]]>e?n:e},uf=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const df=Object.prototype.toString,{Z_NO_FLUSH:ff,Z_SYNC_FLUSH:pf,Z_FULL_FLUSH:gf,Z_FINISH:yf,Z_OK:wf,Z_STREAM_END:mf,Z_DEFAULT_COMPRESSION:bf,Z_DEFAULT_STRATEGY:vf,Z_DEFLATED:_f}=td;function Ef(t){this.options=rf({level:bf,method:_f,chunkSize:16384,windowBits:15,memLevel:8,strategy:vf},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new uf,this.strm.avail_out=0;let n=Yd(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==wf)throw new Error(Xu[n]);if(e.header&&Qd(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?cf(e.dictionary):"[object ArrayBuffer]"===df.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,n=ef(this.strm,t),n!==wf)throw new Error(Xu[n]);this._dict_set=!0}}function kf(t,e){const n=new Ef(e);if(n.push(t,!0),n.err)throw n.msg||Xu[n.err];return n.result}Ef.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize;let i,s;if(this.ended)return!1;for(s=e===~~e?e:!0===e?yf:ff,"string"==typeof t?n.input=cf(t):"[object ArrayBuffer]"===df.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),(s===pf||s===gf)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(i=Xd(n,s),i===mf)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=tf(this.strm),this.onEnd(i),this.ended=!0,i===wf;if(0!==n.avail_out){if(s>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},Ef.prototype.onData=function(t){this.chunks.push(t)},Ef.prototype.onEnd=function(t){t===wf&&(this.result=sf(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var Af={Deflate:Ef,deflate:kf,deflateRaw:function(t,e){return(e=e||{}).raw=!0,kf(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,kf(t,e)},constants:td};const xf=16209;var Rf=function(t,e){let n,r,i,s,o,a,c,h,l,u,d,f,p,g,y,w,m,b,v,_,E,k,A,x;const R=t.state;n=t.next_in,A=t.input,r=n+(t.avail_in-5),i=t.next_out,x=t.output,s=i-(e-t.avail_out),o=i+(t.avail_out-257),a=R.dmax,c=R.wsize,h=R.whave,l=R.wnext,u=R.window,d=R.hold,f=R.bits,p=R.lencode,g=R.distcode,y=(1<<R.lenbits)-1,w=(1<<R.distbits)-1;t:do{f<15&&(d+=A[n++]<<f,f+=8,d+=A[n++]<<f,f+=8),m=p[d&y];e:for(;;){if(b=m>>>24,d>>>=b,f-=b,b=m>>>16&255,0===b)x[i++]=65535&m;else{if(!(16&b)){if(64&b){if(32&b){R.mode=16191;break t}t.msg="invalid literal/length code",R.mode=xf;break t}m=p[(65535&m)+(d&(1<<b)-1)];continue e}for(v=65535&m,b&=15,b&&(f<b&&(d+=A[n++]<<f,f+=8),v+=d&(1<<b)-1,d>>>=b,f-=b),f<15&&(d+=A[n++]<<f,f+=8,d+=A[n++]<<f,f+=8),m=g[d&w];;){if(b=m>>>24,d>>>=b,f-=b,b=m>>>16&255,16&b){if(_=65535&m,b&=15,f<b&&(d+=A[n++]<<f,f+=8,f<b&&(d+=A[n++]<<f,f+=8)),_+=d&(1<<b)-1,_>a){t.msg="invalid distance too far back",R.mode=xf;break t}if(d>>>=b,f-=b,b=i-s,_>b){if(b=_-b,b>h&&R.sane){t.msg="invalid distance too far back",R.mode=xf;break t}if(E=0,k=u,0===l){if(E+=c-b,b<v){v-=b;do{x[i++]=u[E++]}while(--b);E=i-_,k=x}}else if(l<b){if(E+=c+l-b,b-=l,b<v){v-=b;do{x[i++]=u[E++]}while(--b);if(E=0,l<v){b=l,v-=b;do{x[i++]=u[E++]}while(--b);E=i-_,k=x}}}else if(E+=l-b,b<v){v-=b;do{x[i++]=u[E++]}while(--b);E=i-_,k=x}for(;v>2;)x[i++]=k[E++],x[i++]=k[E++],x[i++]=k[E++],v-=3;v&&(x[i++]=k[E++],v>1&&(x[i++]=k[E++]))}else{E=i-_;do{x[i++]=x[E++],x[i++]=x[E++],x[i++]=x[E++],v-=3}while(v>2);v&&(x[i++]=x[E++],v>1&&(x[i++]=x[E++]))}break}if(64&b){t.msg="invalid distance code",R.mode=xf;break t}m=g[(65535&m)+(d&(1<<b)-1)]}}break}}while(n<r&&i<o);v=f>>3,n-=v,f-=v<<3,d&=(1<<f)-1,t.next_in=n,t.next_out=i,t.avail_in=n<r?r-n+5:5-(n-r),t.avail_out=i<o?o-i+257:257-(i-o),R.hold=d,R.bits=f};const Sf=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Cf=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Tf=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),If=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Uf=(t,e,n,r,i,s,o,a)=>{const c=a.bits;let h,l,u,d,f,p,g=0,y=0,w=0,m=0,b=0,v=0,_=0,E=0,k=0,A=0,x=null;const R=new Uint16Array(16),S=new Uint16Array(16);let C,T,I,U=null;for(g=0;g<=15;g++)R[g]=0;for(y=0;y<r;y++)R[e[n+y]]++;for(b=c,m=15;m>=1&&0===R[m];m--);if(b>m&&(b=m),0===m)return i[s++]=20971520,i[s++]=20971520,a.bits=1,0;for(w=1;w<m&&0===R[w];w++);for(b<w&&(b=w),E=1,g=1;g<=15;g++)if(E<<=1,E-=R[g],E<0)return-1;if(E>0&&(0===t||1!==m))return-1;for(S[1]=0,g=1;g<15;g++)S[g+1]=S[g]+R[g];for(y=0;y<r;y++)0!==e[n+y]&&(o[S[e[n+y]]++]=y);if(0===t?(x=U=o,p=20):1===t?(x=Sf,U=Cf,p=257):(x=Tf,U=If,p=0),A=0,y=0,g=w,f=s,v=b,_=0,u=-1,k=1<<b,d=k-1,1===t&&k>852||2===t&&k>592)return 1;for(;;){C=g-_,o[y]+1<p?(T=0,I=o[y]):o[y]>=p?(T=U[o[y]-p],I=x[o[y]-p]):(T=96,I=0),h=1<<g-_,l=1<<v,w=l;do{l-=h,i[f+(A>>_)+l]=C<<24|T<<16|I}while(0!==l);for(h=1<<g-1;A&h;)h>>=1;if(0!==h?(A&=h-1,A+=h):A=0,y++,0==--R[g]){if(g===m)break;g=e[n+o[y]]}if(g>b&&(A&d)!==u){for(0===_&&(_=b),f+=w,v=g-_,E=1<<v;v+_<m&&(E-=R[v+_],!(E<=0));)v++,E<<=1;if(k+=1<<v,1===t&&k>852||2===t&&k>592)return 1;u=A&d,i[u]=b<<24|v<<16|f-s}}return 0!==A&&(i[f+A]=g-_<<24|64<<16),a.bits=b,0};const{Z_FINISH:Nf,Z_BLOCK:Lf,Z_TREES:Pf,Z_OK:Of,Z_STREAM_END:Bf,Z_NEED_DICT:Ff,Z_STREAM_ERROR:zf,Z_DATA_ERROR:Df,Z_MEM_ERROR:Mf,Z_BUF_ERROR:$f,Z_DEFLATED:Kf}=td,qf=16180,Hf=16190,jf=16191,Vf=16192,Zf=16194,Wf=16199,Gf=16200,Jf=16206,Yf=16209,Qf=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function Xf(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const tp=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<qf||e.mode>16211?1:0},ep=t=>{if(tp(t))return zf;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=qf,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Of},np=t=>{if(tp(t))return zf;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,ep(t)},rp=(t,e)=>{let n;if(tp(t))return zf;const r=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?zf:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=n,r.wbits=e,np(t))},ip=(t,e)=>{if(!t)return zf;const n=new Xf;t.state=n,n.strm=t,n.window=null,n.mode=qf;const r=rp(t,e);return r!==Of&&(t.state=null),r};let sp,op,ap=!0;const cp=t=>{if(ap){sp=new Int32Array(512),op=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Uf(1,t.lens,0,288,sp,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Uf(2,t.lens,0,32,op,0,t.work,{bits:5}),ap=!1}t.lencode=sp,t.lenbits=9,t.distcode=op,t.distbits=5},hp=(t,e,n,r)=>{let i;const s=t.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),r>=s.wsize?(s.window.set(e.subarray(n-s.wsize,n),0),s.wnext=0,s.whave=s.wsize):(i=s.wsize-s.wnext,i>r&&(i=r),s.window.set(e.subarray(n-r,n-r+i),s.wnext),(r-=i)?(s.window.set(e.subarray(n-r,n),0),s.wnext=r,s.whave=s.wsize):(s.wnext+=i,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=i))),0};var lp=np,up=ip,dp=(t,e)=>{let n,r,i,s,o,a,c,h,l,u,d,f,p,g,y,w,m,b,v,_,E,k,A=0;const x=new Uint8Array(4);let R,S;const C=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(tp(t)||!t.output||!t.input&&0!==t.avail_in)return zf;n=t.state,n.mode===jf&&(n.mode=Vf),o=t.next_out,i=t.output,c=t.avail_out,s=t.next_in,r=t.input,a=t.avail_in,h=n.hold,l=n.bits,u=a,d=c,k=Of;t:for(;;)switch(n.mode){case qf:if(0===n.wrap){n.mode=Vf;break}for(;l<16;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(2&n.wrap&&35615===h){0===n.wbits&&(n.wbits=15),n.check=0,x[0]=255&h,x[1]=h>>>8&255,n.check=Qu(n.check,x,2,0),h=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&h)<<8)+(h>>8))%31){t.msg="incorrect header check",n.mode=Yf;break}if((15&h)!==Kf){t.msg="unknown compression method",n.mode=Yf;break}if(h>>>=4,l-=4,E=8+(15&h),0===n.wbits&&(n.wbits=E),E>15||E>n.wbits){t.msg="invalid window size",n.mode=Yf;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&h?16189:jf,h=0,l=0;break;case 16181:for(;l<16;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(n.flags=h,(255&n.flags)!==Kf){t.msg="unknown compression method",n.mode=Yf;break}if(57344&n.flags){t.msg="unknown header flags set",n.mode=Yf;break}n.head&&(n.head.text=h>>8&1),512&n.flags&&4&n.wrap&&(x[0]=255&h,x[1]=h>>>8&255,n.check=Qu(n.check,x,2,0)),h=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.head&&(n.head.time=h),512&n.flags&&4&n.wrap&&(x[0]=255&h,x[1]=h>>>8&255,x[2]=h>>>16&255,x[3]=h>>>24&255,n.check=Qu(n.check,x,4,0)),h=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.head&&(n.head.xflags=255&h,n.head.os=h>>8),512&n.flags&&4&n.wrap&&(x[0]=255&h,x[1]=h>>>8&255,n.check=Qu(n.check,x,2,0)),h=0,l=0,n.mode=16184;case 16184:if(1024&n.flags){for(;l<16;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.length=h,n.head&&(n.head.extra_len=h),512&n.flags&&4&n.wrap&&(x[0]=255&h,x[1]=h>>>8&255,n.check=Qu(n.check,x,2,0)),h=0,l=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(f=n.length,f>a&&(f=a),f&&(n.head&&(E=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(r.subarray(s,s+f),E)),512&n.flags&&4&n.wrap&&(n.check=Qu(n.check,r,f,s)),a-=f,s+=f,n.length-=f),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(0===a)break t;f=0;do{E=r[s+f++],n.head&&E&&n.length<65536&&(n.head.name+=String.fromCharCode(E))}while(E&&f<a);if(512&n.flags&&4&n.wrap&&(n.check=Qu(n.check,r,f,s)),a-=f,s+=f,E)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(0===a)break t;f=0;do{E=r[s+f++],n.head&&E&&n.length<65536&&(n.head.comment+=String.fromCharCode(E))}while(E&&f<a);if(512&n.flags&&4&n.wrap&&(n.check=Qu(n.check,r,f,s)),a-=f,s+=f,E)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;l<16;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(4&n.wrap&&h!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Yf;break}h=0,l=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=jf;break;case 16189:for(;l<32;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}t.adler=n.check=Qf(h),h=0,l=0,n.mode=Hf;case Hf:if(0===n.havedict)return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=h,n.bits=l,Ff;t.adler=n.check=1,n.mode=jf;case jf:if(e===Lf||e===Pf)break t;case Vf:if(n.last){h>>>=7&l,l-=7&l,n.mode=Jf;break}for(;l<3;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}switch(n.last=1&h,h>>>=1,l-=1,3&h){case 0:n.mode=16193;break;case 1:if(cp(n),n.mode=Wf,e===Pf){h>>>=2,l-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=Yf}h>>>=2,l-=2;break;case 16193:for(h>>>=7&l,l-=7&l;l<32;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if((65535&h)!=(h>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Yf;break}if(n.length=65535&h,h=0,l=0,n.mode=Zf,e===Pf)break t;case Zf:n.mode=16195;case 16195:if(f=n.length,f){if(f>a&&(f=a),f>c&&(f=c),0===f)break t;i.set(r.subarray(s,s+f),o),a-=f,s+=f,c-=f,o+=f,n.length-=f;break}n.mode=jf;break;case 16196:for(;l<14;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(n.nlen=257+(31&h),h>>>=5,l-=5,n.ndist=1+(31&h),h>>>=5,l-=5,n.ncode=4+(15&h),h>>>=4,l-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Yf;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.lens[C[n.have++]]=7&h,h>>>=3,l-=3}for(;n.have<19;)n.lens[C[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,R={bits:n.lenbits},k=Uf(0,n.lens,0,19,n.lencode,0,n.work,R),n.lenbits=R.bits,k){t.msg="invalid code lengths set",n.mode=Yf;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;A=n.lencode[h&(1<<n.lenbits)-1],y=A>>>24,w=A>>>16&255,m=65535&A,!(y<=l);){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(m<16)h>>>=y,l-=y,n.lens[n.have++]=m;else{if(16===m){for(S=y+2;l<S;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(h>>>=y,l-=y,0===n.have){t.msg="invalid bit length repeat",n.mode=Yf;break}E=n.lens[n.have-1],f=3+(3&h),h>>>=2,l-=2}else if(17===m){for(S=y+3;l<S;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}h>>>=y,l-=y,E=0,f=3+(7&h),h>>>=3,l-=3}else{for(S=y+7;l<S;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}h>>>=y,l-=y,E=0,f=11+(127&h),h>>>=7,l-=7}if(n.have+f>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Yf;break}for(;f--;)n.lens[n.have++]=E}}if(n.mode===Yf)break;if(0===n.lens[256]){t.msg="invalid code -- missing end-of-block",n.mode=Yf;break}if(n.lenbits=9,R={bits:n.lenbits},k=Uf(1,n.lens,0,n.nlen,n.lencode,0,n.work,R),n.lenbits=R.bits,k){t.msg="invalid literal/lengths set",n.mode=Yf;break}if(n.distbits=6,n.distcode=n.distdyn,R={bits:n.distbits},k=Uf(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,R),n.distbits=R.bits,k){t.msg="invalid distances set",n.mode=Yf;break}if(n.mode=Wf,e===Pf)break t;case Wf:n.mode=Gf;case Gf:if(a>=6&&c>=258){t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=h,n.bits=l,Rf(t,d),o=t.next_out,i=t.output,c=t.avail_out,s=t.next_in,r=t.input,a=t.avail_in,h=n.hold,l=n.bits,n.mode===jf&&(n.back=-1);break}for(n.back=0;A=n.lencode[h&(1<<n.lenbits)-1],y=A>>>24,w=A>>>16&255,m=65535&A,!(y<=l);){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(w&&!(240&w)){for(b=y,v=w,_=m;A=n.lencode[_+((h&(1<<b+v)-1)>>b)],y=A>>>24,w=A>>>16&255,m=65535&A,!(b+y<=l);){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}h>>>=b,l-=b,n.back+=b}if(h>>>=y,l-=y,n.back+=y,n.length=m,0===w){n.mode=16205;break}if(32&w){n.back=-1,n.mode=jf;break}if(64&w){t.msg="invalid literal/length code",n.mode=Yf;break}n.extra=15&w,n.mode=16201;case 16201:if(n.extra){for(S=n.extra;l<S;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.length+=h&(1<<n.extra)-1,h>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;A=n.distcode[h&(1<<n.distbits)-1],y=A>>>24,w=A>>>16&255,m=65535&A,!(y<=l);){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(!(240&w)){for(b=y,v=w,_=m;A=n.distcode[_+((h&(1<<b+v)-1)>>b)],y=A>>>24,w=A>>>16&255,m=65535&A,!(b+y<=l);){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}h>>>=b,l-=b,n.back+=b}if(h>>>=y,l-=y,n.back+=y,64&w){t.msg="invalid distance code",n.mode=Yf;break}n.offset=m,n.extra=15&w,n.mode=16203;case 16203:if(n.extra){for(S=n.extra;l<S;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}n.offset+=h&(1<<n.extra)-1,h>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Yf;break}n.mode=16204;case 16204:if(0===c)break t;if(f=d-c,n.offset>f){if(f=n.offset-f,f>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Yf;break}f>n.wnext?(f-=n.wnext,p=n.wsize-f):p=n.wnext-f,f>n.length&&(f=n.length),g=n.window}else g=i,p=o-n.offset,f=n.length;f>c&&(f=c),c-=f,n.length-=f;do{i[o++]=g[p++]}while(--f);0===n.length&&(n.mode=Gf);break;case 16205:if(0===c)break t;i[o++]=n.length,c--,n.mode=Gf;break;case Jf:if(n.wrap){for(;l<32;){if(0===a)break t;a--,h|=r[s++]<<l,l+=8}if(d-=c,t.total_out+=d,n.total+=d,4&n.wrap&&d&&(t.adler=n.check=n.flags?Qu(n.check,i,d,o-d):Ju(n.check,i,d,o-d)),d=c,4&n.wrap&&(n.flags?h:Qf(h))!==n.check){t.msg="incorrect data check",n.mode=Yf;break}h=0,l=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;l<32;){if(0===a)break t;a--,h+=r[s++]<<l,l+=8}if(4&n.wrap&&h!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Yf;break}h=0,l=0}n.mode=16208;case 16208:k=Bf;break t;case Yf:k=Df;break t;case 16210:return Mf;default:return zf}return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=h,n.bits=l,(n.wsize||d!==t.avail_out&&n.mode<Yf&&(n.mode<Jf||e!==Nf))&&hp(t,t.output,t.next_out,d-t.avail_out),u-=t.avail_in,d-=t.avail_out,t.total_in+=u,t.total_out+=d,n.total+=d,4&n.wrap&&d&&(t.adler=n.check=n.flags?Qu(n.check,i,d,t.next_out-d):Ju(n.check,i,d,t.next_out-d)),t.data_type=n.bits+(n.last?64:0)+(n.mode===jf?128:0)+(n.mode===Wf||n.mode===Zf?256:0),(0===u&&0===d||e===Nf)&&k===Of&&(k=$f),k},fp=t=>{if(tp(t))return zf;let e=t.state;return e.window&&(e.window=null),t.state=null,Of},pp=(t,e)=>{if(tp(t))return zf;const n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,Of):zf},gp=(t,e)=>{const n=e.length;let r,i,s;return tp(t)?zf:(r=t.state,0!==r.wrap&&r.mode!==Hf?zf:r.mode===Hf&&(i=1,i=Ju(i,e,n,0),i!==r.check)?Df:(s=hp(t,e,n,n),s?(r.mode=16210,Mf):(r.havedict=1,Of)))},yp=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const wp=Object.prototype.toString,{Z_NO_FLUSH:mp,Z_FINISH:bp,Z_OK:vp,Z_STREAM_END:_p,Z_NEED_DICT:Ep,Z_STREAM_ERROR:kp,Z_DATA_ERROR:Ap,Z_MEM_ERROR:xp}=td;function Rp(t){this.options=rf({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new uf,this.strm.avail_out=0;let n=up(this.strm,e.windowBits);if(n!==vp)throw new Error(Xu[n]);if(this.header=new yp,pp(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=cf(e.dictionary):"[object ArrayBuffer]"===wp.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=gp(this.strm,e.dictionary),n!==vp)))throw new Error(Xu[n])}function Sp(t,e){const n=new Rp(e);if(n.push(t),n.err)throw n.msg||Xu[n.err];return n.result}Rp.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize,i=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=e===~~e?e:!0===e?bp:mp,"[object ArrayBuffer]"===wp.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),s=dp(n,o),s===Ep&&i&&(s=gp(n,i),s===vp?s=dp(n,o):s===Ap&&(s=Ep));n.avail_in>0&&s===_p&&n.state.wrap>0&&0!==t[n.next_in];)lp(n),s=dp(n,o);switch(s){case kp:case Ap:case Ep:case xp:return this.onEnd(s),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(0===n.avail_out||s===_p))if("string"===this.options.to){let t=lf(n.output,n.next_out),e=n.next_out-t,i=hf(n.output,t);n.next_out=e,n.avail_out=r-e,e&&n.output.set(n.output.subarray(t,t+e),0),this.onData(i)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(s!==vp||0!==a){if(s===_p)return s=fp(this.strm),this.onEnd(s),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},Rp.prototype.onData=function(t){this.chunks.push(t)},Rp.prototype.onEnd=function(t){t===vp&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=sf(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var Cp={Inflate:Rp,inflate:Sp,inflateRaw:function(t,e){return(e=e||{}).raw=!0,Sp(t,e)},ungzip:Sp,constants:td};const{Deflate:Tp,deflate:Ip,deflateRaw:Up,gzip:Np}=Af,{Inflate:Lp,inflate:Pp,inflateRaw:Op,ungzip:Bp}=Cp;var Fp={Deflate:Tp,deflate:Ip,deflateRaw:Up,gzip:Np,Inflate:Lp,inflate:Pp,inflateRaw:Op,ungzip:Bp,constants:td};const zp={CHUNK_LENGTH:1024,PACKET_TIMEOUT:1e4,MAX_LATENCY:2e3,LOOP_INTERVAL:1,TURN_KIND:29999},Dp=ru("nostrtc:NostrTURN");class Mp extends n.EventEmitter{localPeer;remotePeer;connectionId;turn;nostr;config;packetCounter=0;outQueue={};inPacket;loopTimeout;outQueueNotify=()=>{};stopped=!1;constructor(t,e,n,r,i=zp){super(),this.config=i,this.nostr=t,this.connectionId=e,this.localPeer=n,this.remotePeer=r,this.turn=t.subscribeToRelays([{authors:[this.remotePeer.pubkey],kinds:[this.config.TURN_KIND],"#d":["turn-"+this.connectionId]}],(async(t,e)=>{let n=e.content;n=await this.nostr.decrypt(this.remotePeer.pubkey,n,this.localPeer),n=JSON.parse(n),n.packet?await this.onReceivedPacket(n.packet):n.ack&&await this.onReceivedAck(n.ack)}),void 0,void 0,this.remotePeer.turnRelays),this.loop().catch((t=>{Dp.error("Error in turn loop",t)}))}async close(t){this.stopped=!0,this.outQueueNotify(),this.loopTimeout&&clearTimeout(this.loopTimeout);const e=await this.turn;await e.close(),t instanceof Error&&this.emit("error",this.remotePeer,t),this.emit("close",this.remotePeer,String(t))}async write(t){await this.turn;const e=lh.encode(Fp.deflate(t)),n=this.packetCounter++,r=this.config.CHUNK_LENGTH,i=Math.ceil(e.length/r);Dp.trace("Splitting packet",n,"in",i,"chunks");const s={id:n,chunks:new Array(i).fill(void 0),sent:0,ack:0,timestamp:Date.now()};for(let t=0;t<i;t++){const n=e.slice(t*r,(t+1)*r);s.chunks[t]={data:n,ack:!1,lastAttempt:0,sent:!1}}this.outQueue[n]=s,this.consume(),this.outQueueNotify()}async onReceivedAck(t){const e=this.outQueue[t.packetId],n=e.chunks[t.chunkId];n||await this.close(new Error("invalid chunk")),n.ack||(n.ack=!0,e.ack++),this.consume()}async onReceivedPacket(t){const{packetId:e,chunkId:n,nChunks:r,data:i}=t;if(this.inPacket){if(this.inPacket.id!==e)return void this.emit("error",this.remotePeer,new Error("Invalid packet id"));if(this.inPacket.chunks.length!=r)return void this.emit("error",this.remotePeer,new Error("Invalid number of chunks"))}else this.inPacket={id:e,chunks:new Array(r).fill(void 0),sent:0,ack:0,timestamp:Date.now()};const s=this.inPacket;if(s.chunks[n])return void this.emit("error",this.remotePeer,new Error("chunk already received"));s.chunks[n]={data:i,ack:!0,sent:!0,lastAttempt:0},s.ack++,s.sent=r,this.consume();let o=JSON.stringify({ack:{packetId:e,chunkId:n}});o=await this.nostr.encrypt(this.remotePeer.pubkey,o,this.localPeer),await this.nostr.publishToRelays({content:o,tags:[["d","turn-"+this.connectionId],["expiration",String(Math.floor((Date.now()+this.config.PACKET_TIMEOUT)/1e3))]],kind:this.config.TURN_KIND},this.localPeer,this.remotePeer.turnRelays)}consume(){const t=this.inPacket;if(t)if(t.sent===t.ack){const e=t.chunks.map((t=>t.data)).join(""),n=Fp.inflate(lh.decode(e));Dp.trace("Reassembling packet",t.id,"from",t.chunks.length,"chunks"),this.emit("data",this.remotePeer,n),this.inPacket=void 0}else Date.now()-t.timestamp>this.config.PACKET_TIMEOUT&&this.close(new Error("Timeout")).catch((t=>Dp.error("Error closing",t)));for(const t in this.outQueue){const e=this.outQueue[t];e.sent&&e.sent===e.ack?(Dp.trace("Packet",e.id,"fully acked",e.ack,"/",e.sent),delete this.outQueue[t]):Date.now()-e.timestamp>this.config.PACKET_TIMEOUT&&this.close(new Error("Timeout")).catch((t=>Dp.error("Error closing",t)))}}async loop(){try{const t=Object.values(this.outQueue);if(0===t.length&&await new Promise((t=>{this.outQueueNotify=t})),this.stopped)return;const e=t.length>0?t[0]:void 0;if(e)for(let t=0;t<e.chunks.length;t++){const n=e.chunks[t],r=n.lastAttempt;if(Date.now()-r<(this.config.MAX_LATENCY??1e3))continue;if(n.ack)continue;n.lastAttempt=Date.now();let i=JSON.stringify({packet:{packetId:e.id,chunkId:t,nChunks:e.chunks.length,data:n.data}});i=await this.nostr.encrypt(this.remotePeer.pubkey,i,this.localPeer),n.sent||(n.sent=!0,e.sent++),Dp.trace("Sending chunk",e.id,t),await this.nostr.publishToRelays({content:i,tags:[["d","turn-"+this.connectionId],["expiration",String(Math.floor((Date.now()+this.config.PACKET_TIMEOUT)/1e3))]],kind:this.config.TURN_KIND},this.localPeer,this.remotePeer.turnRelays)}}catch(t){Dp.error("Error in turn loop",t)}this.stopped||(this.loopTimeout=setTimeout((()=>{this.loop().catch((t=>{Dp.error("Error in turn loop",t)}))}),this.config.LOOP_INTERVAL))}}const $p=ru("nostrtc:NostrRTC");var Kp;!function(t){t.announce="1",t.offer="3",t.answer="4",t.iceCandidate="5",t.disconnect="7",t.ack="8",t.err="9",t.connect="10"}(Kp||(Kp={}));class qp{pubkey;metadata={};turnRelays;_lastSeen;constructor(t,e,n,r){this.pubkey=t,e&&Object.assign(this.metadata,e),this.turnRelays=n,this._lastSeen=r}set lastSeen(t){this._lastSeen=t}get lastSeen(){return this._lastSeen}}class Hp extends n.EventEmitter{discoveredPeers=new Array;connections=new Map;banlist=[];channelKeyPair;localKeyPair;nostr;metadata;settings;turnSettings;turnRelays;sub;stopped=!1;announceTimeout;gcTimeout;autoconnectTimeout;constructor(t,e,n={},r,i,s=fu,o=zp){super(),this.nostr=e,this.channelKeyPair="string"==typeof t?e.newKeyPair(t):t,this.localKeyPair="string"!=typeof i&&i?i:e.newKeyPair(i),this.metadata=n,this.settings=s,this.turnSettings=o,this.turnRelays=r}setMetadata(t){Object.keys(this.metadata).forEach((t=>delete this.metadata[t])),Object.assign(this.metadata,t)}setTurnRelays(t){this.turnRelays=t}getMetadata(){return this.metadata}getTurnRelays(){return this.turnRelays}getChannelKeyPair(){return this.channelKeyPair}getLocalKeyPair(){return this.localKeyPair}getNostrAdapter(){return this.nostr}async start(){this.sub=await this.subscribeToSignal((async(t,e,n,r)=>{e.announce&&this.onPeerDiscovery(n,r,e.announce).catch(console.error),e.connect&&this.onIncomingPeerConnection(n,e.connect).catch(console.error),e.connectAck&&this.onIncomingPeerAck(n,e.connectAck).catch(console.error),e.candidates&&this.onIceCandidates(n,e.candidates).catch(console.error)})),this.announceLoop().catch(console.error),this.gcLoop().catch(console.error),this.autoconnectLoop().catch(console.error)}async autoconnectLoop(){const t=await this.localKeyPair.getPubKey();for(const e of this.discoveredPeers){const n=e.pubkey;if(t.localeCompare(n)<0&&!this.connections.has(e.pubkey))try{this.connect(e.pubkey).catch(console.error)}catch(t){$p.debug("Failed to autoconnect",t)}}this.autoconnectTimeout=setTimeout((()=>this.autoconnectLoop()),1e3)}async gcLoop(){if(this.stopped)return;const t=Date.now(),e=[];for(let n=0;n<this.discoveredPeers.length;n++){const r=this.discoveredPeers[n];if(t-r.lastSeen>this.settings.PEER_EXPIRATION){this.discoveredPeers.splice(n,1),n--,this.emit("cleanup",r);const t=this.connections.get(r.pubkey);t&&e.push(t.close(new Error("Peer expired")).catch(console.error))}}await Promise.allSettled(e);const n=Array.from(this.connections.keys());for(const t of n){const e=this.connections.get(t);e&&e.getStatus()===gu.disconnected&&this.connections.delete(t)}this.gcTimeout=setTimeout((()=>this.gcLoop()),this.settings.GC_INTERVAL)}async announceLoop(){if(!this.stopped){try{await this.signal({announce:{metadata:this.metadata,turnRelays:this.turnRelays}})}catch(t){console.error("Failed to announce",t)}this.announceTimeout=setTimeout((()=>this.announceLoop()),this.settings.ANNOUNCE_INTERVAL)}}async connect(t){this.unban(t);const e=this.discoveredPeers.find((e=>e.pubkey===t));if(!e)throw new Error("Peer not discovered yet");let n,r=this.connections.get(t);if(r)throw new Error("Peer already connected or connecting");if(({connection:r,description:n}=await yu.connect(e)),e.turnRelays?.length){const t=new Mp(this.nostr,r.getConnectionId(),this.localKeyPair,e,this.turnSettings);t.on("close",(t=>{r.close(new Error("Closed by TURN: "+t)).catch(console.error)})),r.setTURN(t)}r.on("ready",(()=>{this.emit("connected",e)})),r.on("close",((t,n)=>{this.emit("close",e,n)})),r.on("error",((t,n)=>{this.emit("error",e,n)})),r.on("candidates",((t,n)=>{const r=n.map((t=>t.toJSON()));this.signal({candidates:r},e.pubkey).catch(console.error)})),r.on("data",((t,n)=>{this.emit("data",e,n)})),this.connections.set(t,r);const i=r.getConnectionId();this.emit("connecting",e),$p.debug("Attempting to connect to",t+"@"+i,"and local description",n),await this.signal({connect:{connectionId:i,description:n}},t)}async onIceCandidates(t,e){const n=this.discoveredPeers.find((e=>e.pubkey===t));if(!n)throw new Error("Peer not discovered yet");const r=this.connections.get(t);if(!r)throw new Error("Peer connection not found");await r.addRemoteIceCandidates(e.map((t=>new RTCIceCandidate(t)))),this.emit("candidates",n,e)}async onPeerDiscovery(t,e,n){const r=n.metadata,i=n.turnRelays;if(Date.now()-e>this.settings.PEER_EXPIRATION)return;if(this.banlist.includes(t))return;let s=this.discoveredPeers.find((e=>e.pubkey===t));if(s)Object.keys(s.metadata).forEach((t=>delete s.metadata[t])),Object.assign(s.metadata,r),s.lastSeen=e,this.emit("refresh",s);else{const n=new qp(t,r,i,e);this.emit("discover",n),this.discoveredPeers.push(n)}}async onIncomingPeerAck(t,e){const n=e.connectionId,r=e.error,i=e.description;if(!this.discoveredPeers.find((e=>e.pubkey===t)))throw new Error("Peer not discovered yet");let s=this.connections.get(t);if(!s)throw new Error("Peer connection not found");if(s.getStatus()!==gu.connecting)throw new Error("Peer not connecting");if(s.getConnectionId()!==n)throw new Error("Invalid connectionId");$p.debug("Incoming connection ack from",t+"@"+n,"with remote description",i);try{if(r)throw new Error(r);await s.setRemoteDescription(i),$p.info("Connection established to",t+"@"+n)}catch(t){$p.error("Failed to connect",t),s.close(t).catch(console.error)}}async onIncomingPeerConnection(t,e){const n=e.connectionId,r=e.description;$p.debug("Incoming connection from",t+"@"+n,"with  remote description",r);const i=this.discoveredPeers.find((e=>e.pubkey===t));if(!i)throw new Error("Peer not discovered yet");let s,o;try{if(({connection:s,description:o}=await yu.open(i,n,r)),i.turnRelays?.length){const t=new Mp(this.nostr,s.getConnectionId(),this.localKeyPair,i,this.turnSettings);t.on("close",(t=>{s&&s.close(new Error("Closed by TURN: "+t)).catch(console.error)})),s.setTURN(t)}this.connections.set(t,s),s.on("ready",(()=>{s?.setStatus(gu.connected),this.emit("connected",i)})),s.on("close",((t,e)=>{this.emit("close",i,e)})),s.on("error",((t,e)=>{this.emit("error",i,e)})),s.on("candidates",((e,r)=>{$p.debug("Sending candidates to",t+"@"+n,r);const s=r.map((t=>t.toJSON()));this.signal({candidates:s},i.pubkey).catch(console.error)})),s.on("data",((t,e)=>{this.emit("data",i,e)})),$p.debug("Confirm connection to",t+"@"+n,"with local description",o),this.emit("connecting",i),await this.signal({connectAck:{connectionId:n,description:o}},t),$p.info("Connection established to",t+"@"+n)}catch(e){console.error("Failed to connect",e),await this.signal({connectAck:{connectionId:n,error:e?.message||"Error"}},t),s?.close(e).catch(console.error)}}async stop(){this.stopped=!0,this.sub&&await this.sub.close(),this.announceTimeout&&clearTimeout(this.announceTimeout),this.gcTimeout&&clearTimeout(this.gcTimeout),this.autoconnectTimeout&&clearTimeout(this.autoconnectTimeout);for(const t of this.connections.values())try{await t.close("Stopped")}catch(t){console.error("Failed to close connection",t)}this.connections.clear(),this.discoveredPeers.length=0,this.banlist.length=0}unban(t){const e=this.banlist.indexOf(t);-1!==e&&this.banlist.splice(e,1)}ban(t){this.banlist.includes(t)||this.banlist.push(t);let e=this.discoveredPeers.findIndex((e=>e.pubkey===t));-1!==e&&this.discoveredPeers.splice(e,1)}async disconnect(t){this.ban(t);const e=this.connections.get(t);e&&await e.close("Disconnected by user")}getConnection(t){return this.connections.get(t)}getPeerInfo(t){return this.discoveredPeers.find((e=>e.pubkey===t))}listPeers(){return this.discoveredPeers.map((t=>t.pubkey))}async signal(t,e){try{const n=`${e??"@"}@${await this.channelKeyPair.getPubKey()}`,r=await this.nostr.encrypt(e??await this.channelKeyPair.getPubKey(),JSON.stringify(t),this.localKeyPair);await this.nostr.publishToRelays({kind:this.settings.KIND,content:r,tags:[["d",n],["expiration",String(Math.floor((Date.now()+126e4)/1e3))]]},this.localKeyPair)}catch(t){$p.error("Failed to signal",t)}}async subscribeToSignal(t){const e=`${await this.localKeyPair.getPubKey()}@${await this.channelKeyPair.getPubKey()}`,n=`@@${await this.channelKeyPair.getPubKey()}`;return await this.nostr.subscribeToRelays([{kinds:[this.settings.KIND],"#d":[e,n],since:Math.floor(Date.now()/1e3)}],(async(e,r)=>{try{const i=r.pubkey;if(i===await this.localKeyPair.getPubKey())return;const s=String(r.tags.find((t=>"d"===t[0]))?.[1])===n,o=r.content,a=await this.nostr.decrypt(i,o,s?this.channelKeyPair:this.localKeyPair),c=JSON.parse(a),h=Math.floor(r.created_at?1e3*r.created_at:Date.now());if(h<0||isNaN(h))throw new Error("Invalid timestamp");t(e,c,i,h).catch(console.error)}catch(t){$p.error("Invalid event",t)}}))}}const jp=ru("nostrtc");function Vp(){const t=prompt("Enter relay url")?.trim();window.location.hash=window.location.hash.split("@")[0]+"@"+t,window.location.reload()}function Zp(){const[t,e]=(window.location.hash?.substring(1)??"").split("@");window.location.hash="@"+e,window.location.reload()}function Wp(){const t=prompt("Enter channel address")?.trim();t&&(window.location.hash=t,window.location.reload())}nu("app","nostrtc"),window.addEventListener("load",(async function(){const t=document.querySelector("#setrelay");t&&t.addEventListener("click",Vp);const e=document.querySelector("#newchannel");e&&e.addEventListener("click",Zp);const n=document.querySelector("#joinchannel");n&&n.addEventListener("click",Wp);const r=document.querySelector("#channel");let[i,s]=(window.location.hash?.substring(1)??"").split("@");i&&i.match(/^[a-zA-Z0-9]+$/)||(i=""),s&&s.match(/^wss?:\/\/[a-zA-Z0-9.]+$/)||(s="wss://nostr.rblb.it"),i||(i=(await Tl.generate()).privateKey,window.location.hash=i+"@"+s),r&&(r.innerHTML="Channel: "+i+"@"+s),await async function(t,e){let n=document.querySelector("#info");n||(n=document.createElement("div"),n.id="info",document.body.appendChild(n));let r=document.querySelector("#peers");r||(r=document.createElement("div"),r.id="peers",document.body.appendChild(r));const i=await Tl.generate();jp.trace("Logger loaded with ENDPOINT:","","LEVEL:","INFO"),window.location.hash?nu("user",window.location.hash):nu("user",(await i.user()).pubkey),n.innerHTML=`Your pubkey: ${(await i.user()).pubkey}`,nu("channel",t);const s=[e],o=new Wl({explicitRelayUrls:s}),a=new su(o,Ch.fromRelayUrls(s,o)),c=new Hp(t,a,{},s,i.privateKey),h=(t,e,n)=>{const i=t.pubkey;let s,o,a,h,l,u=r.querySelector(`#p${i}`);u?(s=u.querySelector("div:nth-child(1)"),o=u.querySelector("div:nth-child(2)"),a=u.querySelector("div:nth-child(3)"),h=u.querySelector("div:nth-child(4)"),l=u.querySelector("div:nth-child(5)")):(u=document.createElement("div"),u.id="p"+i,r.appendChild(u),s=document.createElement("div"),s.classList.add("pubkey"),o=document.createElement("div"),o.classList.add("lastseen"),a=document.createElement("div"),a.classList.add("status"),h=document.createElement("div"),h.classList.add("candidates"),l=document.createElement("div"),l.classList.add("logs"),u.appendChild(s),u.appendChild(o),u.appendChild(a),u.appendChild(h),u.appendChild(l)),u.classList.add("peer");const d=c.getConnection(t.pubkey);s.innerHTML=i,o.innerHTML=t.lastSeen,a.innerHTML=d?d.getStatus()+":"+d?.getConnectionId():"disconnected",n&&(h.innerHTML=JSON.stringify(n)),l.innerHTML+=e+"<br>"};let l;c.on("discover",(async t=>{h(t,"Discovered peer")})),c.on("refresh",(async t=>{h(t,"Refreshed peer")})),c.on("connected",(async t=>{h(t,"Connected peer");const e=c.getConnection(t.pubkey);e?.on("data",((e,n)=>{console.log("!!! Data received: ",(new TextDecoder).decode(n)),h(t,"!!! Data received: "+(new TextDecoder).decode(n))})),l=setInterval((async()=>{console.log("Sending message to ",t.pubkey);const n=(new TextEncoder).encode("Hello from "+(await i.user()).pubkey+":"+(new Date).toISOString());await(e?.write(n))}),1e3)})),c.on("candidates",(async(t,e)=>{h(t,"Update candidates",e)})),c.on("connecting",(async t=>{h(t,"Connecting peer")})),c.on("error",(async(t,e)=>{h(t,e.toString())})),c.on("close",(async t=>{clearInterval(l),h(t,"Close")})),c.on("cleanup",(async t=>{const e=t.pubkey;let n=r.querySelector(`#p${e}`);n&&n.remove()})),c.start().catch(console.error)}(i,s)}))})()})();
//# sourceMappingURL=bundle.js.map